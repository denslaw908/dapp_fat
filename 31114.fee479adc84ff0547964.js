"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[31114],{978528:(e,t,s)=>{s.d(t,{AbstractFilledAreaPaneView:()=>d});var i=s(650151),r=(s(86441),s(5531),s(660439)),n=s(398290),o=s(276780),a=s(936867);function l(e,t){return Array.from({length:e},((e,s)=>({timePointIndex:s+t})))}function h(e,t,s){let i,r;const n=e.length;for(let o=t;o>=0&&o<n;o+=s){const t=e[o];if(void 0===i&&void 0!==t.plot1Value&&(i=o),void 0===r&&void 0!==t.plot2Value&&(r=o),void 0!==i&&void 0!==r)return o}return null}function u(e){return 0===e.type?`${e.color}`:`${e.color1}:${e.color2}:${e.coordinate1}:${e.coordinate2}`}const c={type:0,color:""};class d{constructor(e,t,s){this._isHlineFill=!1,this._bandAKey=null,this._bandBKey=null,this._colorPlotIndex=null,this._areaRenderer=new o.AreaBackgroundRenderer,this._dataInvalidated=null,this._viewportInvalidated=!1,this._plIndex1=null,this._plIndex2=null,this._items=[],this._colorAreas=new o.CachedMap,this._generateColor=(0,n.generateColorCached)(),this._source=e,this._model=t,this._fillGaps=!!s?.fillgaps,this._fillToIntersection=!!s?.fillToIntersection}update(e){if("global-change"===e.type)return this._dataInvalidated=(0,a.mergeDataInvalidation)(this._dataInvalidated,{}),void(this._viewportInvalidated=!0);if("data-source-change"!==e.type)this._viewportInvalidated=!0;else{e.sourceId===this._source.id()&&(this._dataInvalidated=(0,a.mergeDataInvalidation)(this._dataInvalidated,{firstIndex:e.firstUpdatedTimePointIndex,clearData:e.clearData}))}}renderer(){return this._dataInvalidated?this._updateImplFull(this._dataInvalidated)&&(this._dataInvalidated=null,this._viewportInvalidated=!1):this._viewportInvalidated&&(this._updateImplLight(),this._viewportInvalidated=!1),this._areaRenderer}_minFirstBarIndex(){return-1/0}_priceScale(){return this._source.priceScale()}_firstValue(){return this._source.firstValue()}_plotNames(){return this._source.metaInfo().plots.map((e=>e.id))}_plotIndex1(){return null===this._plIndex1&&(this._plIndex1=this._plotNames().indexOf(this._plotAId())+1),this._plIndex1}_plotIndex2(){return null===this._plIndex2&&(this._plIndex2=this._plotNames().indexOf(this._plotBId())+1),this._plIndex2}_updateImplFull(e){if(this._areaRenderer.setData(null),this._dataInvalidated?.clearData&&(this._items=[]),!this._visible())return!1;if(null===this._priceScale())return!1;if(null===this._firstValue())return!1;const t=this._source.plots().plottableRange(),s=t.size();if(0===s)return!1;const n=this._source.offset(this._plotAId()),o=this._source.offset(this._plotBId()),a=Math.min(n,o),h=Math.max(n,o);let u=e.firstIndex;const c=s+(h-a)+1,d=this._plotIndex1(),p=this._plotIndex2();c!==this._items.length&&(void 0===u||0===this._items.length||u<this._items[0].timePointIndex+a?(u=void 0,this._items=l(c,1e10)):this._items=this._items.concat(l(c-this._items.length,1e10+this._items.length)));const _=this._colorPlotIndex,f=this._transparency(),m=void 0===u?t.fullRangeIterator():t.rangeIterator(u,(0,i.ensureNotNull)(t.lastIndex()));let y=void 0!==u?(0,
r.lowerbound)(this._items,u+a,((e,t)=>e.timePointIndex<t))-a:-a;for(const e of m){const t=e.index+n,s=e.index+o,i=this._items[y+n],r=this._items[y+o];if(i.timePointIndex=t,r.timePointIndex=s,this._isHlineFill||(i.plot1Value=e.value[d]??void 0,r.plot2Value=e.value[p]??void 0),null!==_){const t=y+a-1;if(t>=0&&t<this._items.length){const s=this._items[t];let i;i=0===_.type?{type:0,colorIndexOrRgba:e.value[_.colorIndexOrRgba+1]}:{type:1,colorIndexOrRgba1:void 0===_.colorIndexOrRgba1?void 0:e.value[_.colorIndexOrRgba1+1],colorIndexOrRgba2:void 0===_.colorIndexOrRgba2?void 0:e.value[_.colorIndexOrRgba2+1],value1:void 0===_.valueIndex1?void 0:e.value[_.valueIndex1+1],value2:void 0===_.valueIndex2?void 0:e.value[_.valueIndex2+1]};const r=s.color=this._getColorByPlotValue(i)??void 0;void 0!==r&&(1===r.type?(r.color1=r.color1&&this._generateColor(r.color1,f),r.color2=r.color2&&this._generateColor(r.color2,f)):r.color=this._generateColor(r.color,f))}}y+=1}return this._updateImplLight(),!0}_updateImplLight(){if(!this._visible())return;const e=this._priceScale();if(null===e)return;const t=this._firstValue();if(null===t)return;if(0===this._items.length)return;let s;if(this._isHlineFill){const r=this._source.properties().bands[(0,i.ensureNotNull)(this._bandAKey)],n=this._source.properties().bands[(0,i.ensureNotNull)(this._bandBKey)];s={level1:e.priceToCoordinate(r.value.value(),t),level2:e.priceToCoordinate(n.value.value(),t)}}const n=this._model.timeScale(),a=n.visibleBarsStrictRange();if(null===a)return;const l=e.priceToCoordinateFn(t),d=this._transparency(),p=this._minFirstBarIndex(),_=Math.max(p,a.firstBar()),f=(0,r.lowerbound)(this._items,_,((e,t)=>e.timePointIndex<t));if(f>=this._items.length)return;const m=Math.min(this._items.length-1,(0,r.lowerbound)(this._items,a.lastBar(),((e,t)=>e.timePointIndex<t)));let y,g;this._isHlineFill?(y=p===_?f:Math.max(0,f-1),g=Math.min(this._items.length-1,m+1)):(y=p===_?f:h(this._items,f-1,-1)??f,g=h(this._items,m+1,1)??m);const v=this._colorAreas;v.invalidateCache();let S,b=null,I=null,P=null;const w=this._commonColor();let C;1===w.type?(w.coordinate1=l(w.value1),w.coordinate2=l(w.value2),w.color1=w.color1&&this._generateColor(w.color1,d),w.color2=w.color2&&this._generateColor(w.color2,d)):w.color=this._generateColor(w.color,d);for(let e=y;e<=g;e+=1){const t=this._items[e],i=t.timePointIndex;let r,a;!this._fillGaps&&void 0!==C&&i-C>1&&(b=null),void 0!==s?(r=s.level1,a=s.level2):(r=t.plot1Coordinate=void 0===t.plot1Value?void 0:l(t.plot1Value),a=t.plot2Coordinate=void 0===t.plot2Value?void 0:l(t.plot2Value));const h=t.xCoordinate=n.indexToCoordinate(t.timePointIndex);if(t.color&&1===t.color.type&&(t.color.coordinate1=l(t.color.value1),t.color.coordinate2=l(t.color.value2)),this._fillGaps?void 0!==r||void 0!==a:void 0!==r&&void 0!==a){const s=null!==this._colorPlotIndex?t.color||c:w;if(x=s,
!(null===(V=P)||null===x?V===x:0===V.type&&0===x.type?V.color===x.color:1===V.type&&1===x.type&&V.color1===x.color1&&V.color2===x.color2&&V.coordinate1===x.coordinate1&&V.coordinate2===x.coordinate2)||null===b){if(null!==b&&(void 0!==r&&b.addPoints1Point(h,r),void 0!==a&&b.addPoints2Point(h,a)),e===g)continue;P=s;const t=u(s),i=v.get(t)??new o.AreaBackgroundItemsGroup(s);I=b,b=i.newItem()??new o.AreaBackgroundItem,i.push(b),v.set(t,i)}void 0!==r&&b.addPoints1Point(h,r),void 0!==a&&b.addPoints2Point(h,a)}else this._fillGaps||(P=null,b=null,I=null);C=i,S=t}var V,x;v.delete(u(c));const A={barSpacing:this._model.timeScale().barSpacing(),colorAreas:v};this._areaRenderer.setData(A)}}},35714:(e,t,s)=>{s.d(t,{AreaBackgroundPaneView:()=>n});var i=s(650151),r=s(978528);class n extends r.AbstractFilledAreaPaneView{constructor(e,t){super(e,t)}_plotAId(){return(0,i.ensureDefined)(this._source.metaInfo().area)[0].name}_plotBId(){return(0,i.ensureDefined)(this._source.metaInfo().area)[1].name}_commonColor(){return{type:0,color:this._source.properties().areaBackground.backgroundColor.value()}}_transparency(){return this._source.properties().areaBackground.transparency?.value()??0}_visible(){return this._source.properties().areaBackground.fillBackground.value()}_getColorByPlotValue(e){return this._commonColor()}}},322472:(e,t,s)=>{s.d(t,{StudyBaseWindowView:()=>n});var i=s(880865),r=s(816433);class n extends i.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._study=e,this._model=t,this._valueProvider=this._createValuesProvider(e,t),this._items=this._valueProvider.getItems().map((e=>new i.DataWindowItem(e.id,e.title,"")))}update(e){"hover-change"!==e.type&&(this._invalidated=!0)}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}study(){return this._study}_updateImpl(){this._header=this._study.title(r.TitleDisplayTarget.DataWindow),this._title=this._study.title(r.TitleDisplayTarget.DataWindow,!1);const e=this._valueProvider.getValues(this._currentIndex());for(let t=0;t<e.length;++t){const s=e[t],i=this._items[t];i.setValue(s.value),i.setVisible(s.visible),i.setColor(s.color),i.setTitle(s.title)}}_currentIndex(){const e=this._model.crosshairSource().appliedIndex();return isNaN(e)?null:e}}},490550:(e,t,s)=>{s.d(t,{StudyChartFloatingTooltipView:()=>n});var i=s(536794),r=s(816433);class n{constructor(e,t){this._items=[],this._invalidated=!0,this._study=e,this._model=t}destroy(){}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}update(e){this._invalidated=!0}_updateImpl(){const e=this._study.chartFloatingTooltipValuesProvider(),t=this._model.crosshairSource().appliedIndex(),s=e.getValues(t),n=this._study.titleInParts(r.TitleDisplayTarget.StatusLine),o=n[0];let a="";if(n.length>1){const e=n[1];e.length>0&&(a=e.join(" "))}this._items=s.filter(i.notUndefined).filter((e=>e.visible)).map(((e,t)=>({titleText:0===t?o:"",titleInputs:0===t?a:"",value:e.value,valueColor:e.color})))}}},844859:(e,t,s)=>{s.d(t,{StudyDataWindowView:()=>n})
;var i=s(322472),r=s(504101);class n extends i.StudyBaseWindowView{canShowItems(){const e=this._model.paneForSource(this._study);return!!e?.maximized().value()||this._model.panes().every((e=>!e.maximized().value()))}_createValuesProvider(e,t){return new r.StudyDataWindowValuesProvider(e,t)}}},681240:(e,t,s)=>{s.d(t,{StudyStatusProvider:()=>l});var i=s(444372),r=s(454184),n=s(971417),o=s(261420);const a=i.t(null,void 0,s(224077));class l extends o.StudyStatusProviderBase{sourceStatusText(){const e=this._source;if(e.status().type===r.StudyStatusType.Error){const t=e.metaInfo(),s=(0,n.extractPineId)(t.fullId);if(t.scriptIdPart&&(0,n.isEdgrPineId)(t.scriptIdPart)||s&&(0,n.isEdgrPineId)(s))return a}return super.sourceStatusText()}}},114934:(e,t,s)=>{s.d(t,{buildTreeForStudy:()=>a,buildTurnaround:()=>o,canBuildTurnaround:()=>l});var i=s(650151);function r(e,t){return e.studyId.localeCompare(t.studyId)}function n(e){const t=new Set,s=[];return e.forEach((e=>{t.has(e.studyId)||(t.add(e.studyId),s.push(e))})),s}function o(e,t){let s=t.turnaround,i=[t];for(;i.length>0;){let e=[];const t=[];i.forEach((s=>{const i=n(s.sourceStudies).sort(r);if(i.length>0){e=e.concat(i);const s=i.map((e=>e.turnaround)).join("_");t.push(s)}})),t.length&&(s=t.join("_")+"_"+s),i=e}return e+"_"+s}function a(e){const t=e.model().mainSeries();return{studyId:(0,i.ensureNotNull)(e.sourceId()),turnaround:e.turnaround(),sourceStudies:e.parentSources().filter((e=>e!==t)).map((e=>a(e)))}}function l(e){return null!==e.sourceId()&&e.parentSources().every((e=>l(e)))}},438009:(e,t,s)=>{function i(e){const{name:t,group:s}=e;return t.length>0?`${s?`${s}.`:""}${t}`:void 0}s.d(t,{getStudyInputName:()=>i})},631114:(e,t,s)=>{s.r(t),s.d(t,{Study:()=>bs,studyFormatter:()=>vs});var i=s(650279),r=s(154834),n=s(998034),o=s(715943),a=s(855385),l=s.n(a);var h=s(179658),u=s(650151),c=s(444372),d=s(660439),p=s(735566),_=s(340993),f=s(438009),m=s(242651),y=s(618095),g=s(458724),v=s(479483),S=s(499312);function b(e){const t=new Set;e.metaInfo().historyCalculationMayChange&&t.add(g.DataSourceDangerReason.PineRepainting);for(const s of Object.values(e.inputs()))if((0,v.isExtendedInput)(s)&&"symbol"===s.t){const i=e.resolvedSymbolInfoBySymbol(s.v);"spread"===i?.type&&t.add(g.DataSourceDangerReason.Spread),"CRYPTOCAP"===i?.exchange&&t.add(g.DataSourceDangerReason.CryptoCap)}for(const s of e.parentSources())(0,S.addToSet)(t,b(s));const s=e.ownerSource();return e.isChildStudy()&&s&&(0,S.addToSet)(t,b(s)),t}function I(e){const[t]=b(e);return t??null}var P=s(646853),w=s(657619),C=s(321490),V=s(730936),x=s(707934),A=s(867823),R=s(659923),D=s(44049),M=s(751094),T=s(547465),O=s(534328),F=s(311908),N=s(359035),k=s(470416),B=s(128090),E=s(397535),L=s(132565),H=s(807958),W=s(196302),G=s(584785),U=s(770885),z=s(322472),j=s(437642),$=s(522769),K=s(974145);class q extends z.StudyBaseWindowView{constructor(e,t){super(e,t),this._showStudyValues=t.properties().childs().paneProperties.childs().legendProperties.childs().showStudyValues,this._showStudyValues.subscribe(this,(()=>this.update((0,
j.sourceChangeEvent)(e.id()))));const s=this._study.properties();s.childs().showLegendValues.subscribe(this,(()=>this.update((0,j.sourceChangeEvent)(e.id()))));const i=this._study.metaInfo().plots,r=new Set;i.forEach((t=>{if((0,K.isOhlcPlot)(t)){const i=t.target;if(r.has(i))return;r.add(i),s.childs().ohlcPlots.childs()[i].childs().display.subscribe(this,(()=>this.update((0,j.sourceChangeEvent)(e.id()))))}else(0,K.isPlotSupportDisplay)(t)&&s.childs().styles.childs()[t.id]?.childs().display.subscribe(this,(()=>this.update((0,j.sourceChangeEvent)(e.id()))))}))}areValuesVisible(){return this._showStudyValues.value()}additional(){return null}destroy(){this._showStudyValues.unsubscribeAll(this);const e=this._study.properties();e.childs().showLegendValues.unsubscribeAll(this);const t=this._study.metaInfo().plots,s=new Set;t.forEach((t=>{if((0,K.isOhlcPlot)(t)){const i=t.target;if(s.has(i))return;s.add(i),e.childs().ohlcPlots.childs()[i].childs().display.unsubscribeAll(this)}else(0,K.isPlotSupportDisplay)(t)&&e.childs().styles.childs()[t.id]?.childs().display.unsubscribeAll(this)}))}_createValuesProvider(e,t){return new $.StudyLegendValuesProvider(e,t)}}var J=s(87913),Y=s(197860),Z=s(955722),X=s(259710),Q=s(847774),ee=s(681240),te=s(536794),se=s(816433),ie=s(329879);class re{constructor(e,t,s=!1){this.price=t,this.index=e,this.useMainSeriesForPriceRange=s}}var ne=s(70907);function oe(e,t,s,i){if(e.y1===e.y2)return function(e,t,s){return(0,u.assert)(e.y1===e.y2),(0,ne.doesItemAffectVisibleRange)(e.x1,e.x2,e.extend,t,s)?[new re(t,e.y1,!1),new re(s,e.y2,!1)]:[]}(e,s,i);const r=[];return null!==e.x1&&r.push(new re(e.x1,e.y1,!1)),null!==e.x2&&r.push(new re(e.x2,e.y2,!1)),r}function ae(e,t,s,i){return e.points.filter((e=>e.x>=s&&e.x<=i)).map((e=>new re(e.x,e.y,!1)))}function le(e,t,s,i){return(0,ne.doesItemAffectVisibleRange)(e.left,e.right,e.extend,s,i)?[new re(s,e.top,!1),new re(i,e.bottom,!1)]:[]}var he=s(367221);function ue(e,t,s,i){let r;const n=e.yloc!==he.DwgLabelYloc.Price&&e.yloc!==he.DwgLabelYloc.Auto;if(n){const s=e.yloc===he.DwgLabelYloc.AboveBar?2:3,i=t.valueAt(e.x);null!==i&&(r=i[s])}else r=e.y;return null==r?null:[new re(e.x,r,n)]}function ce(e,t,s,i,r,n){if(!(0,ne.doesItemAffectVisibleRange)(e.firstBarTime,e.lastBarTime,ne.DwgExtend.None,s,i))return[];let o=1/0,a=-1/0;for(const[t,s]of r.tpoBlockSets())if(n===t)for(const t of s.get(e.id)||[])o=Math.min(o,t.rowIndex*e.priceRange),a=Math.max(a,(t.rowIndex+1)*e.priceRange);return Number.isFinite(o)?[new re(s,a,!1),new re(i,o,!1)]:[]}class de{constructor(e,t,s,i,r){this._mapGetter=e,this._study=t,this._bars=t.series().bars(),this._visibilityGetter=s,this._getPoints=i,this._getMargins=r}groupPriceRange(e,t,s){let i=null;const r=this._study.graphics();for(const[n,o]of this._mapGetter(s))if(this._visibilityGetter(n))for(const s of o){const o=this._getPoints(s,this._bars,e,t,r,n);if(null===o)continue;let a=1/0,l=-1/0,h=!1,u=!1,c=!1;for(const s of o){const i=s.index<=t,r=s.index>=e;h=h||i,u=u||r,c=c||i&&r;let n=s.price,o=s.price;if(s.useMainSeriesForPriceRange){
const e=this._bars.valueAt(s.index);if(null===e)continue;const t=e[2];if(null==t)continue;const i=e[3];if(null==i)continue;n=i,o=t}n<a&&(a=n),o>l&&(l=o)}if(!(c||h&&u))continue;const d=new E.PriceRange(a,l);i=null===i?d:i.merge(d)}return i}firstValue(e,t){let s=1/0,i=1/0,r=-1/0,n=1/0,o=1/0,a=1/0;const l=this._study.graphics();for(const[h,u]of this._mapGetter(!1))if(this._visibilityGetter(h))for(const c of u){const u=this._getPoints(c,this._bars,e,t,l,h);if(null!==u)for(const l of u){const h=l.index;h>=e&&h<=t&&h<s?(s=h,i=l.price):h<e&&h>r?(r=h,n=l.price):h>t&&h<o&&(o=h,a=l.price)}}return{firstVisible:s===1/0?null:new re(s,i),leftClosest:r===-1/0?null:new re(r,n),rightClosest:o===1/0?null:new re(o,a)}}groupPixelMargins(e,t,s){if(!this._getMargins)return pe();const i=pe();if(null===this._study.priceScale())return i;if(null===this._study.firstValue())return i;const r=this._study.graphics();for(const[n,o]of this._mapGetter(s))if(this._visibilityGetter(n))for(const s of o){const o=this._getPoints(s,this._bars,e,t,r,n);if(null===o)continue;if(0===o.filter((s=>{const i=s.index;return i>=e&&i<=t})).length)continue;const a=this._getMargins(s,this._bars);i.bottomPixelMargin=Math.max(i.bottomPixelMargin,a.bottomPixelMargin),i.topPixelMargin=Math.max(i.topPixelMargin,a.topPixelMargin)}return i}}const pe=()=>({bottomPixelMargin:0,topPixelMargin:0});function _e(e){const t=(0,u.ensureDefined)(e.properties().childs().graphics).childs();return[new de((()=>(0,d.mapEntriesGenerator)(e.graphics().tpos())),e,(e=>{const s=(0,u.ensureDefined)(t.tpoBlockSets).childs()[e].childs();return s.showLetters.value()||s.showBlocks.value()||(0,u.ensureDefined)(t.tpoVolumeRows).childs()[e].childs().visible.value()}),ce,pe),new de((t=>(0,d.nestedMapGenerator)(e.graphics().dwglabels(),t)),e,(e=>(0,u.ensureDefined)(t.dwglabels).childs()[e].childs().visible.value()),ue,ie.calculateDwgLabelsMargins.bind(null,e)),new de((t=>(0,d.nestedMapGenerator)(e.graphics().dwglines(),t)),e,(e=>(0,u.ensureDefined)(t.dwglines).childs()[e].childs().visible.value()),oe,pe),new de((t=>(0,d.nestedMapGenerator)(e.graphics().dwgpolylines(),t)),e,(e=>(0,u.ensureDefined)(t.dwgpolylines).childs()[e].childs().visible.value()),ae,pe),new de((t=>(0,d.nestedMapGenerator)(e.graphics().dwgboxes(),t)),e,(e=>(0,u.ensureDefined)(t.dwgboxes).childs()[e].childs().visible.value()),le,pe),new de((t=>function*(e,t){const s=e.dwglines(),i=e.dwglinefills(),r=new Map;s.forEach((e=>{if(void 0===t)e.forEach((e=>{e?.forEach((e=>{r.set(e.id,e)}))}));else{const s=e.get(t);s?.forEach((e=>{r.set(e.id,e)}))}}));for(const[e,t]of i){const s=Array.from(t).filter((e=>r.has(e.line1)));s.length&&(yield[e,new Set(s)])}}(e.graphics(),t)),e,(e=>(0,u.ensureDefined)(t.dwglinefills).childs()[e].childs().visible.value()),((t,s,i,r)=>{const n=new Map;for(const[,t]of e.graphics().dwglines())for(const[,e]of t)for(const t of e)n.set(t.id,t);return function(e,t,s,i,r){const n=e.get(t.line1),o=e.get(t.line2);return void 0!==n&&void 0!==o&&((0,ne.doesItemAffectVisibleRange)(n.x1,n.x2,n.extend,i,r)||(0,
ne.doesItemAffectVisibleRange)(o.x1,o.x2,o.extend,i,r))?[new re(i,n.y1,!1),new re(r,n.y2,!1),new re(i,o.y1,!1),new re(r,o.y2,!1)]:[]}(n,t,0,i,r)}),pe)]}function fe(e,t,s){return null===t?e:null===e?t:e.index<t.index?s?t:e:s?e:t}class me{constructor(){this.firstVisible=null,this.leftClosest=null,this.rightClosest=null}improve(e){this.firstVisible=fe(this.firstVisible,e.firstVisible,!0),this.leftClosest=fe(this.leftClosest,e.leftClosest,!0),this.rightClosest=fe(this.rightClosest,e.rightClosest,!1)}bestPrice(){return null!==this.firstVisible?this.firstVisible.price:null!==this.leftClosest?this.leftClosest.price:null!==this.rightClosest?this.rightClosest.price:null}}var ye=s(175203),ge=s(971417),ve=s(79428),Se=s(461820),be=s(958443),Ie=s(288789),Pe=s(114934),we=s(931924),Ce=s(708162),Ve=s(320994);class xe extends Ve.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return null}_drawImpl(e){}_drawBackgroundImpl(e){const{context:t,horizontalPixelRatio:s,bitmapSize:i}=e,r=this._data;for(let e=0;e<r.items.length;++e){const n=r.items[e];if(null==n.color)continue;t.fillStyle=n.color;const o=Math.round(n.left*s)+1,a=Math.round(n.right*s);t.fillRect(o,0,a-o+1,i.height)}}}var Ae=s(723655),Re=s(734189);class De extends Re.StudyForceOverlayPlotView{constructor(e,t,s,i){super(t,s,i),this._items=[],this._invalidated=!0,this._isMarkersEnabled=we.enabled("source_selection_markers"),this._study=e;const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];t.id===this._plotName&&(this._plotIndex=e,(0,u.assert)((0,K.isBgColorerPlot)(t),"Plot '"+this._plotName+"' is not a background colorer!"))}this._colorProvider=(0,Ae.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i)}items(){return this._items}update(e){"hover-change"!==e.type&&(this._invalidated=!0)}renderer(){if(1&~(0,u.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs().display.value())return null;if(!this._scalesReady())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={items:this._items},t=new Ce.CompositeRenderer;return t.append(new xe(e)),t}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&!e.isEmpty()&&null!==t&&!t.isEmpty()}_getTranspValue(){const e=(0,u.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs();let t=0;return e.transparency&&(t=e.transparency.value(),t=(0,te.isNumber)(t)?t:40),t}_updateImpl(){this._items=[],(0,u.assert)(this._scalesReady(),"Scales must be ready!");const e=this._model.timeScale().visibleBarsStrictRange();if(null===e)return;const t=this._getTranspValue();let s=(0,u.ensureDefined)(this._series.nearestIndex(e.firstBar(),G.PlotRowSearchMode.NearestRight)),i=(0,u.ensureDefined)(this._series.nearestIndex(e.lastBar(),G.PlotRowSearchMode.NearestLeft));const r=this._study.offset(this._plotName);r>0?(s-=r,i+=r):(s+=r,i-=r);const n=this._study.getMinFirstBarIndexForPlot(this._plotName);if(n>i)return;s=Math.max(n,s);const o=this._study.data()
;for(const e of o.rangeIterator(s,i)){let s=e.index;const i=e.value;s+=r;const n={timePointIndex:Math.floor(s),left:NaN,center:NaN,right:NaN};let o=(0,te.isNumber)(t)?t:50;o=Math.min(o,100),o=Math.max(o,0);const a=this._colorProvider.getPlotPointStyle(i);void 0!==a.colors[1]&&(n.color=(0,O.generateColor)((0,u.ensureDefined)(a.colors[1]),o)),this._items.push(n)}this._model.timeScale().fillBarBorders(this._items)}}var Me=s(23076),Te=s(375142),Oe=s(982367),Fe=s(975022),Ne=s(326488),ke=s(123003),Be=s(985142),Ee=s(826790),Le=s(569429),He=s(945751),We=s(978705),Ge=s(45233),Ue=s(184375),ze=s(880664),je=s(58850),$e=s(342653);const Ke=new Map;Ke.set("PaneRendererArrowUp",Be.PaneRendererArrowUp),Ke.set("PaneRendererArrowDown",Be.PaneRendererArrowDown),Ke.set("PaneRendererCircleShape",Ee.PaneRendererCircleShape),Ke.set("PaneRendererCrossShape",Le.PaneRendererCrossShape),Ke.set("PaneRendererDiamond",He.PaneRendererDiamond),Ke.set("PaneRendererFlagShape",We.PaneRendererFlagShape),Ke.set("PaneRendererLabelUp",Ge.PaneRendererLabelUp),Ke.set("PaneRendererLabelDown",Ge.PaneRendererLabelDown),Ke.set("PaneRendererSquare",Ue.PaneRendererSquare),Ke.set("PaneRendererTriangleApexUp",ze.PaneRendererTriangleApexUp),Ke.set("PaneRendererTriangleApexDown",ze.PaneRendererTriangleApexDown),Ke.set("PaneRendererXCross",je.PaneRendererXCross);class qe extends $e.StudyPaneViewInplaceUpdatable{constructor(e,t,s,i){super(t,s,i),this._renderer=null,this._shapesRenderer=null,this._selectionRenderer=null,this._isMarkersEnabled=we.enabled("source_selection_markers"),this._study=e;const r=e.metaInfo().plots;for(let e=0;e<r.length;e++)if(r[e].id===this._plotName){this._plotIndex=e;break}this._plotStyleInfo=(0,u.ensureDefined)(e.metaInfo().styles?.[this._plotName]),this._colorProvider=(0,Ae.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i),this._selectionIndexer=new Fe.SelectionIndexes(s.timeScale())}items(){return this._items}renderer(){return this._isPlotVisible()&&this._scalesReady()?(this._makeSureRendererIsValid(),this._renderer):null}_isPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&null!==t&&!e.isEmpty()&&!t.isEmpty()}_updateImplFull(e){if(this._dataInvalidated?.clearData&&(this._items=[],this._renderer=null),!this._scalesReady())return!1;const t=this._model.timeScale(),s=this._priceScale(),i=t.visibleBarsStrictRange();if(null===i||null===s)return!1;const r=this._study.plots().plottableRange(!1);if(0===r.size())return!1;const n=this._study.offset(this._plotName),o=this._study.firstValue(void 0,this.isForceOverlay());if(null===o)return!1;this._updateAdditionalPrices(s,o);const{hiPlot:a,loPlot:l}=this._hiLoPlots(),h=this._preallocateItems(r,((e,t)=>this._createItem(e,t??null,a,l,n)));let c=this._series.nearestIndex(i.firstBar(),G.PlotRowSearchMode.NearestRight),p=this._series.nearestIndex(i.lastBar(),G.PlotRowSearchMode.NearestLeft);if(void 0===c||void 0===p)return!1;n>0?(c-=n,p+=n):(c+=n,p-=n)
;const _=this._study.getMinFirstBarIndexForPlot(this._plotName);if(_>p)return!0;c=Math.max(_,c);const f=this._getTranspValue(),m=this._study.properties().childs().styles.childs()[this._plotName].childs(),y=m.color.value(),g=m.textColor?m.textColor.value():void 0,v=y,S=y,b=void 0===g?void 0:g,I=(0,u.ensureNotNull)(this._plotIndex),P=(0,ke.createEmptyStyle)(),w=h??(0,u.ensureNotNull)(r.firstIndex()),C=r.rangeIterator(w,(0,u.ensureNotNull)(r.lastIndex())+1);let V=(0,d.lowerbound)(this._items,w+n,((e,t)=>e.timePointIndex<t));for(const e of C){const t=e.value,s=t[I+1];if(null==s){V++;continue}const i=this._items[V];if(!isNaN(i.origPrices.price)){if(this._colorProvider.isColorDefined()){i.style={color:v,borderColor:S,textColor:b};const e=this._colorProvider.getPlotPointStyle(t,P);this._fillItemWithPointStyle(i,e,f)}}V++}return this._updateImplLight(),!0}_fillItemWithPointStyle(e,t,s){const i=(0,u.ensureDefined)(e.style);if(void 0!==t.colors[0]){i.color=(0,O.generateColor)((0,u.ensureDefined)(t.colors[0]),s);const e=s>9?s-10:0;i.borderColor=(0,O.generateColor)(i.color,e)}void 0!==t.colors[2]&&(i.textColor=(0,O.generateColor)((0,u.ensureDefined)(t.colors[2]),s))}_updateRenderer(e,t){this._makeSureRendererIsValid();const s=this._model.timeScale(),i={},r=this._getTranspValue(),n=s.barSpacing(),o=this._calculateShapeHeight(n),a=this._study.properties().childs().styles.childs()[this._plotName].childs(),l=a.location.value(),h=this._calculateVerticalOffset(l,o+o/2);i.barSpacing=n,i.items=this._items,i.color=(0,O.generateColor)(a.color.value(),r),i.height=o,i.vertOffset=h,i.visibleItemsRange={startItemIndex:e,endItemIndex:t};const u=a.plottype.value(),c=Te.plotShapesData[u],d=new Ce.CompositeRenderer;c&&(this._shapesRenderer?this._shapesRenderer.setData(i):(this._shapesRenderer=this._createRenderer(c.paneRendererClass,i),d.append(this._shapesRenderer))),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,d.append(new Me.SelectionRenderer(this._selectionData))),this._renderer=d}_createRenderer(e,t){const s=Ke.get(e);return new((0,u.ensureDefined)(s))(t)}_getSeriesVal(e,t){const s=(0,Ne.barFunction)(e),i=this._series.data().valueAt(t);return null===i?null:s(i)}_getTranspValue(){let e=0;const t=this._study.properties().childs();t.transparency&&(e=t.transparency.value(),e=(0,te.isNumber)(e)?e:50);const s=t.styles.childs()[this._plotName].childs();return s.transparency&&(e=s.transparency.value(),e=(0,te.isNumber)(e)?e:50),(0,Oe.clamp)(e,0,100)}_createItem(e,t,s,i,r){const n=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),o={origPrices:{price:NaN},timePointIndex:e+r};if((null===t||0===t)&&n!==U.MarkLocation.Absolute)return o;if(null==t)return o;let a=NaN;switch(n){case U.MarkLocation.AboveBar:{const t=this._getLocationPrice(e,s,r);if(null===t)return o;a=t;break}case U.MarkLocation.BelowBar:{const t=this._getLocationPrice(e,i,r);if(null===t)return o;a=t;break}case U.MarkLocation.Absolute:a=(0,u.ensureNotNull)(t)
;break;case U.MarkLocation.Top:case U.MarkLocation.Bottom:a=0;break;default:throw new Error("Bad value: "+n)}return{y:NaN,origPrices:{price:a},timePointIndex:e+r}}_dependsOnSeriesData(){const e=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();return e===U.MarkLocation.AboveBar||e===U.MarkLocation.BelowBar}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(null==t)return null;const s=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();if(0===t&&s!==U.MarkLocation.Absolute)return null;const i=this._study.offset(this._plotName),{hiPlot:r,loPlot:n}=this._hiLoPlots();switch(s){case U.MarkLocation.AboveBar:return this._getLocationPrice(e.index,r,i);case U.MarkLocation.BelowBar:return this._getLocationPrice(e.index,n,i)}return super._getValueForUpdating(e)}_convertItemsToCoordinates(e,t,s,i){for(let e=s;e<i;e++){const t=this._items[e];t.y=t.origPrices.price}this._model.timeScale().fillBarBorders(this._items);const r=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),n=e.height()*e.topMargin(),o=e.height()*(1-e.bottomMargin()),a=e.isInverted(),l=a?o:n,h=a?n:o,u=e=>{for(let t=s;t<i;t++)isNaN(this._items[t].y)||(this._items[t].y=e)};switch(r){case U.MarkLocation.Top:u(l);break;case U.MarkLocation.Bottom:u(h);break;default:e.pointsArrayToCoordinates(this._items,t,{startItemIndex:s,endItemIndex:i})}}_calculateVerticalOffset(e,t){let s=0;switch(e){case U.MarkLocation.AboveBar:case U.MarkLocation.Bottom:s=-t;break;case U.MarkLocation.BelowBar:case U.MarkLocation.Top:s=t}return(0,u.ensureNotNull)(this._priceScale()).isInverted()&&(s*=-1),s}_calculateShapeHeight(e,t){let s=e;switch(t){case K.PlotSymbolSize.Tiny:s=.3*e;break;case K.PlotSymbolSize.Small:s=.6*e;break;case K.PlotSymbolSize.Normal:s=e;break;case K.PlotSymbolSize.Large:s=1.5*e;break;case K.PlotSymbolSize.Huge:s=2*e}return"number"==typeof t&&t>0&&(s=t),s}_hiLoPlots(){let e,t;let s=null;switch(this._series.properties().childs().style.value()){case 2:s="lineStyle";break;case 14:s="lineWithMarkersStyle";break;case 15:s="steplineStyle";break;case 3:s="areaStyle"}return s?(e=this._series.properties().childs()[s].childs().priceSource.value(),t=e):(e="high",t="low"),{hiPlot:e,loPlot:t}}_getLocationPrice(e,t,s){const i=Math.min(e+s,(0,u.ensureNotNull)(this._series.data().last()).index);return this._getSeriesVal(t,i)}}class Je extends qe{_updateRenderer(e,t){const s=this._study.properties().childs().styles.childs()[this._plotName].childs(),i=this._model.timeScale(),r={},n=this._getTranspValue(),o=i.barSpacing();let a;a=this._plotStyleInfo.size?this._calculateShapeHeight(25,this._plotStyleInfo.size):Math.round(o/2),a=Math.max(a,1);const l=s.location.value(),h=(0,O.generateColor)(s.color.value(),n),u=n>19?n-10:0,c=this._calculateVerticalOffset(l,Math.round(1.5*a));r.barSpacing=o,r.items=this.items(),r.color=h,r.borderColor=(0,O.generateColor)(s.color.value(),u),r.height=a,r.vertOffset=c,r.visibleItemsRange={startItemIndex:e,endItemIndex:t}
;const d=s.plottype.value(),p=Te.plotShapesData[d],_=this._plotStyleInfo.text;if(void 0!==_&&""!==_.trim()){let e=_.replace(/\\n/gm,"\n");e=(0,m.cleanButAmpersand)(e,!0),r.text=e,r.fontSize=12;const t=s.textColor?s.textColor.value():void 0;r.textColor=t?(0,O.generateColor)(t,n):h}if(this._renderer&&this._shapesRenderer&&this._selectionRenderer)this._shapesRenderer.setData(r),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?(this._selectionData.vertOffset=c,this._selectionRenderer.setData(this._selectionData)):this._selectionRenderer.setData(null);else{const e=new Ce.CompositeRenderer;this._shapesRenderer=super._createRenderer(p.paneRendererClass,r),e.append(this._shapesRenderer),this._selectionRenderer=new Me.SelectionRenderer(this._selectionData??void 0),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?this._selectionData.vertOffset=c:this._selectionRenderer.setData(null),e.append(this._selectionRenderer),this._renderer=e}}}var Ye=s(687795),Ze=s.n(Ye),Xe=s(86441),Qe=s(837462),et=s(876172),tt=s(731974),st=s(65840),it=s(960433),rt=s(910282),nt=s(688857);class ot extends et.PaneRendererAbstractShape{constructor(e,t){super(null,t),this._textWidthCache=new it.TextWidthCache,this._fontSizeEnsured=0,this._font="",this._ch="",null!==e&&this.setData(e)}setData(e){super.setData(e),this._fontSizeEnsured=(0,u.ensureDefined)(this._height),this._font=(0,Qe.makeFont)(this._fontSizeEnsured,e.fontFamily||rt.CHART_FONT_FAMILY);const t=e.char.slice(0,40);this._ch=Ze()(t)[0]||" "}hitTest(e){const t=(0,st.interactionTolerance)().series+this._fontSizeEnsured/2;for(const s of this._items){if(new Xe.Point(s.center,s.y+s.vertOffset).subtract(e).length()<=t)return new tt.HitTestResult(tt.HitTarget.Regular)}return null}_drawItemShape(e,t){const s=t.center,i=t.vertOffset>0?1:-1,r=Math.trunc(this._fontSizeEnsured/6),n=t.y+t.vertOffset-i*Math.round(this._fontSizeEnsured/2)+(i>0?r:-this._fontSizeEnsured);let o;o=t.style&&void 0!==t.style.color?t.style.color:this._color;const{context:a,horizontalPixelRatio:l,verticalPixelRatio:h}=e;a.font!==this._font&&(a.font=this._font);const u=this._textWidthCache.measureText(a,this._ch);if(this._fontSizeEnsured<=4/l){a.save();const e=Math.max(1,Math.floor(l));let i=Math.max(1,Math.floor(u*l));i%2!=e%2&&(i+=i>1?-1:1);const r=Math.round(n*h)+(t.vertOffset>=0?0:-i);return a.fillStyle=o,a.fillRect(Math.round(s*l)+(l%2?.5:0)-i/2,r,i,i),void a.restore()}(0,nt.drawScaled)(a,l,h,(()=>{a.fillStyle=o,a.textAlign="center",a.textBaseline="top",a.fillText(this._ch,s,n)}))}_startPath(e,t,s){}_endPath(e){}}class at extends qe{constructor(){super(...arguments),this._charRenderer=new ot(null)}_updateRenderer(e,t){const s=this._getTranspValue(),i=this._model.timeScale().barSpacing();let r;const n=this._study.properties().childs().styles.childs()[this._plotName].childs();r=this._plotStyleInfo.size?this._calculateShapeHeight(50,this._plotStyleInfo.size):Math.round(i);const o=n.location.value(),a=(0,
O.generateColor)(n.color.value(),s),l=this._calculateVerticalOffset(o,r),h={items:this.items(),barSpacing:i,char:(0,u.ensureDefined)(n.char?.value()??this._plotStyleInfo.char),height:r,vertOffset:l,color:a,visibleItemsRange:{startItemIndex:e,endItemIndex:t}},c=this._plotStyleInfo.text;if(void 0!==c&&""!==c.trim()){let e=c.replace(/\\n/gm,"\n");e=(0,m.cleanButAmpersand)(e,!0),h.text=e,h.fontSize=12;const t=n.textColor?n.textColor.value():void 0;h.textColor=t?(0,O.generateColor)(t,s):a}this._charRenderer.setData(h);const d=new Ce.CompositeRenderer;d.append(this._charRenderer),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=l,d.append(new Me.SelectionRenderer(this._selectionData))),this._renderer=d}}var lt=s(724377);class ht{constructor(e,t,s,i,r){this.left=NaN,this.right=NaN,this.height=NaN,this.center=e,this.y=t,this.origHeight=s,this.isUp=i,this.origPrices=r,this.timePointIndex=e,this.style={}}}function ut(e){return Math.round(e/4)}function ct(e){return Math.round(e/2)}class dt extends Ve.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){const t=this._data,s=ct(t.barSpacing),i=Math.round(s/2),r=Math.round(s),n=ut(t.barSpacing),o=t.visibleItemsRange?.startItemIndex??0,a=t.visibleItemsRange?.endItemIndex??t.items.length;if(o>=a)return null;for(const s of t.items.slice(o,a)){if(!s)continue;if(!Number.isFinite(s.center)||!Number.isFinite(s.y))continue;const t=Math.abs(s.height),o=s.isUp?-1:1,a=t+r,l=s.y-o*n,h=l-o*a,u=s.center-i,c=s.center+i;if(u<e.x&&e.x<c&&(s.isUp?l<e.y&&e.y<h:h<e.y&&e.y<l))return new tt.HitTestResult(tt.HitTarget.Regular)}return null}_drawImpl(e){const{horizontalPixelRatio:t,verticalPixelRatio:s,context:i}=e,r=this._data,n=ct(r.barSpacing),o=ut(r.barSpacing),a=n<4,l=Math.max(n/2,1),h=(0,Oe.ceiledEven)(n*t),u=h/2,c=Math.round(n*s);i.lineCap="butt",i.lineWidth=Math.max(1,Math.floor(t));const d=i.lineWidth%2?.5:0,p=r.visibleItemsRange?.startItemIndex??0,_=r.visibleItemsRange?.endItemIndex??r.items.length;if(!(p>=_))for(const e of r.items.slice(p,_)){if(!Number.isFinite(e.center)||!Number.isFinite(e.y))continue;const n=e.isUp?-1:1,p=Math.round(Math.abs(e.height)*s),_=Math.round(e.center*t)+d,f=Math.round((e.y-n*o)*s)+d;i.beginPath(),i.translate(_,f);const m=(e.style&&e.style.color)??(e.isUp?r.colorup:r.colordown);a?(i.moveTo(0,0),i.lineTo(-u,-u*n),i.moveTo(0,0),i.lineTo(u,-u*n),i.moveTo(0,0),i.lineTo(0,-p*n),i.moveTo(-u,-p*n),i.lineTo(u,-p*n),i.lineWidth=l,i.strokeStyle=m,i.stroke()):(i.moveTo(0,0),p<c?(i.lineTo(h,-p*n),i.lineTo(-h,-p*n)):(i.lineTo(h,-c*n),i.lineTo(u,-c*n),i.lineTo(u,-p*n),i.lineTo(-u,-p*n),i.lineTo(-u,-c*n),i.lineTo(-h,-c*n)),i.lineTo(0,0),i.strokeStyle=e.isUp?r.colorBorderUp:r.colorBorderDown,i.stroke(),i.fillStyle=m,i.fill()),i.translate(-_,-f)}}}class pt extends qe{_updateRenderer(e,t){const s=this._study.properties().childs().styles.childs()[this._plotName].childs(),i=(0,Oe.clamp)(this._getTranspValue(),0,100),r=this._model.timeScale().barSpacing(),n=(0,
O.generateColor)(s.colorup.value(),i),o=(0,O.generateColor)(s.colordown.value(),i),a=(0,lt.parseRgba)(n),l=a?100*(1-a[3]):0,h=(0,lt.parseRgba)(o),u=h?100*(1-h[3]):0,c={items:this._items,barSpacing:r,colorup:n,colordown:o,colorBorderUp:(0,O.generateColor)("#000000",l),colorBorderDown:(0,O.generateColor)("#000000",u),minHeight:this._plotStyleInfo.minHeight,visibleItemsRange:{startItemIndex:e,endItemIndex:t}};this._updateItemsHeights(c);const d=new Ce.CompositeRenderer;d.append(new dt(c)),this._model.selection().isSelected(this._study)&&null!==this._selectionData&&d.append(new Me.SelectionRenderer({...this._selectionData,barSpacing:r,withOutline:!1})),this._renderer=d}_fillItemWithPointStyle(e,t,s){const i=(0,u.ensureDefined)(e.style);e.isUp?void 0!==t.colors[5]?i.color=(0,O.generateColor)((0,u.ensureDefined)(t.colors[5]),s):i.color=(0,O.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colorup.value(),s):void 0!==t.colors[6]?i.color=(0,O.generateColor)((0,u.ensureDefined)(t.colors[6]),s):i.color=(0,O.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colordown.value(),s)}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(!t)return null;const s=e.index,i=t>0,{hiPlot:r,loPlot:n}=this._hiLoPlots(),o=this._study.offset(this._plotName),a=Math.min(s+o,(0,u.ensureNotNull)(this._series.data().last()).index);if(i){const e=this._getSeriesVal(n,a);if(null!==e)return e}else{const e=this._getSeriesVal(r,a);if(null!==e)return e}return null}_updateItem(e,t){const s=this._getValueForUpdating(e),i=e.value[this._plotIndex+1]>0;return this._items[t].origPrices.price=s??NaN,this._items[t].isUp=i,t+1}_createItem(e,t,s,i,r){const n={center:NaN,y:NaN,origPrices:{price:NaN,timePointIndex:NaN},origHeight:NaN,timePointIndex:e+r};if(!t)return n;const o=Math.min(e+r,(0,u.ensureNotNull)(this._series.data().last()).index),a=t>0;let l;if(a){const e=this._getSeriesVal(i,o);if(null===e)return n;l=e}else{const e=this._getSeriesVal(s,o);if(null===e)return n;l=e}return new ht(e+r,l,t,a,{price:l,timePointIndex:e+r})}_dependsOnSeriesData(){return!0}_convertItemsToCoordinates(e,t,s,i){this._convertItemsToCoordinatesImpl(e,t,s,i)}_createSelectionDataPoint(e,t,s,i){const r=this._model.timeScale().barSpacing(),n=ut(r),o=function(e){return ct(e)}(r),a=super._createSelectionDataPoint(e,t,s,i),l=this._items[(0,d.lowerbound)(this._items,t,((e,t)=>e.timePointIndex<t))];if(!l)return a;const h=l.isUp?1:-1;return{...a,point:a.point.add((0,Xe.point)(0,h*(n+o)))}}_updateItemsHeights(e){const t=this._study.properties().childs().styles.childs();let s=Math.abs((0,u.ensureDefined)(t[this._plotName].childs().minHeight?.value()??this._plotStyleInfo.minHeight)),i=Math.abs((0,u.ensureDefined)(t[this._plotName].childs().maxHeight?.value()??this._plotStyleInfo.maxHeight));if(s>i){const e=s;s=i,i=e}const r=this._items,n=e.visibleItemsRange?.startItemIndex??0,o=(e.visibleItemsRange?.endItemIndex??r.length)-1;let a=0;for(let e=n;e<=o;e++){const t=r[e],s=Math.abs(t.origHeight);s>a&&(a=s)}
const l=(i-s)/a;for(let e=n;e<=o;e++){const t=r[e],i=Math.abs(t.origHeight);t.height=i*l+s}}}var _t=s(652695);class ft extends Re.StudyForceOverlayPlotView{constructor(e,t,s,i){super(t,s,i),this._bars=[],this._invalidated=!1,this._isMarkersEnabled=we.enabled("source_selection_markers"),this._selectionData=null,this._ohlcPlotIndexes=new Map,this._study=e,this._isMarkersEnabled=we.enabled("source_selection_markers"),this._colorProvider=(0,Ae.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i),this._selectionIndexer=new Fe.SelectionIndexes(s.timeScale());const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];"target"in t&&(t.target===this._plotName&&((0,K.isOhlcOpenPlot)(t)&&this._ohlcPlotIndexes.set(1,e),(0,K.isOhlcHighPlot)(t)&&this._ohlcPlotIndexes.set(2,e),(0,K.isOhlcLowPlot)(t)&&this._ohlcPlotIndexes.set(3,e),(0,K.isOhlcClosePlot)(t)&&this._ohlcPlotIndexes.set(4,e)))}}update(e){"hover-change"!==e.type&&(this._invalidated=!0)}items(){return this._bars}_updateImpl(){this._bars.length=0;const e=this._priceScale();if(this._model.timeScale().isEmpty()||null===e||e.isEmpty())return;const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return;let s=this._series.nearestIndex(t.firstBar(),G.PlotRowSearchMode.NearestRight);const i=this._series.nearestIndex(t.lastBar(),G.PlotRowSearchMode.NearestLeft);if(void 0===s||void 0===i)return;const r=this._study.getMinFirstBarIndexForPlot(this._plotName);if(r>i)return;s=Math.max(r,s);const n=this._study.data(),o=this._study.firstValue(void 0,this.isForceOverlay());if(null===o)return;const a=n.rangeIterator(s,i),l=(0,u.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),h=new Map,c=(e,t)=>{const s=e+"@"+t;if(!h.has(s)){const i=(0,O.generateColor)(e,t);return h.set(s,i),i}return h.get(s)},d=(0,ke.createEmptyStyle)();for(const e of a){let t=e.index;const s=e.value;t=Math.floor(t);let i=!0;const r=new Map;for(let e=1;e<=4;++e){const t=this._ohlcPlotIndexes.get(e);if(void 0===t){i=!1;break}const n=s[t+1];if(null==n){i=!1;break}r.set(e,n)}if(!i)continue;const n=(0,u.ensureDefined)(r.get(1)),o=(0,u.ensureDefined)(r.get(4)),a=(0,u.ensureDefined)(r.get(2)),h=(0,u.ensureDefined)(r.get(3)),p=Math.max(n,a,h,o),_=Math.min(n,a,h,o);let f=(0,u.ensureDefined)(c(l.color.value(),0));const m=this._colorProvider.getPlotPointStyle(s,d);void 0!==m.colors[0]&&(f=(0,u.ensureDefined)(m.colors[0]));const y={open:n,high:p,low:_,close:o,color:f,wickColor:m.colors[4],borderColor:m.colors[3],hollow:null,center:NaN,left:NaN,right:NaN,timePointIndex:Math.round(t)};this._bars.push(y)}if(e.barPricesToCoordinates(this._bars,o),this._model.timeScale().fillBarBorders(this._bars),this._model.selection().isSelected(this._study)){const t=this._selectionIndexer.indexes();this._selectionData={points:[],hittestResult:tt.HitTarget.Regular,bgColors:[],visible:!0,barSpacing:this._model.timeScale().barSpacing()};const s=(0,u.ensureNotNull)(this._model.paneForSource(this._study)).height(),i=(0,u.ensureDefined)(this._ohlcPlotIndexes.get(4))
;for(let r=0;r<t.length;r++){const n=t[r],a=this._study.data().valueAt(n);if(null===a)continue;const l=a[i+1];if(null==l)continue;const h=this._model.timeScale().indexToCoordinate(Math.floor(n)),u=e.priceToCoordinate(l,o);this._selectionData.points.push({point:new Xe.Point(h,u)}),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(u/s))}}else this._selectionIndexer.clear()}_isOHLCPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}}class mt extends ft{renderer(){if(!this._isOHLCPlotVisible())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,dontDrawOpen:this._series.properties().childs().barStyle.childs().dontDrawOpen.value(),thinBars:this._series.properties().childs().barStyle.childs().thinBars.value()},t=new Ce.CompositeRenderer;return t.append(new _t.PaneRendererBars(e)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&t.append(new Me.SelectionRenderer(this._selectionData)),t}}var yt=s(149836);class gt extends ft{renderer(){if(!this._isOHLCPlotVisible())return null;const e=this._priceScale();if(!e||e.isEmpty())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const t=(0,u.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),s=this._model.timeScale().barSpacing(),i={bars:this._bars,barSpacing:s,wickVisible:t.drawWick.value(),bodyVisible:!0,borderVisible:t.drawBorder.value(),barWidth:(0,st.optimalBarWidth)(s),borderColor:t.borderColor.value(),wickColor:t.wickColor.value(),isPriceScaleInverted:e.isInverted()},r=new Ce.CompositeRenderer;return r.append(new yt.PaneRendererCandles(i)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&r.append(new Me.SelectionRenderer(this._selectionData)),r}}var vt=s(542301),St=s(12384),bt=s(121181),It=s(257145);class Pt extends bt.HorizontalLinePaneView{constructor(e,t){super(),this._lineRendererData.linestyle=It.LINESTYLE_DOTTED,this._study=e,this._plotName=t}_updateImpl(){this._lineRendererData.visible=!1;const e=this._study.properties().childs().styles.childs()[this._plotName].childs();if(!e.trackPrice.value()||!this._study.isPlotVisibleAt(this._plotName,1))return;const t=this._study.lastValueData(this._plotName,!0);t.noData||(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=t.color,this._lineRendererData.linewidth=e.linewidth.value())}}var wt=s(35714),Ct=s(762003),Vt=s(978528);const xt={type:0,color:"transparent"};class At extends Vt.AbstractFilledAreaPaneView{constructor(e,t,s,i){super(e,t,s),this._palettesInfo={},this._gradientPropsStateCache=null,this._rgbaFromInteger=(0,Ct.rgbaFromIntegerCached)();const r=this._source.metaInfo();this._isRGB=Boolean(r.isRGB),this._isHlineFill="hline_hline"===s.type,(0,u.assert)(this._isHlineFill||"plot_plot"===s.type,"Wrong filledArea type: "+s.type),this._isHlineFill&&this._initBandIndexes(s.objAId,s.objBId),this._fillMetaInfo=s,this._fillStyleProps=i,
this._gradientFillType=i.hasChild("fillType")&&"gradient"===i.childs().fillType?.value(),this._gradientStaticState={color1:s.topColor,color2:s.bottomColor,value1:s.topValue,value2:s.bottomValue},this._hasAllGradientRequiredProps=this._gradientFillType&&(void 0!==this._gradientStaticState.color1||i.hasChild("topColor")||void 0!==this._gradientStaticState.color2||i.hasChild("bottomColor"))&&(void 0!==this._gradientStaticState.value1||i.hasChild("topValue"))&&(void 0!==this._gradientStaticState.value2||i.hasChild("bottomValue"));const n=()=>this._colorPlotIndex=this._colorPlotIndex??{type:1};for(let t=0;t<r.plots.length;++t){const i=r.plots[t];if(((0,K.isColorerPlot)(i)||(0,K.isDataPlot)(i))&&i.target===s.id){if((0,K.isColorerPlot)(i)){let s;void 0!==i.targetField?"topColor"===i.targetField?(n().colorIndexOrRgba1=t,s="color1"):"bottomColor"===i.targetField&&(n().colorIndexOrRgba2=t,s="color2"):this._colorPlotIndex={type:0,colorIndexOrRgba:t},(0,K.isPaletteColorerPlot)(i)&&(this._palettesInfo[s??"color"]={map:(0,u.ensureDefined)((0,u.ensureDefined)(r.palettes)[i.palette]?.valToIndex),values:e.properties().palettes[i.palette].colors})}else(0,K.isDataPlot)(i)&&("topValue"===i.targetField?n().valueIndex1=t:"bottomValue"===i.targetField&&(n().valueIndex2=t));if(0===this._colorPlotIndex?.type)break}}}update(e){super.update(e),this._gradientPropsStateCache=null}isForceOverlay(){return!!this._source.metaInfo().isPlotForceOverlay(this._plotAId())}_firstValue(){const e=this.isForceOverlay();return this._source.firstValue(void 0,e)}_minFirstBarIndex(){return this._source.getMinFirstBarIndexForPlot(this._fillMetaInfo.id)}_getColorByPlotValue(e){if(0===e.type){let t;if(null==e.colorIndexOrRgba)return null;if(this._isRGB)t=this._rgbaFromInteger(e.colorIndexOrRgba);else{const s=(0,u.ensureDefined)(this._palettesInfo.color),i=(0,u.ensureDefined)(s.map[e.colorIndexOrRgba]);t=s.values[i]?.childs().color.value()}return{type:0,color:t}}const t=this._gradientColorPropsState();let s,i;if(this._isRGB)null!=e.colorIndexOrRgba1&&(s=this._rgbaFromInteger(e.colorIndexOrRgba1)),null!=e.colorIndexOrRgba2&&(i=this._rgbaFromInteger(e.colorIndexOrRgba2));else{if(null!=e.colorIndexOrRgba1){const t=(0,u.ensureDefined)(this._palettesInfo.color1);s=t.values[(0,u.ensureDefined)(t.map[e.colorIndexOrRgba1])].childs().color.value()}if(null!=e.colorIndexOrRgba2){const t=(0,u.ensureDefined)(this._palettesInfo.color2);i=t.values[(0,u.ensureDefined)(t.map[e.colorIndexOrRgba2])].childs().color.value()}}const r=e.value1??t.value1,n=e.value2??t.value2;return s=s??t.color1,i=i??t.color2,void 0===r||void 0===n||void 0===s&&void 0===i?null:{type:1,color1:s,color2:i,value1:r,value2:n,coordinate1:NaN,coordinate2:NaN}}_plotAId(){return this._fillMetaInfo.objAId}_plotBId(){return this._fillMetaInfo.objBId}_commonColor(){const e=this._fillStyleProps.childs();if(this._gradientFillType){if(!this._hasAllGradientRequiredProps)return xt;const e=this._gradientColorPropsState();return{type:1,color1:e.color1,color2:e.color2,value1:e.value1,value2:e.value2,coordinate1:NaN,
coordinate2:NaN}}return{type:0,color:e.color.value()}}_transparency(){return this._fillStyleProps.childs().transparency?.value()??0}_visible(){return this._fillStyleProps.childs().visible.value()}_priceScale(){return this.isForceOverlay()?this._model.mainSeries().priceScale():this._source.priceScale()}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;const s=this._source.metaInfo().bands;if(void 0!==s)for(let i=0;i<s.length;++i){const r=s[i];null!==this._bandAKey||r.id!==e?null===this._bandBKey&&r.id===t&&(this._bandBKey=i):this._bandAKey=i}}_gradientColorPropsState(){if(null===this._gradientPropsStateCache){const e=this._fillStyleProps.state();this._gradientPropsStateCache={color1:this._gradientStaticState.color1??e.topColor,color2:this._gradientStaticState.color2??e.bottomColor,value1:this._gradientStaticState.value1??e.topValue,value2:this._gradientStaticState.value2??e.bottomValue}}return this._gradientPropsStateCache}}var Rt=s(844859),Dt=s(490550),Mt=s(654397);class Tt{constructor(e,t){this._invalidated=!0,this._lineRenderer=new Mt.HorizontalLineRenderer,this._source=t,this._points=[new Xe.Point(-1,-1)],this._invalidated=!0,this._properties=e}update(e){"hover-change"!==e.type&&(this._invalidated=!0)}renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={y:this._points[0].y,color:this._properties.childs().color.value(),linewidth:this._properties.childs().linewidth.value(),linestyle:this._properties.childs().linestyle.value()};return this._lineRenderer.setData(e),this._lineRenderer}_updateImpl(){const e=this._source.priceScale();if(!e||e.isEmpty())return void(this._points[0]=new Xe.Point(-1,-1));const t=this._properties.childs().value.value(),s=this._source.firstValue(),i=(0,te.isNumber)(t)&&null!==s?e.priceToCoordinate(t,s):NaN;this._points[0]=new Xe.Point(-1,i)}}var Ot=s(820807);class Ft extends Ot.MediaCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._data=null}setData(e=null){this._data=e}hitTest(){return null}_drawImpl(e){if(null===this._data||0===this._data.points.length)return;const t=e.context,s=e.mediaSize.width;if(this._data.gradient){const e=t.createLinearGradient(0,this._data.coordinate1,0,this._data.coordinate2);e.addColorStop(0,this._data.backColor1??"transparent"),e.addColorStop(1,this._data.backColor2??"transparent"),t.fillStyle=e}else t.fillStyle=this._data.backcolor;const i=Math.min(this._data.points[0],this._data.points[1]),r=Math.max(this._data.points[0],this._data.points[1]);t.fillRect(0,i,s,r-i)}}class Nt{constructor(e){this._bandBgRenderer=new Ft,this._invalidated=!0,this._source=e}update(e){"hover-change"!==e.type&&(this._invalidated=!0)}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){this._bandBgRenderer.setData(null);const e=this._source.properties().childs(),t=e.bands;if(t.childCount()<2)return;const s=e.bandsBackground;if(!s?.childs().fillBackground.value())return;const i=t[0].childs(),r=t[1].childs(),n=this._source.priceScale(),o=this._source.firstValue()
;if(!n||n.isEmpty()||null===o)return;const a=[n.priceToCoordinate(i.value.value(),o),n.priceToCoordinate(r.value.value(),o)],l=(0,u.ensureDefined)(e.bandsBackground).childs(),h=(0,Oe.clamp)(l.transparency?.value()??0,0,100);this._bandBgRenderer.setData({gradient:!1,points:a,backcolor:(0,O.generateColor)(l.backgroundColor.value(),h)})}}class kt{constructor(e,t,s){this._bandBgRenderer=new Ft,this._bandAKey=null,this._bandBKey=null,this._invalidated=!0,this._source=e,(0,u.assert)("hline_hline"===t.type,"Wrong filledArea type: "+t.type),this._initBandIndexes(t.objAId,t.objBId),this._fillStyleProps=s,this._bandBgRenderer=new Ft,this._gradientFillType=s.hasChild("fillType")&&"gradient"===s.childs().fillType?.value(),this._gradientStaticState={color1:t.topColor,color2:t.bottomColor,value1:t.topValue,value2:t.bottomValue}}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){if(this._bandBgRenderer.setData(null),!this._fillStyleProps.childs().visible.value())return;if(null===this._bandAKey||null===this._bandBKey)return;const e=(0,u.ensureDefined)(this._source.properties().childs().bands),t=e.childs()[this._bandAKey].childs(),s=e.childs()[this._bandBKey].childs(),i=this._source.priceScale(),r=this._source.firstValue();if(!i||i.isEmpty()||null===r)return;const n=[i.priceToCoordinate(t.value.value(),r),i.priceToCoordinate(s.value.value(),r)],o=(0,Oe.clamp)(this._fillStyleProps.childs().transparency?.value()??0,0,100);let a;const l=this._fillStyleProps.childs();if(this._gradientFillType){const e=this._gradientStaticState,t=l,s=e.value1??t.topValue?.value(),h=e.value2??t.bottomValue?.value();if(void 0===s||void 0===h)return;const u=e.color1??t.topColor?.value(),c=e.color2??t.bottomColor?.value();if(void 0===u&&void 0===c)return;a={gradient:!0,points:n,backColor1:u&&(0,O.generateColor)(u,o),backColor2:c&&(0,O.generateColor)(c,o),coordinate1:i.priceToCoordinate(s,r),coordinate2:i.priceToCoordinate(h,r)}}else a={gradient:!1,points:n,backcolor:(0,O.generateColor)(l.color.value(),o)};this._bandBgRenderer.setData(a)}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;(0,u.ensureDefined)(this._source.metaInfo().bands).forEach(((s,i)=>{null===this._bandAKey&&s.id===e&&(this._bandAKey=i),null===this._bandBKey&&s.id===t&&(this._bandBKey=i)}))}}var Bt=s(454184),Et=s(816541),Lt=s(239949),Ht=s(820028),Wt=s(68777),Gt=s(388741),Ut=s(756163),zt=s(492380),jt=s(514294),$t=s(522109);class Kt extends $t.AbstractBarColorer{constructor(e,t){super(),this._rgbaFromInteger=(0,Ct.rgbaFromIntegerCached)(),this._study=e,this._plotIndex=t}applyBarStyle(e,t,s,i){if(t)return s;const r=this._study.properties().childs();if(!r.visible.value())return s;const n=this._study.metaInfo(),o=this._study.data();if(!o||0===o.size())return s;const a=n.plots[this._plotIndex],l=this._getOffset();if(this._study.getMinFirstBarIndexForPlot(a.id)>e+l)return s;if(0===r.styles.childs()[a.id].childs().display.value())return s;const h=o.valueAt(e-l);if(null===h)return s
;let c=h[this._plotIndex+1];if(null==c)return s;if(c=Math.round(c),n.isRGB)s.barColor=this._rgbaFromInteger(c),s.upColor=s.barColor,s.downColor=s.barColor;else{const e=n.plots[this._plotIndex];if("palette"in e){const t=e.palette,i=r.palettes.childs()[t],o=(0,u.ensureDefined)(n.palettes?.[t]),a=o.valToIndex?(0,u.ensureDefined)(o.valToIndex[c]):c,l=i.childs().colors.childs()[a].childs().color.value();s.barColor=l,s.upColor=l,s.downColor=l}}return s}firstColoredBar(e){let t=e;for(const s of this._backColorers)t=Math.min(t,s.firstColoredBar(e)??1/0);const s=this._getOffset();t=Math.min(t,e+s);const i=this._getBars().firstIndex(),r=Math.max(t,i??-1/0),n=this._study.metaInfo().plots[this._plotIndex];return Math.max(this._study.getMinFirstBarIndexForPlot(n.id),r)}_getBars(){return this._study.series().bars()}_getOffset(){const e=this._study.metaInfo().plots[this._plotIndex];return this._study.offset(e.id)}}var qt=s(251954),Jt=s(75618),Yt=s(89831),Zt=s(587482);class Xt extends vt.PanePriceAxisView{constructor(e,t,s,i){super(e,t,s),this._dataSource=t,this._isForceOverlay=t.metaInfo().isPlotForceOverlay(i)}_position(){const e=this._isForceOverlay?this._chartModel.mainPane():this._chartModel.paneForSource(this._dataSource);if(null===e)return null;const t=this._isForceOverlay?this._chartModel.mainSeries().priceScale():this._dataSource.priceScale();if(null===t)return null;let s=e.priceScalePosition(t);return"overlay"===s&&(s=e.priceScalePosition(e.defaultPriceScale())),"overlay"===s?null:s}}var Qt=s(951827),es=s(881727),ts=s(644036),ss=s(912614);const is=(0,p.getLogger)("Chart.Study"),rs=c.t(null,void 0,s(314285));const ns={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!1,skipFakeInputs:!1,skipBooleanInputs:!1,asObject:!0,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1},os={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!0,skipFakeInputs:!1,skipBooleanInputs:!1,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1,fakeInputsForDisplay:!1,doNotSkipHiddenWithMigrate:!1,onlyAtomValues:!0,patchSosInputs:!1},as=we.enabled("study_symbol_ticker_description"),ls=we.enabled("hide_main_series_symbol_from_indicator_legend"),hs=we.enabled("datasource_copypaste"),us=we.enabled("hide_unresolved_symbols_in_legend");function cs(e,t){const s=e.plots[t];if(!s||!(0,K.isOhlcPlot)(s))return!1;const i=s.target,r=e.defaults.styles&&e.defaults.styles[i],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[i],o=e.ohlcPlots&&e.ohlcPlots[i];return r&&(0,K.isOhlcPlotStyleBars)(r)||n&&(0,K.isOhlcPlotStyleBars)(n)||!!o&&(0,K.isOhlcPlotStyleBars)(o)}function ds(e,t){const s=e.plots[t];if(!s||!(0,K.isOhlcPlot)(s))return!1
;const i=s.target,r=e.defaults.styles&&e.defaults.styles[i],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[i],o=e.ohlcPlots&&e.ohlcPlots[i];return r&&(0,K.isOhlcPlotStyleCandles)(r)||n&&(0,K.isOhlcPlotStyleCandles)(n)||!!o&&(0,K.isOhlcPlotStyleCandles)(o)}function ps(e,t){(0,u.assert)(void 0!==e,"zOrder must be defined"),(0,u.assert)(!t.has(e),"zOrder must be unique")}function _s(e){if(!e.metaInfo)return;const t=e.metaInfo.scriptIdPart;if(!t)return;const s=(i=l()(t),btoa(String.fromCharCode.apply(null,new Uint8Array(i))));var i;const r=e.metaInfo;r.id=(r.id||"").replace(t,s),r.fullId=(r.fullId||"").replace(t,s),r.name=(r.name||"").replace(t,s),r.shortId=(r.shortId||"").replace(t,s),r.scriptIdPart=(r.scriptIdPart||"").replace(t,s),e.state&&(e.state.id=(e.state.id||"").replace(t,s),e.state.name=(e.state.name||"").replace(t,s),e.state.scriptIdPart=(e.state.scriptIdPart||"").replace(t,s))}function fs(e,t){return e.plots.some((e=>((0,K.isColorerPlot)(e)||(0,K.isDataPlot)(e))&&e.target===t))}function ms(e,t,s){let i=0,r=0;return e.inputs.filter((e=>"source"===e.type)).forEach((e=>{(0,v.getInputValue)(s[e.id]).includes("$")&&i++,(0,v.getInputValue)(t[e.id]).includes("$")&&r++})),Math.sign(r)-Math.sign(i)}function ys(e){const t=(0,Wt.combine)((e=>e.map((e=>ys(e.parentSourcesVW().weakReference())))),e);return(0,Wt.accumulate)(((e,t)=>Array.from(new Set(t.concat(e.flat(20))))),t.ownership(),e).ownership()}function gs(e){return"inherit"===e.type&&(e.type="price"),e}function vs(e,t,s,i){if(null!==t)switch(e.type){case"inherit":case"price":return new Yt.PriceFormatter({priceScale:t});case"volume":return(0,Qt.getVolumeFormatter)(Math.log10(t));case"percent":return(0,Qt.getPercentageFormatter)(Math.log10(t))}if("inherit"===e.type)return null;const r=(0,te.isNumber)(e.precision)?Math.pow(10,e.precision):void 0;switch(e.type){case"price":return new Yt.PriceFormatter({priceScale:r});case"volume":{let t=e.precision;return void 0===t&&(t=s&&(0,te.isNumber)(s.volume_precision)?s.volume_precision:0),(0,Qt.getVolumeFormatter)(t)}case"percent":return(0,Qt.getPercentageFormatter)(void 0===r?void 0:Math.log10(r));default:return is.logWarn(`Unsupported format type: ${e.type}`),null}}const Ss=new Set(["first_visible_bar_time","last_visible_bar_time","subscribeRealtime"]);class bs extends k.PriceDataSource{constructor(e,t,s,i,r,n,o){super(e),this._onStart=new T.Delegate,this._restarting=!1,this._paneViews=[],this._forceOverlaysPaneViews=[],this._legendView=null,this._floatingTooltipView=null,this._priceAxisViews=[],this._forceOverlayPriceAxisViews=[],this._priceAxisViewsBase=[],this._resolvedSymbols={},this._resolvedSymbolsByInput={},this._priceLinesAxisViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[],this._ownFirstValue=null,this._formatter=null,this._defaultFormatter=null,this._dataUpdated=new T.Delegate,this._currencySourceSymbolInputProperty=null,this._pineSourceCodeModel=null,this._onHibernationStateChange=new T.Delegate,this._symbolsResolved=new T.Delegate,this._statusChanged=new T.Delegate,
this._inputsAnchorsPaneView=null,this._inputsLinesPaneView=null,this._inputsTimeAxisPaneViews=[],this._inputsPriceAxisPaneViews=[],this._sources=new M.WatchedObject([],d.compareTwoCollectionsByIds),this._status=new Ht.WatchedValue({type:Bt.StudyStatusType.Undefined}),this._compileActiveStatus=new M.WatchedObject(null),this._compileErrorStatus=new M.WatchedObject(null),this._wasCompletedBefore=!1,this._studyId=null,this._isSubscribedToSessionId=!1,this._titleStrCache={},this._titleInPartsCache={},this._inputsInPartsCache={},this._children=[],this._graphicsPriceAxisViews=[],this._serverPlotOffsets=new M.WatchedObject({}),this._ongoingDataUpdate=Promise.resolve(),this._studyModified=!1,this._tagsChanged=new T.Delegate,this._turnaround="st0",this._pendingResolveSymbols=new Map,this._onIsActualIntervalChange=new T.Delegate,this._childStudyByRebind=new T.Delegate,this._lastNonEmptyPlotRowCache={},this._startMovingPoint=null,this._processHibernateBound=this.processHibernate.bind(this,1),this._maxOffset=new Ht.WatchedValue(0),this._currencySourceSymbolInfo=null,this._graphicsPriceRangeGroups=null,this._graphicsViewsReady=!1,this._visibleTimeRangeInputs=null,this._turnaroundCounter=0,this._deferredPinePatchProps=!1,this._propertiesPatched=Promise.resolve(),this._abortPatchPropsController=new AbortController,this._aboutToBeDestroyed=new T.Delegate,this._definitionsViewModel=null,this._plotFormatters=new Map,this._showPineVersionInStatusLine=new Ht.WatchedValue(!1).spawn(),this._onParentSourcesChanges=new T.Delegate,this._statusChangesSubscriber={},this._calculationTime=new Ht.WatchedValue(0),this._stateForAlertCache=null,this._idForAlertCache=null,this._chartApi=e.chartApi(),this._properties=t,this._originalMetaInfo=r,this._metaInfo=new Ht.WatchedValue(i),this._studyName=(0,Wt.combine)((e=>e.useVersionFromMetaInfo?(0,H.getStudyIdWithVersion)(e):this._getStudyIdWithLatestVersion()),this._metaInfo.weakReference()),this._hideMatches=i.inputs.filter((e=>e.hideWhenPlotsHidden)).map((e=>({id:e.id,plotIds:e.hideWhenPlotsHidden||[]}))),this._series=this._model.mainSeries(),this._series.onIntervalChanged().subscribe(this,this._calcIsActualInterval),this._series.alertCreationAvailable().subscribe(this._updateAlertCreationAvailable.bind(this)),this._showStudyArgumentsProperty=(0,Ie.combineProperty)(((e,t)=>e&&t),e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments.weakReference(),this._properties.childs().showLegendInputs.weakReference()),e.collapsed().subscribe(this._processHibernateBound),this._sources.setValue(s),H.StudyMetaInfo.setChildStudyMetaInfoPropertiesSourceId(i,s[0]?.id(),t),s.forEach((e=>{e.setChild(this)})),[this._series,...s].forEach((e=>{e.currencyChanged().subscribe(this,this._onSourceCurrencyChanged),e.unitChanged().subscribe(this,this._onSourceUnitChanged),e.priceRangeReadyChanged().subscribe(this,this._onSourcePriceRangeReadyChanged),e.formatterChanged().subscribe(this,this._onSourceFormatterChanged),e.priceStepChanged().subscribe(this,this._onSourcePriceStepChanged)})),
as&&this._model.mainSeries().properties().childs().statusViewStyle.childs().symbolTextSource.subscribe(this,(()=>{this.invalidateTitleCache(!0)}));const a=this._properties.childs();for(const e of H.StudyMetaInfo.getSourceInputIds(i))a.inputs.childs()[e]?.subscribe(this,this._onSourceInputChanged);this._plotOffsets=(0,Wt.combine)(((e,t,s,i)=>(i.plots??[]).reduce(((i,r)=>{const n=r.id,o=(e[n]??0)+(s?.childs()[n]?.childs().val.value()??0)+(t?.childs().val.value()??0);return i[n]=o,i}),{})),this._serverPlotOffsets.weakReference(),(0,Ie.createWVFromGetterAndSubscription)((()=>this.properties().childs().offset),this.properties().childs().offset??new T.Delegate).ownership(),(0,Ie.createWVFromGetterAndSubscription)((()=>this.properties().childs().offsets),this.properties().childs().offsets??new T.Delegate).ownership(),this._metaInfo.weakReference()),this._properties.subscribe(this,this._onPropertiesChanged),a.visible.subscribe(this,this._visibleChanged),a.visible.subscribe(this,(()=>this.processHibernate())),a.intervalsVisibilities.subscribe(this,this._calcIsActualInterval),a.inputs.subscribe(this,this._updateMaxOffsetValue),void 0!==a.offsets&&a.offsets.subscribe(this,this._updateMaxOffsetValue),void 0!==a.offset&&a.offset.subscribe(this,this._updateMaxOffsetValue),J.hideAllIndicators().subscribe(this,this._visibleChanged);for(let e=0;e<i.plots.length;e++){const t=i.plots[e],s=t.id,r=a.styles.childs()[s],n=(0,K.isBarColorerPlot)(t);r?.childs().display.subscribe(this,(()=>{this.processHibernate(),this.invalidateTitleCache(),n&&this._series.invalidateBarColorerCache()}))}for(const e of Object.keys(i.graphics))for(const t of Object.keys(i.graphics[e])){const s=a.graphics.childs()[e]?.childs()[t];s&&s.childs().visible&&(0,u.ensureDefined)(s.childs().visible).subscribe(this,(()=>this.processHibernate()))}this._isActualInterval=(0,Et.isActualInterval)(this._series.intervalObj().value(),a.intervalsVisibilities),this._initializeStudyInputsPaneViews(),this._handler=e=>this._onData(e),this._valuesProvider=new Jt.StudyValuesProvider(this,e),this._graphicsPriceRangeGroups=_e(this),this._graphics=new W.LiveStudyGraphics(i.graphics),this._signlePerformanceValue=(0,Ie.createWVFromGetterAndSubscriptions)((()=>Array.from((0,u.ensureDefined)(this._graphics.performance().get("performance")))[0]??null),[(0,u.ensureDefined)(this._graphics.observablePerformance().get("performance")).changed(),(0,u.ensureDefined)(this._graphics.observablePerformance().get("performance")).cleared()]),this._chartApi=e.chartApi(),this._invalidateLastNonEmptyPlotRowCache(),this._data=new L.PlotList((0,Zt.studyPlotFunctionMap)(i),Zt.studyEmptyPlotValuePredicate),this._createViews(),this._recreatePriceFormattingDependencies(this._series.symbolInfo()),a.precision.subscribe(this,this._onFormatterPropsChanged),this._metaInfo.subscribe((()=>this._onFormatterPropsChanged())),this._showStudyArgumentsProperty.subscribe(this,(()=>this.invalidateTitleCache(!0))),a.inputs.subscribe(this,(()=>this.invalidateTitleCache(!0))),
we.enabled("update_study_formatter_on_symbol_resolve")&&e.mainSeries().dataEvents().symbolResolved().subscribe(this,this._recreatePriceFormattingDependencies),e.mainSeries().dataEvents().symbolResolved().subscribe(this,(()=>this.invalidateTitleCache(!0)));const l=new Set;if(this._simplePlotsCount=i.plots.filter(((e,t)=>{if((0,K.isLinePlot)(e))return!0;if((0,K.isOhlcPlot)(e)){const t=e.target;return!l.has(t)&&(l.add(t),!0)}return!1})).length,this.hasBarColorer()&&a.visible.subscribe(this,(()=>e.mainSeries().invalidateBarStylesCache)),this._definitionsViewModel=null,this._updateMaxOffsetValue(),i.inputs.some((e=>Ss.has(e.id)))){this._visibleTimeRangeInputs=e.visibleRangeStudiesInputs().spawn();const t=this._visibleTimeRangeInputs.value();let s=null!==t;this._visibleTimeRangeInputs.subscribe((e=>{const t=()=>{this._onVisibleTimeRangeInputsChanged(e),s!==(null!==e)&&(s=null!==e,!s||this._restarting||this.isStarted()||this.start(!0))};this._statusChanged.unsubscribeAll(this._statusChangesSubscriber),this._status.value().type===Bt.StudyStatusType.Loading?this._statusChanged.subscribe(this._statusChangesSubscriber,t,!0):t()})),t&&this._updateVisibleTimeRangeInputs(t,!1)}if((0,be.isCountedUserScript)(i)&&(this._showPineVersionInStatusLine=(0,Wt.combine)((e=>(0,be.userScriptVersionsCount)(i.scriptIdPart)>1),(0,be.userScriptsOnLayout)().weakReference()),this._showPineVersionInStatusLine.subscribe((()=>{this.invalidateTitleCache(),e.updateSource(this)}))),!n&&i.TVScriptMetaInfoExprs&&i.defaults.inputs){const e=this.inputs();for(const t of i.inputs)if(!t.isHidden&&!(0,v.isStudyInputDependsOnChart)(t)&&i.defaults.inputs[t.id]!==e[t.id]){this._deferredPinePatchProps=!0,this._oldStudyInputs=this._prepareInputs(os),this._oldStudyInputs[t.id]=i.defaults.inputs[t.id];break}}this._properties.setNameInOwner((0,es.propertyPathForSource)(this)),o&&this._pinePatchProps();const h=ys(this.parentSourcesVW().weakReference());this._allOwnerSources=(0,Wt.combine)(((e,t)=>e),h,(0,Ie.createWVFromGetterAndSubscription)((()=>this.ownerSource()),this.ownerSourceChanged()).ownership());const c=(0,Wt.combine)((e=>e.map((e=>(0,B.isStudy)(e)?(0,Ie.createWVFromGetterAndSubscription)((()=>e.inputs()),e.properties().childs().inputs).ownership():new Ht.WatchedValue(0).ownership()))),this._allOwnerSources.weakReference()),p=(0,Wt.accumulate)(((e,t)=>(t??0)+1),c.ownership()),_=(0,Wt.combine)(((e,t,s)=>(s??0)+1),(0,Ie.createWVFromGetterAndSubscription)((()=>this.formatter()),this.formatterChanged()).ownership(),(0,Ie.createWVFromGetterAndSubscription)((()=>this.inputs()),this.properties().childs().inputs).ownership());this._alertStateVersion=(0,Wt.combine)(((e,t,s,i,r)=>(r??0)+1),this._metaInfo.weakReference(),this._plotOffsets.weakReference(),p.ownership(),_.ownership()),this._alertStateVersion.subscribe((()=>{this._stateForAlertCache=null,this._idForAlertCache=null}))}destroy(){this._signlePerformanceValue?.destroy(),this._aboutToBeDestroyed.fire(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),
this._showStudyArgumentsProperty.unsubscribeAll(this),this._model.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this);this.parentSources().forEach((e=>{e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this),e.priceRangeReadyChanged().unsubscribeAll(this),e.formatterChanged().unsubscribeAll(this),e.priceStepChanged().unsubscribeAll(this)})),this._series.properties().childs().statusViewStyle.childs().symbolTextSource.unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._series.alertCreationAvailable().unsubscribe(this._updateAlertCreationAvailable),this.formatterChanged().unsubscribe(this,this.invalidateTitleCache),J.hideAllIndicators().unsubscribe(this,this._visibleChanged),this._model.collapsed().unsubscribe(this._processHibernateBound),null!==this._currencySourceSymbolInputProperty&&this._currencySourceSymbolInputProperty.unsubscribeAll(this),this._legendView?.destroy(),this._floatingTooltipView?.destroy(),this._pineSourceCodeModel?.get()?.destroy(),this._visibleTimeRangeInputs?.destroy(),this._showPineVersionInStatusLine.destroy(),this._alertStateVersion.destroy(),this._metaInfo.destroy(),this._studyName.destroy(),this._allOwnerSources.destroy(),this._sources.destroy(),this._status.destroy(),this._compileActiveStatus.destroy(),this._compileErrorStatus.destroy(),this._plotOffsets.destroy(),this._serverPlotOffsets.destroy(),this._properties.destroy(),super.destroy()}setId(e){super.setId(e),this._properties.setNameInOwner((0,es.propertyPathForSource)(this))}properties(){return this._properties}propertiesPatched(){return this._propertiesPatched}isDraggable(){return!this._metaInfo.value().linkedToSeries}logs(){return this._metaInfo.value().graphics.logs&&this._graphics instanceof W.LiveStudyGraphics?(0,u.ensureDefined)(this._graphics.observableLogs().get("logs")):null}logLevelMask(){const e=this._properties.childs().inputs.childs().__log_level.value();if(!(0,te.isNumber)(e)||e<0||e>7)throw new Error(`Value of log level is unexpected, current value is ${e}, but expected values from 0 to 7`);return{error:Boolean(1&e),warning:Boolean(2&e),info:Boolean(4&e)}}setLogLevelMask(e){const t=(Number(e.error)&&1)|(Number(e.warning)&&2)|(Number(e.info)&&4);this._properties.childs().inputs.childs().__log_level.setValue(t)}performance(){return this._graphics instanceof W.LiveStudyGraphics?this._signlePerformanceValue:new Ht.WatchedValue(null)}profilingEnabled(){return!!this._properties.childs().inputs.childs().__profile?.value()}enableProfiling(e){this._properties.childs().inputs.childs().__profile?.setValue(e)}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}priceScale(e){return e?this._model.mainSeries().priceScale():super.priceScale()}lastValueData(e,t,s){const i={noData:!0},r=this.metaInfo().isPlotForceOverlay(e),n=r?this._model.mainSeries().priceScale():this.priceScale();if(this._model.timeScale().isEmpty()||null===n||n.isEmpty()||this.data().isEmpty())return i;const o=this._model.timeScale().visibleBarsStrictRange(),a=this.firstValue(!0,r)
;if(null===o||null===a)return i;if(!this._properties.childs().visible.value())return i;const l=this._properties.childs().styles,h=this._properties.childs().ohlcPlots;let u,c;if(l&&l.childs()[e]&&(u=l.childs()[e]),h&&h.childs()[e]&&(u=h.childs()[e]),!u||0===u.childs().display.value())return i;const d=this.metaInfo().plots;for(c=0;c<d.length;c++){const t=d[c];if(t.id===e||(0,K.isOhlcClosePlot)(t)&&t.target===e)break}const p=c+1,_=this.offset(e),f=this.nearestIndex(o.lastBar()-_,G.PlotRowSearchMode.NearestLeft,p);if(void 0===f)return i;const m=this._lastNonEmptyPlotRow(p),y=null!==m&&o.contains(m.index),g=null!==m?m.value:null,v=t||y?g:this.data().valueAt(f);if(!v||!(0,te.isNumber)(v[p]))return i;const S=v[p],b=this._valuesProvider.getPlotColor(c,v),I=n.priceToCoordinate(S,a),P=this.plotFormatter(e).format(S),w={...n.getFormattedValues(S,a,void 0,P),noData:!1,color:b,floatCoordinate:I,coordinate:I};return s&&(w.price=S),w}isFailed(){return this.status().type===Bt.StudyStatusType.Error}isLoading(){return this.status().type===Bt.StudyStatusType.Loading}isCompleted(){return this.status().type===Bt.StudyStatusType.Completed}isSymbolInvalid(){const e=this._status.value();return e.type===Bt.StudyStatusType.Error&&e.errorDescription.error===rs}series(){return this._series}model(){return this._model}state(e,t){const s=(0,u.ensureNotNull)((0,_.getStudyClassName)(this.constructor)),i=this.metaInfo(),r={type:s,id:this.id(),state:this.properties().state(),zorder:this.zorder(),ownFirstValue:this.isVisible()?null:this._ownFirstValue,metaInfo:this._originalMetaInfo.state()},n=(0,h.default)(r.metaInfo,this._metaInfo.value().state());(0,o.default)(n)||(r.metaInfoPatch=n);const a=this._sources.value().map((e=>e.id()));if(a.length&&(r.parentSources=a),e){let e=this.data();const t=this._model.timeScale(),s=this._seriesDataRangeToSave(e);null!==s&&(e=e.range(s.firstBar(),s.lastBar())),r.data=e.state(),r.data.symbols=this._resolvedSymbols,r.data.graphics=(0,W.saveStudyGraphics)(this.graphics(),t.visibleBarsStrictRange()),r.data.plotOffsets=this._serverPlotOffsets.value()}this.ownerSource()&&(r.ownerSource=this.ownerSource()?.id());for(let e=0;e<i.inputs.length;e++)if("bar_time"===i.inputs[e].type){const t=i.inputs[e].id,s=r.state.inputs[t];if(s<0){const e=this._rightOffsetToUnixTime(-s);r.state.inputs[t]=e&&e>=0?e:0}}if(r.state?.inputs){const e=r.metaInfo.inputs.find((e=>"ILScript"===e.name));e&&delete r.state.inputs[e.id],delete r.state.inputs.__log_level,delete r.state.inputs.__profile}const l=this.stateCustomFields();var c;return l&&(r.customFields=l),t&&(c=r).metaInfo&&c.metaInfo.scriptIdPart&&c.metaInfo.scriptIdPart.startsWith("USER;")&&(_s(c),function(e){const t=(e.metaInfo&&e.metaInfo.inputs||[]).find((e=>"ILScript"===e.name));t&&(t.defval="",e.state&&e.state.inputs&&(e.state.inputs[t.id]=""),e.metaInfo.defaults.inputs&&(e.metaInfo.defaults.inputs[t.id]=""))}(c)),r}stateCustomFields(){const e=this._compileErrorStatus.value();if(e)return{compileErrorDescription:e.errorDescription}}restoreStateCustomFields(e){
const t=e.compileErrorDescription;t&&this.setErrorCompilation([(0,u.ensureDefined)(t.editorError)])}restoreData(e){this._invalidateLastNonEmptyPlotRowCache(),this.data().restoreState(e),this._resolvedSymbols=e.symbols??{},this._graphics=e.graphics?(0,W.loadStudyGraphics)(e.graphics):(0,W.emptyStudyGraphics)(),this._postProcessGraphics(),this._serverPlotOffsets.setValue(e.plotOffsets??{}),this._setStatus({type:Bt.StudyStatusType.Completed},!0)}hasStateForAlert(){return Se.alertsAvailable&&!this.isFailed()&&!this._metaInfo.value().isTVLibrary&&this._series.alertCreationAvailable().value()&&(this._hasAlertConditions()||this._hasAvailableAlertPlots()||this._hasAlertFunction())}stateForAlert(){if(this._stateForAlertCache)return this._stateForAlertCache;const e=(0,u.ensureNotNull)(this._alertMetaInfo()),t=this._plotsForAlert(),s=this._collectDepsForAlert(),i=s.idForAlert,r=s.studyDependencies,n=s.inputsForAlert,o=this._formatterStateForAlert(),a=C.studyIdsWithNoInputsInTitle.has((0,w.extractStudyId)(e.fullId)),l={id:i,type:(0,u.ensureNotNull)((0,_.getStudyClassName)(this.constructor)),title:(0,m.clean)(this._title(se.TitleDisplayTarget.Alerts,!1,{},a,!1,!0),!0),shortTitle:(0,m.clean)(this._title(se.TitleDisplayTarget.Alerts,!0,{},a,!1,!0),!0),shortDescription:(0,m.clean)(e.shortDescription||"Study",!0),fullId:e.fullId,isTVScript:Boolean(e.isTVScript),hasAlertFunction:Boolean(e.hasAlertFunction),plots:t,inputs:n,alerts:e.alerts,scriptIdPart:e.scriptIdPart,scriptVersion:e.pine?e.pine.version:"-1",studyDependencies:r,formatter:o},h=I(this);h&&(l.dangerReason=h);const c=e.defaultStrategyAlertMessage;return c&&(l.defaultStrategyAlertMessage=(0,m.clean)(c,!0)),this._stateForAlertCache=l,l}idForAlert(){return null===this._idForAlertCache&&(this._idForAlertCache=this._collectDepsForAlert().idForAlert),this._idForAlertCache}hasBarColorer(){return this._metaInfo.value().plots.some(K.isBarColorerPlot)}barColorer(){const e=this._metaInfo.value().plots;let t=null;for(let s=e.length-1;s>=0;s--)if((0,K.isBarColorerPlot)(e[s])){const e=new Kt(this,s);null===t?t=e:t.pushBackBarColorer(e)}return t}isSavedInStudyTemplates(){return this._metaInfo.value().inputs.every((e=>"bar_time"!==e.type))}restart(e){this._restarting=!0,this.clearData(),(e||we.enabled("stop_study_on_restart"))&&this.stop(),setTimeout(this.start.bind(this),0)}stop(e,t){if(!0===e&&this._children)for(const e of this._children)e.stop(!0);this._stopStudyOnServer(),this.clearData(),this._unsubscribeToSessionId(),this.recalculate()}disconnect(){this._studyId=null,this._model.isSnapshot()||(this._resolvedSymbols={},this._resolvedSymbolsByInput={})}sourceId(){return this._studyId}parentSources(){return this._sources.value()}parentSourcesVW(){return this._sources}symbolSource(){return this._firstSourceOrSeries().symbolSource()}valueAt(e,t){return this.symbolSource().valueAt(e,t)}barsProvider(){return this._firstSourceOrSeries().barsProvider()}ownerSource(){return this.isChildStudy()?this._sources.value()[0]:super.ownerSource()}isChildStudy(){return this._sources.value().length>0}
hasChildren(){return this._children.length>0}isStarted(){return Boolean(this._studyId)}isRestarting(){return this._restarting}isActualInterval(){return this._isActualInterval}onIsActualIntervalChange(){return this._onIsActualIntervalChange}isVisible(){const e=this._properties.childs();if(this._model.collapsed().value()||!e.visible.value()||!this.isActualInterval())return!1;const t=this.metaInfo();if(t.plots.length>0)for(let s=0;s<t.plots.length;s++){const i=t.plots[s].id,r=e.styles.childs()[i];if(void 0===r)continue;if(0!==r.childs().display.value())return!0}if(t.bands)for(let s=0;s<t.bands.length;s++)if(e.bands.childs()[s].childs().visible.value())return!0;for(const s of Object.keys(t.graphics))for(const i of Object.keys(t.graphics[s])){const t=e.graphics.childs()[s]?.childs()[i];if(void 0!==t&&(t.child("visible")?.value()??1))return!0}if(t.filledAreas)for(let s=0;s<t.filledAreas.length;s++)if(e.filledAreasStyle.childs()[t.filledAreas[s].id].childs().visible.value())return!0;return!(!t.isTVScriptStrategy&&!t.hasAlertFunction)}async start(e,t,s){const i=this._model.mainSeries();await i.seriesCreated(),await Promise.all(this._sources.value().filter((e=>e.isHibernated())).map((e=>e.start())));const r=!(this.isHibernationAllowed()&&!this.isVisible())||!0===t;if(this._chartApi&&this._chartApi.isConnected().value()&&r)try{await this._allSymbolsAreResolved(),await this._startAfterSymbolsResolved(e,t)}catch(e){const t=`ERROR: ${this._debugId()} start failed, ${e}`;is.logError(t),this._restarting=!1,"TooManyStudies"===e?.cause&&(0,R.showTooManyStudiesNotice)(this._chartApi.getStudyCounter())}r||void 0!==this._inputs||(this._inputs=this._apiInputs())}replaceData(e,t,s){this._invalidateLastNonEmptyPlotRowCache(),this.data().remove(e+1),this.data().addTail(s,t)}inputs(e){const t=(0,n.default)((0,te.clone)(ns),e||{});t.skipOptionalEmptySymbolInputs&&(t.keepOptionalSymbolsEmpty=!0);const s=(0,r.default)(this._buildInputs(t));return t.patchSosInputs&&H.StudyMetaInfo.patchSoSInputs(s,(e=>this._sources.value().find((t=>t.id()===e))?.sourceId()??null)),s}data(){return this._data}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._invalidateLastNonEmptyPlotRowCache(),this._moveData(e)}))}plots(){return this.data()}metaInfo(){return this._metaInfo.value()}status(){return this._compileActiveStatus.value()??this._compileErrorStatus.value()??this._status.value()}name(e){return e?this.metaInfo().shortDescription||"Study":this.metaInfo().description||"Study"}title(e,t,s,i,r,n){i=void 0===i?!this._showStudyArgumentsProperty.value():i;const o=JSON.stringify([e,t,s,i,r,n]);if(this._titleStrCache[o])return this._titleStrCache[o];if(this._titleInPartsCache[o])return this._joinTitlesParts(this._titleInPartsCache[o]);const a=this._title(e,t,s,i,r,n);return this._titleStrCache[o]=a,a}titleInParts(e,t,s,i,r){i=void 0===i?!this._showStudyArgumentsProperty.value():i;const n=JSON.stringify([e,t,s,i,r]);if(this._titleInPartsCache[n])return this._titleInPartsCache[n];const o=this._titleInParts(e,t,s,i,r)
;return this._titleInPartsCache[n]=o,o}inputsInParts(e,t=!0,s,i,r){if(!this._showStudyArgumentsProperty.value()&&e===se.TitleDisplayTarget.StatusLine)return null;const n=JSON.stringify([e,t,s,i,r]);if(this._inputsInPartsCache[n])return this._inputsInPartsCache[n];const o=[],a=this.metaInfo(),l=this._titleInputs((0,ts.toInputDisplayFlags)(e),i,!0),h=a.inputs.filter((e=>l.hasOwnProperty(e.id))).map((e=>({meta:e,value:l[e.id]}))),c={};if(h.length>0){if(this.isChildStudy())for(let s=0;s<a.inputs.length;++s){const n=a.inputs[s];if(!H.StudyMetaInfo.isSourceInput(n))continue;const o=n.id,l=(0,u.ensureDefined)(this._properties.childs().inputs.child(o)).value();if(l.indexOf("$")>=0){const s=this.parentSourceForInput(l);if(s instanceof bs){const n=s.metaInfo(),o=s.title(e,t,{},!0,i,r);if(1===n.plots.length)c[l]=o;else{const e=l.split("$")[1],t=n.plots[parseInt(e)]?.id,s=n.styles&&n.styles[t],i=s&&s.title||t;c[l]=o+": "+i}}}}h.forEach((({meta:e,value:t})=>{let i;i="time"===e.type?new Date(t).toISOString():(0,te.isNumber)(t)?(0,Qt.getNumericFormatter)().format(t):c&&c[t.toString()]||t.toString(),s&&s[i.toString()]&&(i=s[i.toString()]),o.push({title:(0,ss.getTranslatedInputTitle)(e.name),value:i})}))}return this._inputsInPartsCache[n]=o,o}invalidateTitleCache(e){if(this._titleStrCache={},this._titleInPartsCache={},this._inputsInPartsCache={},!0===e&&this._children)for(let t=0;t<this._children.length;++t)this._children[t].invalidateTitleCache(e)}graphics(){return this._graphics}graphicsInfo(){return this._metaInfo.value().graphics}priceLabelText(e){const t=this._metaInfo.value(),s=t.styles,i=t.ohlcPlots;let r;s&&s[e]&&(r=s[e]),i&&i[e]&&(r=i[e]);const n=(0,u.ensureDefined)(r).title;return 1!==this._simplePlotsCount||(0,K.isPlotTitleDefined)(n)?t.is_price_study&&n!==t.shortDescription?""===n?t.shortDescription:t.shortDescription+":"+n:n:t.shortDescription}setOwnFirstValue(e){this._ownFirstValue=e}firstValue(e,t){if(t)return this._series.firstValue();const s=this._metaInfo.value();if(!this.isChildStudy()&&"Compare@tv-basicstudies"===s.id||!s.is_price_study){const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return null;const i=this.properties().childs();if(!i.visible.value()||!this.isActualInterval()||null!==this._startMovingPoint)return this._ownFirstValue;const r=t.firstBar(),n=t.lastBar();let o=this._graphicsPriceRangeGroups?function(e,t){const s=e.model().timeScale();if(s.isEmpty())return null;const i=s.visibleBarsStrictRange();if(null===i)return null;const r=i.firstBar(),n=i.lastBar(),o=new me;for(const e of t){const t=e.firstValue(r,n);o.improve(t)}return o.bestPrice()}(this,this._graphicsPriceRangeGroups):null;if(null===o){const t=new Set,a=s.filledAreas||[];for(let e=0;e<a.length;e++){const s=a[e];i.filledAreasStyle.childs()[s.id].childs().visible.value()&&(t.add(s.objAId),t.add(s.objBId))}const l=s.plots||[];for(const a of this.data().rangeIterator(r,n)){const r=a.value;for(let n=0;n<l.length;++n){const a=l[n],h=a.id;if((0,K.isColorerPlot)(a)||s.isPlotForceOverlay(h))continue;const c=r[n+1]
;if(null==c)continue;if((0!==(0,u.ensureDefined)(i.styles.childs()[h]).childs().display.value()||t.has(h))&&!(e&&Math.abs(c)<1e-10)){o=c;break}}if(null!==o)break}}return this._ownFirstValue=o,null!==o?o:this._bandsFirstValue(e)}if(this.isChildStudy()){const e=this._getNonPriceParent();if(e&&this.priceScale()===e.priceScale())return null!==e._ownFirstValue?e._ownFirstValue:e.firstValue()}return this._series.firstValue()}desiredPriceScalePosition(){if(this.metaInfo().isTVScriptStub)return"overlay";if(this.metaInfo().linkedToSeries)return"as-series";switch(this.metaInfo().priceScale){case 1:return"left";case 0:return"right";case 2:return"overlay";default:return null}}offset(e){return this._plotOffsets.value()?.[e]??0}tags(){const e=this._metaInfo.value();return!e.description||e.isTVScriptStub||e.is_hidden_study||e.isTVScript&&"tv-scripting"===e.productId?[]:[e.description]}copiable(){return hs&&!this.isChildStudy()}setPriceScale(e){super.setPriceScale(e),(0,qt.emit)("study_event",this.id(),"price_scale_changed")}priceRange(e,t,s){let i=null;const r=this._metaInfo.value(),n=this._fillPrecalculatedAutoscaleInfo(e,t,s);let o=this.data().minMaxOnRangeCached(e,t,n.fields);if(o=(0,L.mergeMinMax)(n.baseValueMinMax,o),n.useMainSeriesRange){const s=[{name:"low",offset:0},{name:"high",offset:0}],i=this.series().data().bars().minMaxOnRangeCached(e,t,s);o=(0,L.mergeMinMax)(o,i)}if(null!==o&&(i=new E.PriceRange(o.min,o.max)),r.bands&&s.targetPriceScale===this.priceScale())for(let e=0;e<r.bands.length;e++){const t=(0,u.ensureDefined)(this._properties.childs().bands.childs()[e]).childs();if(t.visible.value()){const e=t.value.value();if(!(0,te.isNumber)(e))continue;i?i.apply(e,e):i=new E.PriceRange(e,e)}}if(this._graphicsPriceRangeGroups){const r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==s.targetPriceScale,n=function(e,t,s,i){let r=null;for(const n of e){const e=n.groupPriceRange(t,s,i);null!==e&&(r=null===r?e:r.merge(e))}return r}(this._graphicsPriceRangeGroups,e,t,!!s.forceOverlayOnly||r);n&&(i=i?i.merge(n):n)}return this._postProcessPriceRange(i,s)}autoScaleInfo(e,t,s){const i=this.priceRange(e,t,s),r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==s.targetPriceScale,n=this._graphicsPriceRangeGroups?function(e,t,s,i){const r=pe();for(const n of e){const e=n.groupPixelMargins(t,s,i);r.bottomPixelMargin=Math.max(r.bottomPixelMargin,e.bottomPixelMargin),r.topPixelMargin=Math.max(r.topPixelMargin,e.topPixelMargin)}return r}(this._graphicsPriceRangeGroups,e,t,!!s.forceOverlayOnly||r):{topPixelMargin:0,bottomPixelMargin:0};return{range:i,topPixelMargin:n.topPixelMargin,bottomPixelMargin:n.bottomPixelMargin}}formatter(e){return this._formatter??this._firstSourceOrSeries().formatter(!1)}defaultFormatter(){const e=this._firstSourceOrSeries();return this._defaultFormatter??e.defaultFormatter?.()??e.formatter()}plotFormatter(e){return this._plotFormatters.get(e)??this.formatter()}isMultiPaneAvailable(){return this._metaInfo.value().hasForceOverlayPlots()||(0,
F.hasForceOverlayPrimitives)(this._metaInfo.value())}isMultiPaneEnabled(){return this._metaInfo.value().hasForceOverlayPlots()}updateAllViews(e){const t=this._model.paneForSource(this),s=this._model.mainPane(),i="viewport-change"===e.type&&e.pane&&e.pane!==s;"viewport-change"===e.type&&e.pane&&e.pane!==t||(this._paneViews.forEach((t=>t.update(e))),this._labelPaneViews.forEach((t=>t.update(e))),this._dataWindowView?.update(e),this._legendView?.update(e),this._statusView?.update(e),this._floatingTooltipView?.update(e),this._priceAxisViews.forEach((t=>t.update(e))),this._priceLinesAxisViews.forEach((t=>t.update(e))),this._inputsLinesPaneView?.update(e),this._inputsAnchorsPaneView?.update(e),this._inputsTimeAxisPaneViews.forEach((t=>t.update(e))),this._inputsPriceAxisPaneViews.forEach((t=>t.update(e)))),i||(this._forceOverlaysPaneViews.forEach((t=>t.update(e))),this._forceOverlayLabelPaneViews.forEach((t=>t.update(e))),this._forceOverlayPriceAxisViews.forEach((t=>t.update(e)))),"data-source-change"===e.type&&e.sourceId===this.id()&&e.clearData&&this._children.forEach((e=>e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0})))}removeByRemoveAllStudies(){return!0}studyName(){return this._studyName}nearestIndex(e,t,s){return this.data().search(e,t,s)?.index}getMinFirstBarIndexForPlot(e){const t=this._properties.childs(),s=this._metaInfo,i=t.styles.childs()[e]?.child("showLast")?.value()??t.filledAreasStyle.childs()[e]?.child("showLast")?.value()??s.value().styles?.[e]?.showLast??t.ohlcPlots.childs()[e]?.child("showLast")?.value()??s.value().ohlcPlots?.[e]?.showLast??null;if(null===i)return-1/0;const r=this.data().lastIndex();return null===r?-1/0:r-i+1}guiPlotName(e,t){return this._metaInfo.value().styles?.[t]?.title??this.title(e)}childStudyByRebind(){return this._childStudyByRebind}isPine(){return void 0!==this._metaInfo.value().pine}isStandardPine(){return this.isPine()&&H.StudyMetaInfo.isStandardPine(this._metaInfo.value().id)}isLinkedToSeries(){return!0===this._metaInfo.value().linkedToSeries}preferredZOrder(){return!1===this._metaInfo.value().behind_chart?0:null}defaultPlotIdForAlert(){return this._metaInfo.value().plots?.[0]?.id??null}resolvedSymbolInfoBySymbol(e){return this._resolvedSymbols&&e&&this._resolvedSymbols[this._getSymbolForResolve(e)]||null}hasPendingUnresolvedSymbols(){return this._pendingResolveSymbols.size>0}hasSymbolInputs(){return this._metaInfo.value().inputs.some((e=>"symbol"===e.type))}currency(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().currency():null}currencySourceSymbolInfo(){return this._currencySourceSymbolInfo??this.symbolSource()?.symbolInfo()??null}unit(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().unit():null}canOverrideMinTick(){return!1}dataWindowView(){return this._dataWindowView}statusView(){return this._statusView}legendView(){return this._legendView}chartFloatingTooltipView(){return this._floatingTooltipView}pineSourceCodeModel(){
return this.metaInfo().pine?(this._pineSourceCodeModel||(this._pineSourceCodeModel=new D.AsyncResourceWrapper(Promise.all([s.e(34644),s.e(50687),s.e(75947),s.e(88741),s.e(85182),s.e(32565),s.e(7351),s.e(13498),s.e(78466),s.e(40309),s.e(96186),s.e(43477),s.e(95334),s.e(89199)]).then(s.bind(s,498896)).then((e=>this._isDestroyed?null:new e.PineSourceCodeModel(this))),(e=>{e?.destroy()}))),this._pineSourceCodeModel.promise()):Promise.resolve(null)}inputsForAlertState(){return this.inputs()}sessionId(){return this._firstSourceOrSeries().sessionId()}sessionIdChanged(){return this._firstSourceOrSeries().sessionIdChanged()}getSymbolString(e){return""===e?"":(0,Z.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getSymbolObject(e))}onStatusChanged(){return this._statusChanged}onDataUpdated(){return this._dataUpdated}symbolsResolved(){return this._symbolsResolved}onHibernationStateChange(){return this._onHibernationStateChange}valuesProvider(){return this._valuesProvider}legendValuesProvider(){return new $.StudyLegendValuesProvider(this,this.model())}statusProvider(e){return new ee.StudyStatusProvider(this)}correctScaleMargins(e){if("Volume"===this.metaInfo().shortId){const t=this.model().paneForSource(this);return null!==t&&t.isOverlay(this)&&t.containsMainSeries()?{top:.75,bottom:0}:{top:e.top,bottom:0}}return e}canBeHiddenByGlobalFlag(){return!0}isSourceHidden(){return!this.isVisible()||this.canBeHiddenByGlobalFlag()&&J.hideAllIndicators().value()}wasCompletedBefore(){return this._wasCompletedBefore}paneViews(e){const t=this._model.mainPane();if(this.isSourceHidden())return null;if(!e.hasPriceDataSource(this))return e!==t?null:this._forceOverlaysPaneViews;const s=[];return!this._startMovingPoint&&this._wasCompletedBefore&&s.push(...this._paneViews.filter((e=>!e.isForceOverlay?.()))),this._inputsLinesPaneView&&(this._startMovingPoint||this._model.selection().isSelected(this))&&s.push(this._inputsLinesPaneView),this._inputsAnchorsPaneView&&s.push(this._inputsAnchorsPaneView),e===t&&s.push(...this._forceOverlaysPaneViews),s}labelPaneViews(e){const t=this._model.mainPane();if(this.isSourceHidden()||!e.hasPriceDataSource(this))return this._metaInfo.value().hasForceOverlayPlots()?e!==t?null:this._forceOverlayLabelPaneViews:null;const s=[...this._labelPaneViews];return e===t&&s.push(...this._forceOverlayLabelPaneViews),s}timeAxisViews(){return this._model.selection().isSelected(this)?this._inputsTimeAxisPaneViews:null}priceAxisViews(e,t){if(t!==this.priceScale()&&t===this._model.mainSeries().priceScale()&&!e.hasDataSource(this))return this._forceOverlayPriceAxisViews;const s=this._properties.childs().oldShowLastValue;if(s&&!s.value())return null;let i=this._priceAxisViews.slice();return this._model.selection().isSelected(this)&&(i=i.concat(this._inputsPriceAxisPaneViews)),t===this._model.mainSeries().priceScale()&&(i=i.concat(this._forceOverlayPriceAxisViews)),e.findTargetPriceAxisViews(this,t,i,this._priceLinesAxisViews)}movable(){return null!==this._inputsAnchorsPaneView}startMoving(e,t,s,i){this._startMovingPoint=e}
move(e,t,s,i){if(void 0!==e.logical&&null!==this._startMovingPoint){if(Array.isArray(t)){const s=t;this._updateInputValue(e.logical,s[0]),this._updateInputValue(e.logical,s[1])}else this._updateInputValue(e.logical,t);this.updateAllViews((0,j.sourceChangeEvent)(this.id()))}}endMoving(e,t){return this._startMovingPoint=null,{indexesChanged:!1,pricesChanged:!1}}clearData(){this._invalidateLastNonEmptyPlotRowCache(),this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._clearData(),this._graphics instanceof W.LiveStudyGraphics&&this._graphics?.clear(),this._serverPlotOffsets.setValue({})})),this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this.updateAllViews((0,j.sourceChangeEvent)({sourceId:this.id(),clearData:!0}))}convertYCoordinateToPriceForMoving(e,t){const s=this.priceScale();if(!t||!s||s.isEmpty())return null;const i=t.firstValue();return null===i?null:s.coordinateToPrice(e,i)}processHibernate(e){const t=this.isVisible();if(!this.isStarted()&&t&&(this._sources.value().forEach((e=>{e.processHibernate()})),this.start(void 0,void 0,e),this._onHibernationStateChange.fire(!1)),this.isHibernationAllowed()&&this.isStarted()&&!t){for(const e of this._children)e.processHibernate();this.stop(void 0,e),this._onHibernationStateChange.fire(!0)}}isHibernationAllowed(){return!this.metaInfo().historyCalculationMayChange&&(!this.hasChildren()||!!this._model.collapsed().value()&&this._children.every((e=>e.isHibernationAllowed())))}isPlotVisibleAt(e,t){let s;const i=this.metaInfo().plots.find((t=>t.id===e));if(s=void 0!==i?(0,K.isOhlcPlot)(i)?this._properties.childs().ohlcPlots.childs()[i.target]:this._properties.childs().styles.childs()[e]:this._properties.childs().ohlcPlots.childs()[e],void 0===s)throw new Error(`Study does not contain ${e} plot`);const r=s.childs().display.value();return null!==r&&(r&t)===t}recalculate(){const e=this._model.paneForSource(this);this._model.recalculatePane(e,(0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this)}maxOffset(){return this._maxOffset}onStart(){return this._onStart}onParentSourcesChanges(){return this._onParentSourcesChanges}isHibernated(){return!this.isVisible()&&!this.isStarted()}graphicsViewsReady(){return this._graphicsViewsReady}setLoadingCompilationActive(e){this._compileActiveStatus.setValue(e?{type:Bt.StudyStatusType.Loading,startTime:Date.now()}:null),this._statusView?.update((0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this),this._statusChanged.fire(this.status())}setErrorCompilation(e){{const t=(0,ge.extractPineId)(this._metaInfo.value().id);if(null===e||0===e.length||null===t)return this._compileErrorStatus.setValue(null),void this._setStatus({type:Bt.StudyStatusType.Undefined});const s=e[0];this._compileErrorStatus.setValue({type:Bt.StudyStatusType.Error,errorDescription:{error:s.message,editorError:{...s,id:t},title:"Compilation error"}}),this._statusView?.update((0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this),this._statusChanged.fire(this.status())}}hasCompileError(){
return null!==this._compileErrorStatus.value()}turnaround(e){if(!e)return this._turnaround;const t=this._series.seriesSource().turnaround(),s=(0,Pe.buildTreeForStudy)(this);return(0,Pe.buildTurnaround)(t,s)}canHaveChildren(){return this._canHaveChildren=this._canHaveChildren??H.StudyMetaInfo.canHaveChildren(this._metaInfo.value()),this._canHaveChildren}setChild(e){-1===this._children.indexOf(e)&&this._children.push(e)}unsetChild(e){const t=this._children.indexOf(e);~t&&this._children.splice(t,1)}getAllChildren(){const e=this._children.slice();for(let t=0;t<e.length;++t){const s=e[t].getAllChildren();for(let t=0;t<s.length;++t)~e.indexOf(s[t])||e.push(s[t])}return e}parentSourceForInput(e){if(e.includes("$")){const t=e.split("$")[0];return this._sources.value().find((e=>e.id()===t))??null}return this._series}priceStep(){return this._priceStep||this._firstSourceOrSeries().priceStep(!1)}recreatePriceFormatter(){this._recreatePriceFormattingDependencies()}setOwnerSource(e){super.setOwnerSource(e),this._recreatePriceFormattingDependencies()}onTagsChanged(){return this._tagsChanged}getPropertyDefinitionsViewModel(){return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}calculationTime(){return this._calculationTime.readonly()}contextMenuStatName(){return"IndicatorContextMenu"}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_alertMetaInfo(){return this.metaInfo()}_createStudyOnServer(){if(this._isDestroyed)return!1;const e=this._metaInfo.value();this._studyId=(0,X.makeNextStudyId)(),this._incrementTurnaround();const t=(0,te.clone)((0,u.ensureDefined)(this._inputs));let s;if(H.StudyMetaInfo.patchSoSInputs(t,(e=>this._sources.value().find((t=>t.id()===e))?.sourceId()??null)),s=this._chartApi.createStudy(this._studyId,this._turnaround,(0,u.ensureNotNull)(this._series.seriesSource().instanceId()),this._studyName.value(),t,this._handler,this._studySpec()),!s)return this._studyId=null,s;if(performance.mark(`calculate_study_${this._studyId}`),void 0===this._oldStudyInputs){if(e.TVScriptMetaInfoExprs){this._previousPatchMap={};const t=e.TVScriptMetaInfoExprs.patchMap||{},s=new H.StudyMetaInfo(this._metaInfo.value().state(),this._metaInfo.value().useVersionFromMetaInfo);(0,V.iterateAndPatchObjectsByMap)([this._properties,s.defaults,s],t,((e,t,s)=>{const i=e[0],r=e[1],n=e[2];r?.hasOwnProperty(t)?(0,u.ensureDefined)(this._previousPatchMap)[s]=i[t].value():(0,u.ensureDefined)(this._previousPatchMap)[s]=n[t]})),this._metaInfo.setValue(s)}const t=this._prepareInputs(os);Object.keys(t).some((e=>(0,v.isStudyInputDependsOnChart)({id:e})))||(this._oldStudyInputs=t)}return this._deferredPinePatchProps&&!this._restarting&&this._pinePatchProps(),!0}_stopStudyOnServer(){this._chartApi&&this._chartApi.isConnected().value()&&this.isStarted()&&(this._chartApi.removeStudy((0,
u.ensureNotNull)(this._studyId)),this._setStatus({type:Bt.StudyStatusType.Undefined})),performance.clearMarks(`calculate_study_${this._studyId}`),this._studyId=null}_modifyStudyOnServer(e,t){const s=(0,te.clone)((0,u.ensureDefined)(e));H.StudyMetaInfo.patchSoSInputs(s,(e=>this._sources.value().find((t=>t.id()===e))?.sourceId()??null)),this._chartApi.modifyStudy((0,u.ensureNotNull)(this._studyId),this._turnaround,s,this._handler,t),performance.mark(`calculate_study_${this._studyId}`)}_sendNotifyCommand(e,t){this._chartApi.notifyStudy((0,u.ensureNotNull)(this._studyId),e,t)}_transformData(e){}_invalidateLastNonEmptyPlotRowCache(){this._lastNonEmptyPlotRowCache={}}_collectDepsForAlert(){const e=[this,...this._allOwnerSources.value().filter((e=>e instanceof bs))];return(0,P.collectDepsForAlert)(e)}_allInputsAreValid(){if(null===this._visibleTimeRangeInputs?.value())return!1;for(const e of this._metaInfo.value().inputs)if("bar_time"===e.type){const t=e.id;if(null==this._properties.childs().inputs.childs()[t].value())return!1}return!0}async _startAfterSymbolsResolved(e,t){await Promise.all(this._sources.value().map((e=>!e.isStarted()||e.isRestarting()?new Promise((t=>{e.onStart().subscribe(this,t,!0)})):Promise.resolve()))),this.isStarted()&&!this._restarting||(this._restarting=!1,this._allInputsAreValid()&&!this.metaInfo().isTVScriptStub&&(this._inputs=this._apiInputs(),this._createStudyOnServer()&&(this._subscribeToSessionId(),this._onStart.fire(),!0===e&&this._children&&await this._children.map((e=>e.start(!0,t))))))}async _changeInputsImpl(e,t){const i=this._calcSources(),r=this._metaInfo.value(),n=ms(r,e,t),o=()=>{for(const s of r.inputs){if("source"!==s.type)continue;const i=e[s.id].v,r=t[s.id].v;if(i!==r){(0,u.ensureDefined)(this._properties.childs().inputs.child(s.id)).setValue(r)}}};if(this.isStarted()&&this._chartApi.isConnected().value()&&n>0&&!this._chartApi.canCreateStudy(this._studySpec(!0),!0).success){const e=window.user.pro_plan;return(0,x.createGoProDialog)({feature:"studyOnStudy",actions:e&&"pro_premium_expert"===e?[{text:c.t(null,void 0,s(515462)),action:A.PredefinedAction.Close}]:void 0}),void o()}this._inputs=e;let a=!1;const l=Object.values(v.RangeDependentStudyInputNames);for(const s of Object.keys(e))if(JSON.stringify(e[s])!==JSON.stringify(t[s])&&!l.includes(s)){a=!0;break}this._incrementTurnaround(),a&&this.disablePriceRangeReady();try{await this._updateParentSources(i,n,!0),this._modifyStudyOnServer(e,n),this._studyModified=!0}catch(e){is.logError(`Error applying parent sources: ${e}`),o()}this.invalidateTitleCache()}_createPriceAxisView(e){return new zt.StudyPriceAxisView(this,{plotIndex:e})}_createPriceLineAxisView(e){return new jt.StudyPriceLineAxisView(this,e)}_createStudyPlotPaneView(e){return new St.StudyPlotPaneView(this,this._series,this._model,e)}_createViews(){this._priceAxisViewsBase=[],this._forceOverlayPriceAxisViews=[],this._priceLinesAxisViews=[],this._paneViews=[],this._forceOverlaysPaneViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[]
;const e=new Set,t=this.metaInfo(),s=Boolean(t.usePlotsZOrder),i=new Map,r=this._properties.childs();if(r.filledAreasStyle&&t.filledAreas)for(let e=0;e<t.filledAreas.length;++e){const n=t.filledAreas[e],o=(0,u.ensureDefined)(r.filledAreasStyle.childs()[n.id]),a=fs(t,n.id);let l;if("plot_plot"===n.type||a?l=new At(this,this.model(),n,o):"hline_hline"===n.type?l=new kt(this,n,o):is.logWarn("Unsupported filledArea type: "+n.type),void 0!==l){let e=!1;if("plot_plot"===n.type&&(e=t.isPlotForceOverlay(n.objAId)),e)this._forceOverlaysPaneViews.push(l);else{const e=s?(0,u.ensureDefined)(n.zorder):i.size;ps(e,i),i.set(e,{paneViews:[l]})}}}{let r=-1e5;for(let n=0;n<t.plots.length;n++){const o=t.plots[n];let a,l,h,c,d,p=t.isPlotForceOverlay(o.id);if((0,K.isNonVisualPlot)(o))continue;let _=o.id,f=t.styles;const m=(0,K.isBgColorerPlot)(o);if(m)a=new De(this,this._series,this._model,_);else if((0,K.isShapesPlot)(o))a=new Je(this,this._series,this._model,_);else if((0,K.isCharsPlot)(o))a=new at(this,this._series,this._model,_);else if((0,K.isArrowsPlot)(o))a=new pt(this,this._series,this._model,_);else if((0,K.isOhlcPlot)(o)){const s=o.target;if(e.has(s))continue;if(p=t.isPlotForceOverlay(s),e.add(s),cs(t,n))a=new mt(this,this._series,this._model,s);else{if(!ds(t,n)){is.logError(`plot ${o.id} looks to be invalid`);continue}a=new gt(this,this._series,this._model,s)}c=this._createPriceAxisView(s),h=new vt.PanePriceAxisView(c,this,this._model),_=s,f=t.ohlcPlots}else(0,K.isDataPlot)(o)||(c=this._createPriceAxisView(_),d=this._createPriceLineAxisView(_),a=this._createStudyPlotPaneView(_),this._properties.childs().styles.childs()[_]?.child("trackPrice")?.value()&&(l=new Pt(this,_)),h=new Xt(c,this,this._model,_));const y=s?m?r++:(0,u.ensureDefined)(f?.[_]?.zorder):i.size;if(ps(y,i),p)c&&this._forceOverlayPriceAxisViews.push(c),a&&this._forceOverlaysPaneViews.push(a),h&&this._forceOverlayLabelPaneViews.push(h);else{const e={paneViews:void 0!==a?[a]:[],labelView:h,priceAxisView:c,priceLineAxisView:d};void 0!==l&&e.paneViews.push(l),i.set(y,e)}}}(this._metaInfo.value().bands??[]).forEach(((e,t)=>{const n=r.bands.childs()[t];if(n&&n.childs().visible.value()){const t=new Tt(n,this),r=s?(0,u.ensureDefined)(e.zorder):i.size;ps(r,i),i.set(r,{paneViews:[t]})}})),r.bandsBackground&&((0,u.assert)(!s,"'usePlotsZOrder' flag does not supported"),i.set(i.size,{paneViews:[new Nt(this)]}));const n=this._paneViews,o=this._forceOverlaysPaneViews;this._createGraphicsPaneViews().then((e=>{for(let t=0;t<e.regularPaneViews.length;t++)n.push(e.regularPaneViews[t]);for(let t=0;t<e.forceOverlayPaneViews.length;t++)o.push(e.forceOverlayPaneViews[t]);this._model.lightUpdate(),this._graphicsViewsReady=!0})),r.areaBackground&&((0,u.assert)(!s,"'usePlotsZOrder' flag does not supported"),i.set(i.size,{paneViews:[new wt.AreaBackgroundPaneView(this,this.model())]}));const a=Array.from(i.keys()).sort(((e,t)=>e-t));for(let e=0;e<a.length;e++){const t=(0,u.ensureDefined)(i.get(a[e]));this._paneViews.push(...t.paneViews),t.labelView&&this._labelPaneViews.push(t.labelView),
t.priceAxisView&&this._priceAxisViewsBase.push(t.priceAxisView),t.priceLineAxisView&&this._priceLinesAxisViews.push(t.priceLineAxisView)}this._dataWindowView||(this._dataWindowView=new Rt.StudyDataWindowView(this,this._model)),this._legendView||(this._legendView=new q(this,this._model)),this._statusView||(this._statusView=new Y.StudyStatusView(this)),this._floatingTooltipView||(this._floatingTooltipView=new Dt.StudyChartFloatingTooltipView(this,this._model)),this._concatPriceAxisViews()}_onData(e){switch(e.method){case"study_loading":this._onStudyLoading(e.time);break;case"study_error":this._onStudyError(e.params[2]);break;case"study_completed":if(!this._checkTurnaround(e.params[1]))return;this._onStudyCompleted(e.time);break;case"data_update":if(e.params.customId!==this.sourceId()||!this._checkTurnaround(e.params.turnaround))return;(0,u.assert)(!!e.params.nonseries,"data.params.nonseries is missing"),this._onDataUpdate(e.params.plots,(0,u.ensureDefined)(e.params.nonseries),e.params.lastBar);break;case"clear_data":this._checkTurnaround(e.params.turnaround)&&this.clearData()}}_getTelemetryObjectName(){return"study"}_onDataUpdated(e,t,s,i){if(this.hasBarColorer()&&e.length>0){const t=(0,u.ensureNotNull)(this.barColorer()).firstColoredBar(e[0].index);null!==t&&this._model.mainSeries().invalidateBarStylesCache(t)}null!==t&&this._postProcessGraphics();const r=this._model.paneForSource(this);this._model.recalculatePane(r,(0,j.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:i??void 0,nonSeriesOnly:0===e.length})),this._updateSources()}_titleInputs(e,t,s){return this.inputs(this._titleInputsOptions(e,t,s))}_titleInputsOptions(e,t,s){return{symbolsForDisplay:!0,skipHiddenInputs:!0,skipFakeInputs:!1,fakeInputsForDisplay:!0,asObject:!0,skippedGroups:[],skippedInputs:this._skippedTitleInputs(),noExchanges:t,noResolution:s,priceInputsForDisplay:!0,skipOptionalEmptySymbolInputs:ls,displayMask:e}}_postProcessGraphics(){this._graphicsPriceAxisViews=this._createGraphicsPriceAxisViews(),this._concatPriceAxisViews()}async _createGraphicsPaneViews(){return(0,W.createGraphicsPaneViews)(this,this.model())}_createGraphicsPriceAxisViews(){return(0,W.createGraphicsPriceAxisViews)(this)}_subscribeToSessionId(){!this._isSubscribedToSessionId&&this.hasSymbolInputs()&&(this.sessionIdChanged().subscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!0)}_recreateFormatter(e){this._recreatePlotsFormatters(e),this._formatter=this._tryCreateFormatter(e),this._defaultFormatter=this._tryCreateDefaultFormatter(e),this._formatterChanged.fire();const t=this.priceScale();null!==t&&t.updateFormatter(),this.getAllChildren().forEach((e=>{e.recreatePriceFormatter()})),this._model.fullUpdate()}_recreatePriceFormattingDependencies(e){this._recreateFormatter(e),this._recreatePriceStep()}_title(e,t,s,i,r,n){const o=this._titleInParts(e,t,s,i,r,n);return this._joinTitlesParts(o)}_postProcessPriceRange(e,t){if(e&&e.minValue()===e.maxValue()&&!this.metaInfo().is_price_study){const t=.005*e.minValue()
;e=new E.PriceRange(e.minValue()-t,e.maxValue()+t)}const s=t.targetPriceScale;return s&&s.isLog()&&e?new E.PriceRange(s.priceToLogical(e.minValue()),s.priceToLogical(e.maxValue())):e}_titleInParts(e,t=!0,i,r,n,o){const a=[c.t(this.name(t),{context:"study"},s(783477))];let l=[];if(!r){const s=this._getMTFResolutionInputTitle();null!==s&&s.length>0&&a.push(s);l=(this.inputsInParts(e,t,i,n,o)??[]).map((e=>e.value))}return e===se.TitleDisplayTarget.StatusLine&&this._showPineVersionInStatusLine.value()&&a.push((0,u.ensureDefined)(this._metaInfo.value().pine).version),[a.join(" · "),l]}_seriesDataRangeToSave(e){return this._model.timeScale().visibleExtendedDataRange(e,0)}_getSymbolForResolve(e){return this.getSymbolString(this._getSymbolForApi(e))}_getSymbolForApi(e){return e}_getSymbolObject(e){const t={symbol:e},s=this.currency();return null!==this._currencySourceSymbolInputProperty&&null!==this._currencySourceSymbolInfo&&this._getSymbolForApi(this._currencySourceSymbolInputProperty.value())===e&&(t["currency-id"]=s),t.session=this.sessionId(),t}_onSymbolResolved(e,t,s){{const e=(0,u.ensureNotNull)(this._model.alertsWatcher());e.syncSourceAlertLabels(this);const t=this.getAllChildren();for(const s of t)e.syncSourceAlertLabels(s)}this._onCurrencyMayChange()}_onSymbolResolvingStart(e,t){}_onSymbolError(){}_setStatus(e,t){const s=this.isFailed();this._status.setValue(e),e.type===Bt.StudyStatusType.Completed?this._wasCompletedBefore=!0:e.type!==Bt.StudyStatusType.Error&&e.type!==Bt.StudyStatusType.Undefined||(this._wasCompletedBefore=!1),t||(this._statusView?.update((0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this),this._statusChanged.fire(this.status())),s!==this.isFailed()&&this._updateAlertCreationAvailable()}_onPropertiesChanged(){this._restarting||(this._inputs?this._tryChangeInputs():this._chartApi&&this._chartApi.isConnected().value()&&this.restart());const e=this._metaInfo.value();e.isTVScript&&e.TVScriptMetaInfoExprs&&!this._model.isSnapshot()&&(this._restarting?this._deferredPinePatchProps=!0:this._pinePatchProps()),this._recreatePaneViews(),(0,qt.emit)("study_properties_changed",this._id.value())}_lastNonEmptyPlotRow(e){if(!(0,te.isInteger)(e))return is.logDebug("_lastNonEmptyPlotRow: incorrect plotIndex"),null;let t=this._lastNonEmptyPlotRowCache[e]??null;if(null!==t)return t;return t=this.data().findLast(((t,s)=>void 0!==s[e]),1e3),null===t?null:(this._lastNonEmptyPlotRowCache[e]=t,t)}_onCurrencyChanged(){"alwaysOff"!==(0,Ut.currencyUnitVisibilityProperty)().value()&&this._model.fullUpdate(),this.isStarted()&&this._tryChangeInputs(),this._currencyChanged.fire()}_apiInputs(){return this.inputs({keepOptionalSymbolsEmpty:!0})}async _tryChangeInputs(){const e=this.isStarted()&&this._chartApi.isConnected().value(),t=this._allInputsAreValid(),s=(0,u.ensureDefined)((0,te.clone)(this._inputs)),i=this._apiInputs(),r=JSON.stringify(i),n=r!==JSON.stringify(this._inputs);if(e&&t)try{if(await this._allSymbolsAreResolved(),r!==JSON.stringify(this._apiInputs()))return this._tryChangeInputs()
;if(this._isStopped())return void(n&&this.disablePriceRangeReady());n&&(await this._changeInputsImpl(i,(0,u.ensureDefined)((0,te.clone)(this._inputs))),(0,u.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(this))}catch(e){is.logError(`ERROR: ${this._debugId()} _tryChangeInputs: cannot modify study, ${e}`)}else if(e&&!t&&this.stop(!0),!e&&t&&this.start(!0),n){const e=this._calcSources(),t=ms(this._metaInfo.value(),i,s);this._updateParentSources(e,t,!0),this._inputs=i}this._tagsChanged.fire()}_onCurrencyMayChange(){if(null!==this._currencySourceSymbolInputProperty){const e=this.currency();this._updateCurrencySourceSymbolInfo(),e!==this.currency()&&this._onCurrencyChanged()}}_fillPrecalculatedAutoscaleInfo(e,t,s){const i=this._metaInfo.value(),r=this.properties().childs(),n=new Set,o=i.filledAreas||[];for(let e=0;e<o.length;e++){const t=o[e];r.filledAreasStyle.childs()[t.id].childs().visible.value()&&(n.add(t.objAId),n.add(t.objBId))}return i.plots.filter((e=>!(0,K.isPlotWithTechnicalValues)(e))).filter((e=>i.isPlotForceOverlay(e.id)?s.targetPriceScale===this._model.mainSeries().priceScale():s.targetPriceScale===this.priceScale()&&!s.forceOverlayOnly)).filter((e=>n.has(e.id)||this.isPlotVisibleAt(e.id,1))).reduce(((s,i)=>this._applyPlotToPrecalculatedAutoscaleInfo(e,t,s,i)),{fields:[],useMainSeriesRange:!1,baseValueMinMax:null})}_firstSourceOrSeries(){return this._sources.value()[0]??this._series}_skipHistogramBaseOnAutoScale(){return!1}_tryCreateFormatter(e){const t=void 0===e?this.symbolSource().symbolInfo():e;return vs(this._metaInfo.value().format,this._priceScaleByProperties(),t,this.properties().childs().precision.value())}_tryCreateDefaultFormatter(e){return this._tryCreateFormatter(e)}_mergeData(e){return this._invalidateLastNonEmptyPlotRowCache(),this.data().merge(e)}_skippedTitleInputs(){return this._hideMatches.filter((e=>e.plotIds.every((e=>0===this._getPlotDisplayValue(e))))).map((e=>e.id))}_getPlotDisplayValue(e){return this.properties()?.childs()?.styles?.childs()?.[e]?.childs()?.display?.value()}_onStudyError(e){performance.clearMarks(`calculate_study_${this._studyId}`),this._handleStudyError(this._createStudyError(e)),this._enablePriceRangeReady()}_onStudyCompleted(e){if(performance.getEntriesByName(`calculate_study_${this._studyId}`).length){try{const e=performance.measure(`measure_study_${this._studyId}`,`calculate_study_${this._studyId}`);this._calculationTime.setValue(e.duration)}catch(e){is.logError("Error during measuring study calculation time")}performance.clearMarks(`calculate_study_${this._studyId}`),performance.clearMeasures(`measure_study_${this._studyId}`)}this._studyModified&&(this.clearData(),this._studyModified=!1),this._sendTelemetryCounter(this._getTelemetryObjectName()+"_loaded"),this._setStatus({type:Bt.StudyStatusType.Completed}),this._statusView?.update((0,j.sourceChangeEvent)(this.id()));const t=this._model.paneForSource(this);this._model.recalculatePane(t,(0,j.sourceChangeEvent)(this.id())),this._updateSources();const s=Lt.InvalidationMask.full()
;null!==this._model.appliedTimeFrame().value()&&s.lockVisibleTimeRangeOnResize(),this._model.invalidate(s)}_clearData(){this._data.clear()}_moveData(e){this.data().move(e)}_defaultErrorTitle(){return"Runtime error"}_incrementTurnaround(){this._turnaround="st"+ ++this._turnaroundCounter}_checkTurnaround(e){return e===this._turnaround||e===this._model.mainSeries().seriesSource().turnaround()||e===this.turnaround(!0)}_updateMaxOffsetValue(){let e=-1/0;for(const t of this._metaInfo.value().plots)e=Math.max(this.offset(t.id),e);this._maxOffset.setValue(e)}_rightOffsetToUnixTime(e){if(this._series.bars().size()>=e){const t=(0,u.ensureNotNull)(this._series.bars().lastIndex())-e;return(0,u.ensureNotNull)(this._series.bars().valueAt(t))[0]}return null}_concatPriceAxisViews(){this._priceAxisViews=[...this._priceAxisViewsBase,...this._graphicsPriceAxisViews]}_onStudyLoading(e){this._setStatus({type:Bt.StudyStatusType.Loading,startTime:Date.now()}),this._statusView?.update((0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this)}_handleStudyError(e){this.clearData(),this._setStatus(e);{const t=(0,Bt.convertStudyStatusToString)(e),s=this._getTelemetryAdditionalData(),i=t.indexOf("Command info");s.reason=i>=0?t.slice(0,i).trim():t;if(!/study in error state|the data vendor doesn\'t provide volume data for this symbol.|error in series|unsupported resolution/gi.test(s.reason?.toLowerCase()??"")){const e=this._getTelemetryObjectName();this._sendTelemetryCounter(e+"_error",s)}}this._statusView?.update((0,j.sourceChangeEvent)(this.id())),this._model.updateSource(this)}_createStudyError(e){let t;return t=(0,te.isString)(e)?{error:this._getStudyErrorText(e),title:e.includes("study_not_auth")?"Access error":this._defaultErrorTitle()}:{...e,title:e.title??this._defaultErrorTitle()},(0,Bt.createStudyError)(t,this.symbolSource().symbolInfo()?.exchange)}_updateSources(){this._model.updateSource(this),this.hasBarColorer()&&this._model.updateSource(this._model.mainSeries())}_unsubscribeToSessionId(){this._isSubscribedToSessionId&&(this.sessionIdChanged().unsubscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!1)}_onSessionIdChanged(){this.restart(!0)}_recreatePriceStep(){let e=null;const t=this._priceScaleByProperties()??this._priceScaleByMetaInfo();null!==t&&(e=1/t),this._priceStep!==e&&(this._priceStep=e,this._priceStepChanged.fire())}_recreatePlotsFormatters(e){this._plotFormatters.clear();const t=this._metaInfo.value(),s=t.format,i=this._priceScaleByProperties(),r=void 0===e?this.symbolSource().symbolInfo():e;for(const[e,n]of Object.entries(t.ohlcPlots??{}))if(n?.format){const t=vs(gs({...s,...n?.format}),i,r,this.properties().childs().precision.value());t&&this._plotFormatters.set(e,t)}for(const[e,n]of Object.entries(t.styles??{}))if(n?.format){const t=vs(gs({...s,...n?.format}),i,r,this.properties().childs().precision.value());t&&this._plotFormatters.set(e,t)}for(const e of t.plots)if((0,K.isOhlcPlot)(e)){const t=this._plotFormatters.get(e.target);t&&this._plotFormatters.set(e.id,t)}}_joinTitlesParts(e){
const t=e[1]?e[1].join(", "):"";return e[0]+(t.length>0?" ("+t+")":"")}_getMTFResolutionInputTitle(){const e=this.metaInfo();for(let t=0;t<e.inputs.length;t++){const s=e.inputs[t];if("resolution"===s.type&&s.isMTFResolution)return(0,u.ensureDefined)(this._properties.childs().inputs.child(s.id)).value()}return null}_onDataUpdate(e,t,s){this._studyModified&&(this.clearData(),this._studyModified=!1);const i=(0,N.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>i),(()=>i)).then(this._onDataUnpacked.bind(this,e,t.indexes,s)),this._ongoingDataUpdate}_allSymbolsAreResolved(){const e=this._inputSymbols(),t=[];let s=!1;for(const i of e){const e=this._getSymbolForResolve(i);if(""!==e)if(this._resolvedSymbols[e])s=!0;else{const s=this._resolveSymbol(e,i);t.push(s)}}if(0===t.length){const e=Promise.resolve();return s?e.then((()=>this._symbolsResolved.fire())):e}return Promise.all(t).catch((e=>(this._inputSymbols().includes(e)&&this.stop(!0),this._setStatus({type:Bt.StudyStatusType.Error,errorDescription:{error:rs}}),this._model.updateSource(this),Promise.reject("Invalid symbol, "+e)))).then((()=>{this._symbolsResolved.fire(),this._recheckLineToolsActuality()}))}_resolveSymbol(e,t){if(""===e)return Promise.resolve();let s=this._pendingResolveSymbols.get(e);return void 0!==s||(s=new Promise(((s,i)=>{this._onSymbolResolvingStart(e,t),this._chartApi.resolveSymbol((0,X.makeNextSymbolId)(),e,(r=>{switch(this._pendingResolveSymbols.delete(e),r.method){case"symbol_resolved":{this._setStatus({type:Bt.StudyStatusType.Undefined});const i=r.params[1];this._resolvedSymbols[e]=i,this._resolvedSymbolsByInput[t]=i,this._onSymbolResolved(e,t,i),this.invalidateTitleCache(!0),s();break}case"symbol_error":if(this._setStatus({type:Bt.StudyStatusType.Error,errorDescription:{error:r.params[1]}}),this._onSymbolError(),r.params[1]===Q.permissionDenied&&r.params[2]){if(r.params[2]!==Q.SymbolErrorPermissionDeniedReason.Symbol)return void this._resolveSymbol(r.params[2],t).then(s);if(r.params[3])return void this._resolveSymbol(r.params[3],t).then(s)}this._sendTelemetryCounter("symbol_error",Object.assign(this._getTelemetryAdditionalData(),{symbol:e,reason:r.params[1]})),i(t)}}))})),this._pendingResolveSymbols.set(e,s)),s}_recheckLineToolsActuality(){const e=this._model.paneForSource(this);null!==e&&e.sourcesByGroup().lineSourcesForAllSymbols().forEach((e=>{e.ownerSource()===this&&e.calcIsActualSymbol()}))}_sendTelemetryCounter(e,t){void 0===t&&(t=this._getTelemetryAdditionalData());const s={count:1,additional:t};ye.telemetry.sendChartReport(e,s)}_getTelemetryAdditionalData(){let e="";const t=this._metaInfo.value();return t.pine&&t.pine.version&&t.shortId.indexOf("USER")>=0&&(e="_v"+t.pine.version),{symbol:this.series().actualSymbol(),resolution:this.series().interval(),study:t.shortId+e}}_onSourceFormatterChanged(){null===this._formatter&&(null!==this._priceScale&&this._priceScale.updateFormatter(),this._formatterChanged.fire())}_onSourcePriceStepChanged(){null===this._priceStep&&this._priceStepChanged.fire()}
_bandsFirstValue(e){const t=this._metaInfo.value();if(!t.bands)return null;for(let s=0;s<t.bands.length;s++){const t=(0,u.ensureDefined)(this._properties.childs().bands).childs()[s];if(t.childs().visible.value()){const s=t.childs().value.value();if(e&&0===s)continue;if(null!==s)return s}}return null}_prepareInputs(e){(0,u.assert)(!!e,"options not set");const t=this.metaInfo(),s={},i=e.allowedInputTypes?new Set(e.allowedInputTypes):null,r=!(!e.asObject||!e.useNameAndGroupAsKey);for(let n=0;n<t.inputs.length;n++){const o=t.inputs[n];if(null!==i&&!i.has(o.type))continue;if(o.isFake&&e.skipFakeInputs)continue;if(o.isMTFResolution&&e.noResolution)continue;if(void 0!==e.displayMask&&!((0,u.ensureDefined)(o.display)&e.displayMask))continue;if(e.skipHiddenInputs&&(!e.doNotSkipHiddenWithMigrate||!o.migrate)){let t=!1;switch(o.type){case"bool":t=e.skipBooleanInputs;break;case"color":t=e.skipColorInputs;break;case"time":t=e.skipTimeInputs;break;case"text_area":t=e.skipTextareaInputs;break;default:t=Boolean(o.isHidden)}if(t)continue}if(void 0!==o.groupId&&-1!==e.skippedGroups.indexOf(o.groupId))continue;if(-1!==e.skippedInputs.indexOf(o.id))continue;const a=this._prepareInput(o,e);if("symbol"===o.type&&e.skipOptionalEmptySymbolInputs&&""===a)continue;let l;r&&(l=(0,f.getStudyInputName)(o),void 0!==l&&l in s&&(l=void 0)),s[l||o.id]=(0,te.clone)(a)}return s}_prepareInputValue(e,t){const s=e.id,i=this._properties.childs();if(t.valuesAsIsFromProperties)return i.inputs.childs()[s].value();const r=this._metaInfo.value();if("symbol"===e.type){const r=t&&t.symbolsForDisplay,n=i.inputs.childs()[s].value();let o=r?n:this._getSymbolForApi(n),a=this._resolvedSymbols?.[this._getSymbolForResolve(o)]??null;if(""===o&&e.optional){if(t&&t.keepOptionalSymbolsEmpty)return o;o=this._model.mainSeries().symbol(),a=this._model.mainSeries().symbolInfo()}if(r)if(a)if(as){switch(this._model.mainSeries().symbolTextSourceProxyProperty().value()){case"description":o=a.description;break;case"ticker-and-description":o=`${a.name}, ${a.description}`;break;case"ticker":o=a.name}}else o=(0,Gt.symbolTitle)(a,t.noExchanges);else us&&(o="");else a&&(o=a.ticker||a.full_name),!this.isPine()&&t&&t.symbolsForChartApi&&(o=this.getSymbolString(o));return o}if("bar_time"===e.type){let e=i.inputs.childs()[s].value();if(e<0){const t=this._rightOffsetToUnixTime(-e);e=t&&t>=0?t:e}return e}if(r.isTVScript||r.pine){if("text"===s)return r.defaults.inputs?.text??"";if("pineId"===s)return r.scriptIdPart;if("pineVersion"===s)return r.pine?r.pine.version:"-1";if("color"===e.type&&r.isRGB){const e=i.inputs.childs()[s].value();return(0,O.colorToInteger)(e)}if("price"===e.type){const e=i.inputs.childs()[s].value();return t.priceInputsForDisplay?this.formatter().format(e):e}}return i.inputs.childs()[s].value()}_getStudyIdWithLatestVersion(){return H.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo())}_debugId(){const e=[];this._studyId&&e.push(this._studyId);const t=this._metaInfo.value();return e.push(t.fullId),e.push(t.description),JSON.stringify({study:e})}
_hasAvailableAlertPlots(){if(null===this._alertMetaInfo())return!1;return this.stateForAlert().plots.length>0}_hasAlertConditions(){const e=this._alertMetaInfo();if(null===e)return!1;if(e.plots.some(K.isAlertConditionPlot))return!0;const t=this.stateForAlert();return Boolean(t.alerts&&t.alerts.conditions)}_hasAlertFunction(){const e=this._alertMetaInfo();return Boolean(null!==e&&e.hasAlertFunction)}async _updateParentSources(e,t,s){if(this._sources.value().forEach((e=>e.unsetChild(this))),s&&await Promise.all(e.map((e=>e.isStarted()?Promise.resolve():e.start(!1,!0)))),e.forEach((e=>e.setChild(this))),this._setSources(e),this._recreatePriceFormattingDependencies(),0!==t&&this._sources.value().length<=1){const e=this._firstSourceOrSeries(),t=this._priceScale,s=(0,u.ensureNotNull)(e.priceScale());if(t!==s){const t=this._model.paneForSource(this),i=(0,u.ensureNotNull)(this._model.paneForSource(e));t===i&&i.move(this,s,!0)}}}_calcSources(){const e=this._properties.childs().inputs.state();return H.StudyMetaInfo.getSourceIdsByInputs(this._metaInfo.value().inputs,e).map((e=>{if("high"===e||"open"===e||"low"===e||"close"===e||"hl2"===e||"ohl3"===e||"ohlc4"===e)return null;return this._model.allStudies().find((t=>t.canHaveChildren()&&t.id()===e))??null})).filter(te.notNull)}_isStopped(){return!this.isStarted()}_onDataUnpacked(e,t,s,i){if(this._isDestroyed)return;"nochange"!==t&&this._processPlotOffsets(i),this._transformData(e);const r=this._mergeData(e);null!==i&&(i.indexes_replace?((0,u.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==i.graphicsCmds&&this._graphics.processCommands(i.graphicsCmds))),this._onDataUpdated(e,i,t,r&&r.index),this.priceRangeReady()||this._enablePriceRangeReady(),this._dataUpdated.fire(s,!1,r)}_processPlotOffsets(e){if(e&&e.indexes_replace)return;const t=this._serverPlotOffsets.value();this._serverPlotOffsets.setValue(e&&e.offsets||{}),(0,i.default)(t,this._serverPlotOffsets.value())||this.updateAllViews((0,j.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._updateMaxOffsetValue()}_applyPlotToPrecalculatedAutoscaleInfo(e,t,s,i){const r=i.id,n=this._properties.childs().styles.childs()[r],o=(0,K.isShapesPlot)(i)||(0,K.isCharsPlot)(i);s.useMainSeriesRange=s.useMainSeriesRange||(0,K.isArrowsPlot)(i);let a=(0,K.isLinePlot)(i)||(0,K.isOhlcPlot)(i);if(o){const e=(0,u.ensureDefined)(n).childs().location.value(),t=[U.MarkLocation.Absolute,U.MarkLocation.Top,U.MarkLocation.Bottom].indexOf(e)<0;s.useMainSeriesRange=s.useMainSeriesRange||o&&t,a=a||e===U.MarkLocation.Absolute}if(!a)return s;const l={name:r,offset:this.offset(r)},h=n.childs().plottype.value();if(!this._skipHistogramBaseOnAutoScale()&&[K.LineStudyPlotStyle.Histogram,K.LineStudyPlotStyle.Columns,K.LineStudyPlotStyle.Area].indexOf(h)>=0){const i=(this._metaInfo.value().styles??{})?.[r]?.histogramBase;if(void 0===i)return s;const n=this.data().minMaxOnRangeCached(e,t,[l]);return(0,te.isNumber)(i)&&null!==n&&(s.baseValueMinMax=(0,L.mergeMinMax)(s.baseValueMinMax,{min:i,
max:i}),s.baseValueMinMax=(0,L.mergeMinMax)(s.baseValueMinMax,n)),s}return s.fields.push(l),s}async _onSourceInputChanged(){if(!this.isStarted()){const e=this._calcSources();{const t=1===e.length&&e[0]!==this._sources.value()[0]?1:0;this._updateParentSources(e,t,!1)}}}_buildInputs(e){(0,u.assert)(!!e,"options not set");let t={};try{t=this._prepareInputs(e)}catch(e){is.logWarn("Failed to prepare study inputs: "+e)}if(e.asObject){const e={};return Object.keys(t).forEach((s=>{null!=t[s]&&(e[s]=t[s])})),e}{const e=[];return Object.keys(t).forEach((s=>{null!=t[s]&&e.push(t[s])})),e}}_prepareInput(e,t){const s=this._prepareInputValue(e,t);return!e.isFake||t.fakeInputsForDisplay||t.onlyAtomValues?s:{v:s,f:!0,t:e.type}}_plotsForAlert(){return(0,P.plotsForAlert)(this.metaInfo(),this.offset.bind(this))}_formatterStateForAlert(){try{const e=this.formatter();return y.FormattersSerializer.isSerializable(e)?y.FormattersSerializer.serialize(e):null}catch{return null}}_calcIsActualInterval(){const e=this._isActualInterval;this._isActualInterval=(0,Et.isActualInterval)(this._series.intervalObj().value(),this._properties.childs().intervalsVisibilities),e!==this._isActualInterval&&(this._onIsActualIntervalChange.fire(),this._visibleChanged(),this.processHibernate())}_visibleChanged(){this._series.invalidateBarColorerCache()}_getNonPriceParent(){const e=this._sources.value();for(const t of e)if(t instanceof bs){const e=t.metaInfo();return e.is_price_study&&"Compare@tv-basicstudies"!==e.id?t._getNonPriceParent():t}return null}_updateInputValue(e,t){const s=this._properties.childs().inputs.childs();if(s[t.id])if("price"===t.type)s[t.id].setValue(e.price);else if("time"===t.type){const i=this._model.timeScale().indexToTimePoint(e.index);null!==i&&s[t.id].setValue(1e3*i)}}_initializeStudyInputsPaneViews(){const e=(0,v.editableStudyInputs)(this._metaInfo.value().inputs);if(0===e.length)return;const t={convertPriceToCoordinate:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const s=this.firstValue();if(null!==s)return t.priceToCoordinate(e,s)}return null},formatPrice:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const s=this.firstValue();if(null!==s)return t.formatPrice(e,s)}return""},getInputValue:e=>this._properties.childs().inputs.child(e)?.value()??null,isSelected:()=>this._model.selection().isSelected(this),isHovered:()=>this===this._model.hoveredSource()};Promise.all([s.e(62183).then(s.bind(s,880474)),s.e(62183).then(s.bind(s,31890)),s.e(62183).then(s.bind(s,472057)),s.e(62183).then(s.bind(s,43481))]).then((s=>{const[i,r,n,o]=s;this._inputsAnchorsPaneView=new i.StudyInputsAnchorsPaneView(e,this._model,t);const a=e.filter((e=>!Array.isArray(e)));this._inputsLinesPaneView=new r.StudyInputsLinesPaneView(a,this._model,t);let l=!1;e.forEach((e=>{if(Array.isArray(e)){const s="time"===e[0].type?e[0]:e[1],i="price"===e[0].type?e[0]:e[1];this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(s,this._model,t.getInputValue)),this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(i,t)),l=!0
}else"time"===e.type?this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(e,this._model,t.getInputValue)):(this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(e,t)),l=!0)})),l&&this.formatterChanged().subscribe(this,this.invalidateTitleCache)}))}_updateCurrencySourceSymbolInfo(){}_initializeCurrencySource(){const e=this.metaInfo(),t="symbolInputSymbolSource"===e.symbolSource?.type&&e.symbolSource?.inputId,s=e.inputs.find((e=>e.id===t));if("string"==typeof t&&"symbol"===s?.type&&e.is_price_study){const e=this._properties.childs().inputs.childs()[t];void 0!==e&&(e.subscribe(this,this._onCurrencyMayChange),this._currencySourceSymbolInputProperty=e)}}_recreatePaneViews(){this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this._createViews(),this.recalculate(),this.updateAllViews((0,j.sourceChangeEvent)(this.id()))}_pinePatchProps(){this._deferredPinePatchProps=!1;const e=this._prepareInputs(os);if(!this._areStudyInputsModified(e))return;this._oldStudyInputs=e;const t=new H.StudyMetaInfo(this._metaInfo.value().state());this._abortPatchPropsController.abort(),this._abortPatchPropsController=new AbortController;const s=(0,V.patchPropertiesAsync)(this._properties,t,e,this._abortPatchPropsController.signal,this._previousPatchMap),i=this._allSymbolsAreResolved(),r=this._propertiesPatched=new Promise((e=>{const n=()=>{r===this._propertiesPatched?e():this._propertiesPatched.then(e)};Promise.all([s,i]).then((()=>{this._metaInfo.setValue(t),n(),this._isDestroyed||(this._createViews(),this.recalculate(),this.updateAllViews((0,j.sourceChangeEvent)(this.id())),this.invalidateTitleCache())})).catch((e=>{n(),is.logError(`ERROR: ${this._debugId()} pine inputs patching failed, reason: ${e}`)}))}))}_areStudyInputsModified(e){if(0===Object.keys(e).length)return!1;if(void 0===this._oldStudyInputs)return!0;const t=Object.keys(this._oldStudyInputs);(0,u.assert)(t.length===Object.keys(e).length,"keys quantity should be equal");for(const s of t)if((0,u.assert)(e.hasOwnProperty(s),`key '${s}' should exist in study inputs`),(0,u.ensureDefined)(this._oldStudyInputs)[s]!==e[s])return!0;return!1}_onVisibleTimeRangeInputsChanged(e){null!==e?this._updateVisibleTimeRangeInputs(e):this.isStarted()&&this._chartApi.isConnected().value()&&this.stop(!0)}_updateVisibleTimeRangeInputs(e,t=!0){const s={first_visible_bar_time:e.firstVisibleBarTime,last_visible_bar_time:e.lastVisibleBarTime,subscribeRealtime:e.subscribeRealtime},i=this.metaInfo().inputs,r=[];for(const e of i)s.hasOwnProperty(e.id)&&r.push(e.id);const n=this.properties().childs().inputs;for(const e of r)n.childs()[e].setValueSilently(s[e]);t&&r.length>0&&n.fireChanged()}_getStudyErrorText(e){switch(e.match(/^study_not_auth:(.*)?@.*/)?.[1]){case"Script":case"StrategyScript":return"This script is invite-only. To request access, please contact its author.";case"VbPSessions":case"VbPPeriodic":case"VbPVisible":return"Volume Profile indicator available only on our upgraded plans."}return e.split(":",2)[0]}_priceScaleByProperties(){
if("default"===this.properties().childs().precision.value())return null;const e=parseInt(this.properties().childs().precision.value());return isFinite(e)?Math.pow(10,e):null}_priceScaleByMetaInfo(){const e=this.metaInfo().format,t="inherit"!==e.type?e.precision:void 0,s=(0,te.isNumber)(t)?Math.pow(10,t):void 0;if("price"===e.type||"percent"===e.type)return s||100;if("volume"===e.type){if(void 0===e.precision){const e=this.series().symbolInfo();if(null!==e&&(0,te.isNumber)(e.volume_precision))return Math.pow(10,e.volume_precision)}return 1}return"inherit"===e.type||is.logWarn("Unsupported format type: "+e.type),null}_inputSymbols(){return this.metaInfo().inputs.filter((e=>"symbol"===e.type)).map((e=>(0,u.ensureDefined)(this._properties.childs().inputs.child(e.id)).value()))}_studySpec(e){const t=this._metaInfo.value();return{id:t.id,child:e??this.isChildStudy(),fundamental:(0,ve.isFundamentalStudyMetaInfo)(t)}}_onFormatterPropsChanged(){this._recreatePriceFormattingDependencies()}_setSources(e){this.invalidateTitleCache(),this._sources.setValue(e),this._onParentSourcesChanges.fire()}}},375142:(e,t,s)=>{s.d(t,{plotShapesData:()=>r});var i=s(444372);const r={shape_arrow_down:{guiName:i.t(null,void 0,s(734247)),id:"shape_arrow_down",paneRendererClass:"PaneRendererArrowDown",pineName:"shape.arrowdown",icon:"arrow_down"},shape_arrow_up:{guiName:i.t(null,void 0,s(777231)),id:"shape_arrow_up",paneRendererClass:"PaneRendererArrowUp",pineName:"shape.arrowup",icon:"arrow_up"},shape_circle:{guiName:i.t(null,void 0,s(191944)),id:"shape_circle",paneRendererClass:"PaneRendererCircleShape",pineName:"shape.circle",icon:"circle"},shape_cross:{guiName:i.t(null,void 0,s(506969)),id:"shape_cross",paneRendererClass:"PaneRendererCrossShape",pineName:"shape.cross",icon:"cross"},shape_diamond:{guiName:i.t(null,void 0,s(415179)),id:"shape_diamond",paneRendererClass:"PaneRendererDiamond",pineName:"shape.diamond",icon:"diamond"},shape_flag:{guiName:i.t(null,void 0,s(333885)),id:"shape_flag",paneRendererClass:"PaneRendererFlagShape",pineName:"shape.flag",icon:"flag"},shape_label_down:{guiName:i.t(null,void 0,s(785924)),id:"shape_label_down",paneRendererClass:"PaneRendererLabelDown",pineName:"shape.labeldown",icon:"label_down"},shape_label_up:{guiName:i.t(null,void 0,s(649857)),id:"shape_label_up",paneRendererClass:"PaneRendererLabelUp",pineName:"shape.labelup",icon:"label_up"},shape_square:{guiName:i.t(null,void 0,s(66205)),id:"shape_square",paneRendererClass:"PaneRendererSquare",pineName:"shape.square",icon:"square"},shape_triangle_down:{guiName:i.t(null,void 0,s(676152)),id:"shape_triangle_down",paneRendererClass:"PaneRendererTriangleApexDown",pineName:"shape.triangledown",icon:"triangle_down"},shape_triangle_up:{guiName:i.t(null,void 0,s(21236)),id:"shape_triangle_up",paneRendererClass:"PaneRendererTriangleApexUp",pineName:"shape.triangleup",icon:"triangle_up"},shape_xcross:{guiName:i.t(null,void 0,s(211316)),id:"shape_xcross",paneRendererClass:"PaneRendererXCross",pineName:"shape.xcross",icon:"x_cross"}}},321490:(e,t,s)=>{s.d(t,{
extractTitleParts:()=>n,studyIdsWithNoInputsInTitle:()=>r});var i=s(657619);const r=new Set(["Volume@tv-basicstudies","AnchoredVWAP@tv-basicstudies"]);function n({title:e,studyId:t,hasInputs:s,description:n}){if(!s)return[e];let o;return n?o=function(e,t){return e.replace(t,"").trim()||void 0}(e,n):[n,o]=function(e){if(")"!==e[e.length-1])return[e];let t=0;for(let s=e.length-1;s>=0;s--)if(")"===e[s])t++;else if("("===e[s]&&(t--,0===t&&s>1&&" "===e[s-1]))return[e.slice(0,s-1),e.slice(s)];return[e]}(e),!o||r.has((0,i.extractStudyId)(t))?[n]:[n,o]}},499312:(e,t,s)=>{function i(e,t){for(const s of t.keys())e.add(s)}s.d(t,{addToSet:()=>i})}}]);