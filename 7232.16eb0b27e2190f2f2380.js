"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[7232],{866249:(e,t,o)=>{o.d(t,{calculateFontSize:()=>c,getPreparedTextMeasurements:()=>a});var r=o(650151),i=o(837462),s=o(960433),l=o(910282),n=o(660439);function a(e,t,o,r){if(e.size)return e;for(let i=r.minAllowedFontSize;i<=r.maxAllowedFontSize;i++){const l=o.get(i)??new s.TextWidthCache;o.set(i,l),e.set(i,d(t,i,l,r.maxSymbols))}return e}function d(e,t,o,r){e.font=(0,i.makeFont)(t,l.CHART_FONT_FAMILY);const s=new Map;for(let t=1;t<=r;t++)s.set(t,o.measureText(e,new Array(t+1).join("0")));const n=o.yMidCorrection(e,"0"),a=o.getMetrics(e,"0");return{widths:s,actualFontHeight:a.fontBoundingBoxDescent+a.fontBoundingBoxAscent,yCorrection:n}}function c(e,t,o,i,s,l){const d=a(s,o,i,l),{maxAllowedFontSize:c,minAllowedFontSize:h,fontSizeCoeff:u,horzCellMinMargin:p,horzCellMarginsCoeff:m}=l;let g=c;const _=e=>h+e;for(const o of e){if(!g)break;const{box:e,label:i}=o,s=Math.floor(e.max.x-e.min.x)/t.horizontalPixelRatio,l=(e.max.y-e.min.y)/t.verticalPixelRatio,a=Math.round(l*u);if(a<h){g=0;break}g>a&&(g=a);const c=_((0,n.lowerboundExt)(_,i,((e,t)=>{var o,i;return(o=e,i=t,(0,r.ensureDefined)(d.get(o)?.widths.get(i.length)))<s-Math.max(p,2*m*_(e))}),0,g-h+1));if(c<g+1&&(g=c-1),g<h){g=0;break}}return g?{fontSize:g,yMidCorrection:(S=g,(0,r.ensureDefined)(d.get(S)?.yCorrection))}:null;var S}},265046:(e,t,o)=>{function r(e,t){return{start:Math.min(e.start,t.start),end:Math.max(e.end,t.end)}}function i(e){return void 0===e?e:Array.from(e)}o.d(t,{arrayFromSet:()=>i,mergeTpoPriceRanges:()=>r})},475319:(e,t,o)=>{o.d(t,{rowTitles:()=>w});var r=o(378338),i=o(418450);const s=r.t(null,{context:"TPO Summary row title, high-low range"},o(48210)),l=r.t(null,{context:"TPO Summary row title, value area range"},o(956078)),n=r.t(null,{context:"TPO Summary row title, abbr Volume area high"},o(848924)),a=r.t(null,{context:"TPO Summary row title, abbr Volume area low"},o(201788)),d=r.t(null,{context:"TPO Summary row title, abbr Point of control"},o(159888)),c=r.t(null,{context:"TPO Summary row title"},o(740497)),h=r.t(null,{context:"TPO Summary row title"},o(111485)),u=r.t(null,{context:"TPO Summary row title"},o(409293)),p=r.t(null,{context:"TPO Summary row title"},o(105012)),m=r.t(null,{context:"TPO Summary row title"},o(599855)),g=r.t(null,{context:"TPO Summary row title, abbr Initial Balance High"},o(290618)),_=r.t(null,{context:"TPO Summary row title, abbr Initial Balance Low"},o(106740)),S=r.t(null,{context:"TPO Summary row title, abbr Initial Balance Range"},o(273646)),w=[{translatedString:new i.TranslatedString("HL Range",s),propName:"hlRange"},{translatedString:new i.TranslatedString("VA range",l),propName:"vaRange"},{translatedString:new i.TranslatedString("VAH",n),propName:"vahPrice"},{translatedString:new i.TranslatedString("VAL",a),propName:"valPrice"},{translatedString:new i.TranslatedString("POC",d),propName:"pocPrice"},{translatedString:new i.TranslatedString("Total volume",c),propName:"totalVolume"},{
translatedString:new i.TranslatedString("Total TPO",h),propName:"tpoCountTotal"},{translatedString:new i.TranslatedString("TPO Above POC",u),propName:"tpoCountAbovePoc"},{translatedString:new i.TranslatedString("TPO Below POC",p),propName:"tpoCountBelowPoc"},{translatedString:new i.TranslatedString("Rotation factor",m),propName:"rotationFactor"},{translatedString:new i.TranslatedString("IB high",g),propName:"initialBalanceHigh"},{translatedString:new i.TranslatedString("IB low",_),propName:"initialBalanceLow"},{translatedString:new i.TranslatedString("IB range",S),propName:"initialBalanceRange"}]},407232:(e,t,o)=>{o.d(t,{TpoStudyBase:()=>re,extendingInputIds:()=>X});var r=o(283873),i=o(650151),s=o(444372),l=o(735566),n=o(418450),a=o(422063),d=o(631114),c=o(905520),h=o(870855),u=o(68777),p=o(553407);const{colorColdGray200:m,colorColdGray900:g,colorDeepBlueA200:_,colorDeepBlueA700:S,colorGrapesPurpleA200Alpha15:w,colorSkyBlue400Alpha50:C,colorSkyBlue400Alpha75:v}=p.colors,f={poc:[g,m],poorHigh:[S,_],poorLow:[S,_],singleprints:[w,w],vah:[g,m],val:[g,m],values:[g,m],vpVah:[g,m],vpVal:[g,m],vpPoc:[g,m],volumeColor:[C,C],valueAreaColor:[v,v]};var y=o(86441),T=o(837462),x=o(910282);function M(e,t){const o=e.backgroundTopColor().value(),r=e.backgroundColor().value(),i=t.model().panes().indexOf(t),s=t.model().mainPane();return i>(s?t.model().panes().indexOf(s):0)?r:o}var P=o(534328),A=o(51196),b=o(708162),R=o(934026),k=o(731974),B=o(765935),z=o(320994),I=o(338242),V=o(688857);const F={textColor:p.colors.colorColdGray200,hoveredRowColor:"#B2B5BE33"},N={textColor:p.colors.colorColdGray900,hoveredRowColor:"#5D606B26"},D={cellHeight:20,horzCellMinMargin:4,minAllowedFontSize:8,maxAllowedFontSize:12,fontSizeCoeff:.6,horzCellMarginsCoeff:.1,maxSymbols:40,legendLeftPadding:9,legendFontSize:13},{cellHeight:O}=D;function*H(e,{bitmapSize:{width:t}}){for(let o=0;o<e.length;++o)yield[o,(0,y.box)((0,y.point)(0,o*O),(0,y.point)(t,(o+1)*O))]}class L extends z.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=null,this._data=e}hitTest(e,t){const o=this._data;if(!o?.columns.length)return null;for(const[r,i]of H(o.columns[0].rows,t))if((0,R.pointInBox)(e,i))return new k.HitTestResult(k.HitTarget.Regular,{activeItem:r,cursorType:B.PaneCursorType.Default});return null}_drawImpl(e){const t=this._data;if(!t?.columns.length)return;const{context:o,bitmapSize:r,verticalPixelRatio:i,horizontalPixelRatio:s}=e,l=t.isDark?F:N,n=D.cellHeight,a=Math.round(n*i);void 0!==t.hoveredRow&&(o.fillStyle=l.hoveredRowColor,o.fillRect(0,t.hoveredRow*a,r.width,a)),o.strokeStyle=t.vertBordersColor,t.columns.forEach((e=>{(0,I.drawVerticalLine)(o,e.left,0,r.height)}));{const[{rows:{length:e}}]=t.columns;o.strokeStyle=t.horzBordersColor;for(let t=1;t<=e;++t)(0,I.drawHorizontalLine)(o,t*a,0,r.width)}o.fillStyle=l.textColor,o.textBaseline="middle",o.font=(0,T.makeFont)(t.fontSize,x.CHART_FONT_FAMILY);const d=t.columns.length-1;(0,V.drawScaled)(o,s,i,(()=>{t.columns.forEach(((e,r)=>{const[i,l]=[e.left,e.right].map((e=>Math.round(e/s))),a=l-i,c=r===d
;e.rows.forEach(((e,r)=>{o.measureText(e).width>a-2*D.horzCellMinMargin?c?(o.textAlign="left",o.fillText(e,i+D.horzCellMinMargin,r*n+n/2)):(o.save(),o.textAlign="left",o.beginPath(),o.rect(i+D.horzCellMinMargin,r*n,a-2*D.horzCellMinMargin,n),o.clip(),o.fillText(e,i+D.horzCellMinMargin,r*n+n/2),o.restore()):(o.textAlign="center",o.fillText(e,(i+l)/2,r*n+n/2+t.yMidCorrection))}))}))}))}}var $=o(265046),E=o(475319),W=o(866249),G=o(885935),U=o(820807);const K=s.t(null,{context:"TPO chart"},o(186330));class Y extends U.MediaCoordinatesPaneRenderer{constructor(e){super(),this._data=null,this._data=e}setData(e){this._data=e}hitTest(){return null}_drawImpl(e){const t=this._data;if(!t)return;const o=t.isDark?F:N,r=e.context;r.fillStyle=o.textColor,r.textBaseline="middle",r.font=t.font,r.fillText(K,D.legendLeftPadding,e.mediaSize.height/2+t.yMidCorrection)}}const J=new Map;class j{constructor(e,t){this._renderer=new b.CompositeRenderer,this._legendRenderer=null,this._invalidated=!0,this._textWidthCachesMap=new Map,this._study=e,this._model=t,this._textWidthCacheCanvas=(0,i.ensureNotNull)(document.createElement("canvas")),this._textWidthCacheCanvasCtx=(0,i.ensureNotNull)(this._textWidthCacheCanvas.getContext("2d"))}update(){this._invalidated=!0}renderer(e){return this._invalidated&&(this._updateRenderer(e),this._invalidated=!1),this._renderer}makeSureIsUpdated(e){this._invalidated&&(this._updateRenderer(e),this._invalidated=!1)}_updateRenderer(e){this._renderer.clear();const t=this._model.dataSourceForId(G.tpoSummaryDataSourceId);if(!t)return;const o=(0,i.ensureNotNull)(this._model.paneForSource(t)),r=M(this._model,o),s=o.collapsed().value()&&!o.maximized().value(),l=(0,P.isColorDark)(r);if(s){const e=(0,W.getPreparedTextMeasurements)(J,this._textWidthCacheCanvasCtx,this._textWidthCachesMap,D),t={isDark:l,font:(0,T.makeFont)(D.legendFontSize,x.CHART_FONT_FAMILY),yMidCorrection:e.get(D.legendFontSize)?.yCorrection??0};return this._legendRenderer||(this._legendRenderer=new Y(t)),this._legendRenderer.setData(t),void this._renderer.append(this._legendRenderer)}const n=this._study.graphics(),a=this._model.timeScale();if(!a.logicalRange())return;const d=new A.VolumeFormatter,c=this._model.mainSeries().properties().childs().tpoStyle.childs(),h=c.summary.childs().infoBlocks.childs(),u=c.levels.childs().initialBalanceRange.childs(),p=this._model.mainSeries().formatter(),m=e=>p.format(e),g=[],_=.5*a.barSpacing();for(const[t,o]of n.tpos()){const r=n.tpoSummaryInfo().get(t);Array.from(o).sort(((e,t)=>e.firstBarTime-t.firstBarTime)).forEach((o=>{const i=Array.from(r?.get(o.id)??[]),s=i[i.length-1];if(!s)return;const{initialBalanceHigh:l,initialBalanceLow:c,initialBalanceRange:p}=h,S={vahPrice:m(s.vahPrice),valPrice:m(s.valPrice),pocPrice:m(s.pocPrice)},w=l.childs().visible.value(),C=c.childs().visible.value(),v=p.childs().visible.value();if(w||C||v){const e=(0,$.arrayFromSet)(n.tpoBlockSets().get(t)?.get(o.id));if(void 0!==e){const t=this._study.calculateInitialBalancePriceRange(e,o.priceRange,u);S.initialBalanceHigh=t?m(t.end):"",
S.initialBalanceLow=t?m(t.start):"",S.initialBalanceRange=t?m(t.end-t.start):""}}S.rotationFactor=s.rotationFactor.toString(),S.hlRange=m(s.hlRange),S.vaRange=m(s.vaRange),S.totalVolume=d.format(s.totalVolume),S.tpoCountTotal=s.tpoCountTotal.toString(),S.tpoCountAbovePoc=s.tpoCountAbovePoc.toString(),S.tpoCountBelowPoc=s.tpoCountBelowPoc.toString();const f=E.rowTitles.map((e=>e.propName)).filter((e=>h[e].childs().visible.value())).map((e=>S[e])),y=a.indexToCoordinate(o.firstBarTime)-_,T=Math.round(y*e.horizontalPixelRatio),x=a.indexToCoordinate(o.lastBarTime)+_,M=Math.round(x*e.horizontalPixelRatio);g.push({left:T,right:M,rows:f})}))}const S=this._model.properties().childs().paneProperties.childs(),w={hoveredRow:this._model.hoveredSource()===t?this._model.lastHittestData()?.activeItem:void 0,columns:g,isDark:l,vertBordersColor:S.vertGridProperties.childs().color.value(),horzBordersColor:S.horzGridProperties.childs().color.value()},C=(0,W.calculateFontSize)(function*(e,t){for(let o=0;o<e.columns.length-1;o++){const r=e.columns[o];for(let e=0;e<r.rows.length;e++){const o=r.rows[e],i=e*t,s=(e+1)*t;yield{label:o,box:(0,y.box)((0,y.point)(r.left,i),(0,y.point)(r.right,s))}}}}(w,D.cellHeight*e.verticalPixelRatio),e,this._textWidthCacheCanvasCtx,this._textWidthCachesMap,J,D)||{fontSize:D.minAllowedFontSize,yMidCorrection:0};this._renderer.append(new L({...w,...C}))}}class Z extends z.BitmapCoordinatesPaneRenderer{constructor(){super(...arguments),this._data=null}setData(e){this._data=e}hitTest(e,t){const o=this._data;if(!o?.rowTitles.length)return null;for(const[r,i]of H(o.rowTitles,t))if((0,R.pointInBox)(e,i))return new k.HitTestResult(k.HitTarget.Regular,{activeItem:r,cursorType:B.PaneCursorType.Default});return null}_drawImpl(e){const t=this._data;if(null===t)return;const{context:o,bitmapSize:r,verticalPixelRatio:i,horizontalPixelRatio:s,mediaSize:l}=e,n=t.isDark?F:N,a=D.cellHeight,d=Math.round(a*i);void 0!==t.hoveredRow&&(o.fillStyle=n.hoveredRowColor,o.fillRect(0,t.hoveredRow*d,r.width,d)),o.strokeStyle=t.borderColor,t.rowTitles.forEach(((e,t)=>{const i=(t+1)*d;(0,I.drawHorizontalLine)(o,i,0,r.width)})),o.fillStyle=n.textColor,o.textBaseline="middle",o.font=(0,T.makeFont)(t.fontSize,x.CHART_FONT_FAMILY),(0,V.drawScaled)(o,s,i,(()=>{t.rowTitles.forEach(((e,r)=>{let i;if("right"===t.align)i=D.horzCellMinMargin;else{const t=o.measureText(e).width;i=l.width-t-D.horzCellMinMargin}o.fillText(e,i,r*a+a/2+t.yMidCorrection)}))}))}}var q=o(960433);class Q{constructor(e){this._renderer=new Z,this._widthsCache=new q.TextWidthCache,this._model=e,this._textMeasureCanvas=document.createElement("canvas")}destroy(){this._textMeasureCanvas.remove()}renderer(){return this._renderer}update(){const e=this._model.mainSeries().priceScale(),t=this._model.properties().childs().paneProperties.childs(),o=this._model.mainPane(),r=this._model.dataSourceForId(G.tpoSummaryDataSourceId);if(e&&o&&r){const s=(0,i.ensureNotNull)(this._model.paneForSource(r)),l=M(this._model,s),n=(0,P.isColorDark)(l),a=o.priceScalePosition(e);if("overlay"!==a){
const e=(0,i.ensureNotNull)(this._textMeasureCanvas.getContext("2d"));e.font=(0,T.makeFont)(D.maxAllowedFontSize,x.CHART_FONT_FAMILY),this._renderer.setData({hoveredRow:this._model.hoveredSource()===r?this._model.lastHittestData()?.activeItem:void 0,rowTitles:this._visibleTitles(),align:a,isDark:n,fontSize:D.maxAllowedFontSize,borderColor:t.horzGridProperties.childs().color.value(),yMidCorrection:this._widthsCache.yMidCorrection(e,"ABC")})}}}optimalWidth(){const e=(0,i.ensureNotNull)(this._textMeasureCanvas.getContext("2d"));return e.font=(0,T.makeFont)(D.maxAllowedFontSize,x.CHART_FONT_FAMILY),this._visibleTitles().reduce(((t,o)=>Math.max(t,this._widthsCache.measureText(e,o))),0)+2*D.horzCellMinMargin}_visibleTitles(){const e=this._model.mainSeries().properties().childs().tpoStyle.childs().summary.childs().infoBlocks.childs();return E.rowTitles.filter((t=>e[t.propName].childs().visible.value())).map((e=>e.translatedString.translatedText()))}}const X=["extendPoorLow","extendPoorHigh","extendPOC","extendTpoVah","extendTpoVal","extendVolumePoc","extendVolumeVah","extendVolumeVal","extendSingleprints"],ee=(0,l.getLogger)("Chart.TpoStudyBase");class te extends a.UndoCommand{constructor(e,t,r){super(new n.TranslatedString("TPO Reset all splits and merges",s.t(null,void 0,o(602966)))),this._model=e,this._id=t,this._splitsAndMerges=r}redo(){this._study().setSplitsAndMerges({})}undo(){this._study().setSplitsAndMerges(this._splitsAndMerges)}_study(){return(0,i.ensureNotNull)(this._model.dataSourceForId(this._id))}}function oe(e,t){return t<e}class re extends d.Study{constructor(e,t,o,r,i,s,l,n=te){X.forEach((e=>t.removeExcludedKey(`inputs.${e}`,1))),super(e,t,o,r,i,s),this._autoTickPerRowData=null,this._splitsAndMerges={},this._histogramIsTooLargeCounter=0,this._lastResolvedProName=null,this._onSeriesCompletedChanged=e=>{e&&(this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._tryCalculateTickPerRow())},this._summaryPaneView=new j(this,e),this._widgetSideAreaView=new Q(e),this._seriesCompleted=(0,u.combine)((e=>h.seriesReadyStatuses.has(e.seriesStatus)),e.mainSeries().compositeStatusVW().weakReference()),this._chartStyleMode=!!l,l&&this._properties.setNameInOwner(""),this._resetAllSplitsUndoCommandCtor=n,t.childs().styles.hasChild("splitByBlocks")||t.childs().styles.addChild("splitByBlocks",new c.Property(!1)),t.childs().styles.hasChild("splitByBlocksMode")||t.childs().styles.addChild("splitByBlocksMode",new c.Property(0));const a="graphics.tpoLevels.tpo",d="graphics.tpoVolumeRows.tpo";t.setThemedColors([{path:`${a}.tpoPoc.color`,colors:f.poc},{path:`${a}.tpoPoorHigh.color`,colors:f.poorHigh},{path:`${a}.tpoPoorLow.color`,colors:f.poorLow},{path:`${a}.tpoSingleprints.color`,colors:f.singleprints},{path:`${a}.tpoVah.color`,colors:f.vah},{path:`${a}.tpoVal.color`,colors:f.val},{path:`${a}.volumeVah.color`,colors:f.vpVah},{path:`${a}.volumeVal.color`,colors:f.vpVal},{path:`${a}.volumePoc.color`,colors:f.vpPoc},{path:`${d}.valuesColor`,colors:f.values},{path:`${d}.colors.nonVa`,colors:f.volumeColor},{
path:`${d}.colors.va`,colors:f.valueAreaColor}]);const p=e.mainSeries(),m=this._properties.childs().inputs.childs();if(this.splitMergeSupported()){p.symbolResolved().subscribe(this,this._applySplitAndMerges),p.properties().childs().symbol.subscribe(this,this._applySplitAndMerges);const e=m.mergePoints;this._updateSplitsAndMergesActionsValue(e.value()),this._splitsAndMergesInputsDeps().forEach((e=>{m[e]?.subscribe(this,this._applySplitAndMerges)})),e.subscribe(this,(()=>{const t=e.value()??"[]";"[]"===t?this._removeSplitsAndMergesActionsValue():this._updateSplitsAndMergesActionsValue(t)}))}const g=()=>{this._autoTickPerRowData=null,this._tryCalculateTickPerRow()},_=()=>{const e=this.properties().childs().inputs.childs();"Auto"===e.rowSize.value()&&e.ticksPerRow.setValue(NaN),this._autoTickPerRowData=null,this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.subscribe(this._onSeriesCompletedChanged,{once:!0}),this._histogramIsTooLargeCounter=0};m.rowSize.subscribe(this,g),this.properties().onRestoreFactoryDefaults().subscribe(this,g),p.symbolResolved().subscribe(this,(()=>{const e=p.symbolInfo()?.pro_name??null;this._lastResolvedProName!==e&&(this._lastResolvedProName=e,_())})),p.properties().childs().symbol.subscribe(this,_),p.onIntervalChanged().subscribe(this,_),this._tryCalculateTickPerRow(),this._properties.addExcludedKey("inputs.mergePoints",1)}destroy(){const e=this._model.mainSeries();this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.destroy(),e.symbolResolved().unsubscribeAll(this),e.properties().childs().symbol.unsubscribeAll(this),e.onIntervalChanged().unsubscribeAll(this),this._widgetSideAreaView.destroy(),this._properties.destroy(),super.destroy()}updateAllViews(e){super.updateAllViews(e),this._summaryPaneView.update(),this._widgetSideAreaView.update()}preferredZOrder(){return 0}stateCustomFields(){return{autoTickPerRowData:this._autoTickPerRowData??void 0,splitsAndMerges:this._splitsAndMerges}}restoreStateCustomFields(e){this._autoTickPerRowData=e.autoTickPerRowData??null,this.splitMergeSupported()&&(this._splitsAndMerges=e.splitsAndMerges??{},this._applySplitAndMerges())}resetAllSplitsAndMerges(){const e=this._model.undoModel(),t=new this._resetAllSplitsUndoCommandCtor(this._model,this.id(),{...this._splitsAndMerges});e.undoHistory().pushUndoCommand(t)}setSplitsAndMerges(e){this._splitsAndMerges=e,this._applySplitAndMerges()}splitBlock(e){this._appendMergeSplitAction(e,"split",new n.TranslatedString("TPO split block",s.t(null,void 0,o(955277))))}mergeProfile(e){this._appendMergeSplitAction(e,"merge",new n.TranslatedString("TPO merge block",s.t(null,void 0,o(106174))))}calculateInitialBalancePriceRange(e,t,o){let r=null;const i=o.levels.value(),s=oe.bind(null,i);for(const o of e){const e={start:o.rowIndex*t,end:(o.rowIndex+1)*t};o.blocks.some(s)&&(r=null===r?e:(0,$.mergeTpoPriceRanges)(r,e))}return r}hasStateForAlert(){return!this._chartStyleMode&&super.hasStateForAlert()}paneViews(e){
return this._chartStyleMode?e!==this._model.mainPane()?[this._summaryPaneView]:this._paneViews:super.paneViews(e)}widgetSideAreaViews(e){const t=this._model.mainSeries().priceScale();if(!t)return null;const o=this._model.mainPane();if(!o)return null;const r=o.priceScalePosition(t);return this._chartStyleMode&&e===r?[this._widgetSideAreaView]:null}priceScale(){return this._chartStyleMode?this._model.mainSeries().priceScale():super.priceScale()}dataUpdated(){return this._dataUpdated}_splitsAndMergesActionsKey(){return""}_splitsAndMergesActionsValue(){return this._splitsAndMerges[this._splitsAndMergesActionsKey()]??null}_updateSplitsAndMergesActionsValue(e){this._splitsAndMerges[this._splitsAndMergesActionsKey()]=e}_removeSplitsAndMergesActionsValue(){delete this._splitsAndMerges[this._splitsAndMergesActionsKey()]}_splitsAndMergesInputsDeps(){return[]}_apiInputs(){const{rowSize:e,...t}=super._apiInputs();return t}_allInputsAreValid(){const e=this.properties().childs().inputs.childs().ticksPerRow.value();return!isNaN(e)&&super._allInputsAreValid()}_autoRowSizeModeEnabled(){return"Auto"===this.properties().childs().inputs.childs().rowSize.value()}_tryCalculateTickPerRow(){if(this._autoRowSizeModeEnabled()&&(e=this._autoTickPerRowData,t=this._currentAutoTickPerRowData(),null===e||e.symbol!==t.symbol||e.interval!==t.interval)){this._calculateTickPerRow()?this._autoTickPerRowData=this._currentAutoTickPerRowData():(this._seriesCompleted.unsubscribe(this._onSeriesCompletedChanged),this._seriesCompleted.subscribe(this._onSeriesCompletedChanged,{once:!0}))}var e,t}_calculateTickPerRow(){const e=this._model.mainSeries(),t=e.symbolInfo(),o=e.data().bars();if(!o.size()||!t)return!1;const r=this._model.timeScale().visibleBarsStrictRange();if(null===r)return!1;const s=o.rangeCountback(r.lastBar(),300),l=s.minMaxOnRangeCached((0,i.ensureNotNull)(s.firstIndex()),(0,i.ensureNotNull)(s.lastIndex()),[{name:"low",offset:0},{name:"high",offset:0}]);if(null===l)return!1;const n=t.minmov/t.pricescale,a=(l.max-l.min)/n,d=Math.max(a/80,a/1e3),c=Math.pow(1.4,this._histogramIsTooLargeCounter)*d+5*this._histogramIsTooLargeCounter,h=Math.floor(Math.log10(d)),u=5*Math.max(1,Math.pow(10,h-1)),p=Math.round(c/u)*u,m=Math.min(1e6,Math.max(1,p));return this.properties().childs().inputs.childs().ticksPerRow.setValue(m),ee.logInfo(`Autocalculate TicksPerRow.\n\t\t\tsymbol: ${this._series.symbol()}\n\t\t\tinterval: ${this._series.interval()}\n\t\t\tminTick: ${n}\n\t\t\thigh: ${l.max}\n\t\t\tlow: ${l.min}\n\t\t\thistogramIsTooLargeCounter: ${this._histogramIsTooLargeCounter}\n\t\t\tresult: ${m}`),!0}_currentAutoTickPerRowData(){const e=this._model.mainSeries();return{symbol:e.getSymbolString(),interval:e.interval()}}_onStudyError(e){const t=(0,r.default)(e)?e:e.error;if(this._autoRowSizeModeEnabled()&&t.startsWith("Histogram is too large")){if(++this._histogramIsTooLargeCounter<10)return ee.logInfo("Recalculate ticksPerRow with multiplicator"),void this._calculateTickPerRow();ee.logWarn("Recalculating ticksPerRow limit has been exceeded")}
super._onStudyError(e)}_onStudyCompleted(e){ee.logInfo("Reset histogramIsTooLargeCounter because of complete message"),this._histogramIsTooLargeCounter=0,super._onStudyCompleted(e)}_appendMergeSplitAction(e,t,o){const r=this._properties.childs().inputs.childs().mergePoints.value(),i=""===r||null===r?[]:JSON.parse(r);i.push({action:t,time:e}),this._model.undoModel().setProperty(this._properties.childs().inputs.childs().mergePoints,JSON.stringify(i),o)}_applySplitAndMerges(){const e=this._splitsAndMergesActionsValue()??"[]";this._properties.childs().inputs.childs().mergePoints.setValue(e)}}}}]);