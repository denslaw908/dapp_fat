"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[95334],{895334:(e,t,s)=>{s.d(t,{PineSourceCodeModelBase:()=>ae,bottomWidgetBar:()=>se,updatesInfoSupported:()=>ne});var i=s(650151),r=s(444372),o=s(345848),n=s(735566),a=s(870408),d=s(820028),c=s(886338),u=s(395866),l=s(62802),p=s(850117),h=s(87347),S=s(418450),f=s(751094),_=s(179658),I=s(650279),m=s(925049),y=s(807958),w=s(507733),g=s(422063),v=s(113885),P=s(939478),C=s(479483),M=s(128090),V=s(438009),b=s(250026),N=s(400331),T=s(19674),D=s(316485);const E={asObject:!0,onlyAtomValues:!0,valuesAsIsFromProperties:!0,skipHiddenInputs:!0,doNotSkipHiddenWithMigrate:!0,skipBooleanInputs:!1,skipTextareaInputs:!1,useNameAndGroupAsKey:!0},O=new Map,k=new Set;function F(e,t,s,r,o){const n=e.id(),a=k.has(n);let d=a?(0,i.ensureDefined)(O.get(n)):function(e){const t=e.metaInfo();return{inputsInfoList:t.inputs,inputDefaults:t.defaults.inputs,inputValues:e.inputs(E)}}(e);0===Object.keys(d.inputValues).length&&(d=O.get(n)??d),a||O.set(n,d),o?.length?k.add(n):k.delete(n);const c={zorder:e.zorder(),paneId:s.pane.id()};let u;if(s.priceScale&&s.priceScale===e.priceScale()){u=r.model().insertStudyStub("");const t=(0,i.ensureNotNull)(r.paneForSource(e)),s=r.model().panes().indexOf(t);new b.MergeToTargetPane(r.model(),u,s,null,!0).redo();new N.MoveToExistingPriceScaleUndoCommand(r.model(),u,t,(0,i.ensureNotNull)(e.priceScale()),null).redo()}new v.RemoveSourcesUndoCommand(r.model(),[e],new S.TranslatedString("","")).redo();const l=function(e,t,s,i,r){const o=s.inputValues,n=s.inputDefaults,a=t.defaults.inputs,d={};for(const e of t.inputs){if(e.isHidden&&!e.migrate)continue;const t=(0,V.getStudyInputName)(e)||e.id,i=s.inputsInfoList.find((e=>((0,V.getStudyInputName)(e)||e.id)===t));if(void 0===i||i.isHidden&&!i.migrate)continue;const r=o[t];if(void 0===r)continue;if(i.type!==e.type)continue;if((n&&n[i.id])===(a&&a[e.id])){if((0,C.isStudyInputOptionsInfo)(e)){if(!(0,C.isStudyInputOptionsInfo)(i))continue;if(-1===e.options.indexOf(r))continue}if("integer"===e.type||"float"===e.type||"price"===e.type||"time"===e.type){if(void 0!==e.max&&r>e.max)continue;if(void 0!==e.min&&r<e.min)continue}d[e.id]=r}}const c=new T.InsertStudyCommand({chartModel:e.model(),studyMetaInfo:t,inputs:d,props:{},addAsOverlay:!1,parentSources:[],targetZOrder:i,studyId:r});c.redo();const u=c.insertedStudy();return u.study.then((t=>{D.DeferredStudies.instance(e.model()).add(r,t)})),u}(r,t,d,c,e.id());return l.study.then((e=>{if(e.setZorder(c.zorder),!t.linkedToSeries){const t=r.model().panes().indexOf(s.pane);if(new b.MergeToTargetPane(r.model(),e,t,null,!0).redo(),null!==s.priceScale){new N.MoveToExistingPriceScaleUndoCommand(r.model(),e,s.pane,s.priceScale,null).redo()}else{new N.MoveToNewPriceScaleUndoCommand(r.model(),e,s.pane,"overlay",null).redo()}}e.setErrorCompilation(o?.length?o:null),u&&r.model().removeSource(u)})),l}var A=s(63358),U=s(660439);function x(e,t,s,i){const r=[],o=t.dataSources();for(let t=o.length-1;t>=0;t--){const n=o[t];if(i&&n.id()!==i)continue;if(!(0,
M.isStudy)(n))continue;const a=n.metaInfo();if(!a.pine)continue;if(a.scriptIdPart!==e)continue;!s||a.pine.version!==s.toString()||r.push(n)}return r}const L=new S.TranslatedString("update {title} script",r.t(null,void 0,s(268792)));function $(e,t){if(null===e)return null;const s=t.priceScalePosition(e);return{id:e.id(),position:s,priceScaleIndex:t.priceScaleIndex(e,s)}}const R=new Map,B=/^description$/,W=/^shortDescription$/,j=/^bands\.\d+\.name$/,z=/^filledAreas\.\d+\.title$/,G=/^styles\.plot_\d+\.title$/,q=/^ohlcPlots\.plotbar_\d+\.title$/,H=/^ohlcPlots\.plotcandle_\d+\.title$/;function K(e){return[B,W,j,z,G,q,H].some((t=>t.test(e)))}function Z(e,t){const s=(0,_.default)(t,e);delete s.pine,delete s.defaults?.inputs,delete s.inputs,(0,U.removeEmptyObjectsFromRecordInplace)(s);return(0,U.collectAllPaths)(s).every(K)}class J extends g.UndoCommand{constructor(e,t,s,i){const r=s.state();if(super(L.format({title:r.shortDescription||r.description||""})),this._startUndoPromise=(0,m.createDeferredPromise)(),this._startRedoPromise=(0,m.createDeferredPromise)(),this._updatedStudiesIds=[],this._prevScriptsStates=[],this._newScriptsStates=[],this._childStudesSourcesInputs=new Map,this._chartModel=e,this._compileErrors=i,this._newMetaInfo=s,"scriptIdPart"in t){const e=x(t.scriptIdPart,this._chartModel,t.scriptVersionToUpdate);this._updatedStudiesIds=e.map((e=>e.id()))}else this._updatedStudiesIds=[t.study.id()]}updateScriptsIds(){return this._updatedStudiesIds}async redo(){this._startRedoPromise.resolve(),this._startUndoPromise=(0,m.createDeferredPromise)();const e=this._detachLineTools();try{if(0===this._newScriptsStates.length){if(!await this._replaceSourcesAndSaveStates())return}else{for(const[,e]of this._childStudesSourcesInputs)this._resetChildInputsSourceToDefault(e);if(!await Promise.race([this._restoreStates(this._newScriptsStates),this._startUndoPromise.promise]))return}for(const[,e]of this._childStudesSourcesInputs)for(const{entityId:t}of e){const e=this._chartModel.dataSourceForId(t);e?.start(!0,!1,2)}}finally{this._attachLineTools(e)}}async undo(){this._startUndoPromise.resolve(),this._startRedoPromise=(0,m.createDeferredPromise)();const e=this._detachLineTools();try{if(!await Promise.race([Promise.all(this._restoreStates(this._prevScriptsStates)),this._startRedoPromise.promise]))return;for(const[,e]of this._childStudesSourcesInputs)for(const t of e){const e=this._chartModel.dataSourceForId(t.entityId);if(null!==e)for(const[s,i]of t.inputs)e.properties().childs().inputs.childs()[s].setValue(i)}}finally{this._attachLineTools(e)}}async _replaceSourcesAndSaveStates(){const e=this._updatedStudiesIds.map((e=>this._chartModel.dataSourceForId(e)));this._prevScriptsStates=this._getScriptsStates(e);const t=[];for(let s=e.length-1;s>=0;s--){const r=e[s],o=r.id(),n=(0,i.ensureNotNull)(this._chartModel.paneForSource(r)),a=n.isOverlay(r)?null:r.priceScale(),d=r.metaInfo().state(),c=this._newMetaInfo.state();this._saveChildSourceInputsBeforeRecompilate(o,d,c);const u=this._childStudesSourcesInputs.get(o)
;u&&this._resetChildInputsSourceToDefault(u);const l=F(r,this._newMetaInfo,{pane:n,priceScale:a},this._chartModel.undoModel(),this._compileErrors);if(t.push(l.study),Z(d,c)){const e=r.properties().state();delete e.inputs,l.study.then((t=>{t.properties().mergeAndFire(e)}))}}Promise.all(t).then((e=>{this._newScriptsStates=this._getScriptsStates(e)}));const s=await Promise.race([Promise.all(t),this._startUndoPromise.promise]);return s||null}_restoreStates(e){const t=[];for(const s of e)this._restoreScriptAfterRecompilation(s),t.push(this._chartModel.waitForStudy(s.entityId));return t}_getScriptsStates(e){const t=[],s=this._chartModel.panes().map(((e,t)=>({state:e.state({includeSources:!1}),index:t,id:e.id()})));for(let r=e.length-1;r>=0;r--){const o=e[r],n=(0,i.ensureNotNull)(this._chartModel.paneForSource(o)),a=this._chartModel.panes().indexOf(n),d=$(o.priceScale(),n),c=o.state(!1);t.push({entityId:o.id(),state:c,paneState:s[a],priceScalePositionIds:d})}return t.sort(((e,t)=>e.paneState.index-t.paneState.index)),t}_restoreScriptAfterRecompilation(e){const{entityId:t,paneState:s,state:r,priceScalePositionIds:o}=e;if(null===r||(0,w.isStudyStubDescriptor)(r))return;const n=(0,i.ensureNotNull)(this._chartModel.dataSourceForId(t)),a=(0,i.ensureNotNull)(this._chartModel.paneForSource(n)),d=new v.RemoveSourcesUndoCommand(this._chartModel,[n],new S.TranslatedString("",""));d.redo(),d.removedIds().forEach((e=>this._chartModel.resetWaitForStudy(e)));const c={zorder:n.zorder(),paneId:a.id()};let u;if(null===this._chartModel.paneForId(s.id))this._chartModel.createPane(s.index,void 0,s.id),this._chartModel.paneForId(s.id)?.restoreState({state:{...s.state,sources:[r]},withData:!1,version:this._chartModel.version()}),u=(0,i.ensureNotNull)(this._chartModel.dataSourceForId(t));else{const e=this._chartModel.panes().indexOf((0,i.ensureNotNull)(this._chartModel.paneForId(s.id)));u=(0,i.ensureNotNull)(this._chartModel.restoreSource(!1,e,null,r,o)),u.setZorder(c.zorder)}R.has(t)&&R.set(u.id(),(0,i.ensureDefined)(R.get(t)))}_saveChildSourceInputsBeforeRecompilate(e,t,s){const r=t.plots.filter((e=>y.StudyMetaInfo.canPlotBeSourceOfChildStudy(e.type))),o=s.plots.filter((e=>y.StudyMetaInfo.canPlotBeSourceOfChildStudy(e.type)));if(!(0,I.default)(r,o)){const t=(0,i.ensureNotNull)(this._chartModel.dataSourceForId(e)),s=(0,P.closeSourcesSet)(this._chartModel,[t]);for(const e of r)o.find((t=>t===e))||s.filter(M.isStudy).forEach((e=>{const s=e.inputs(),i=y.StudyMetaInfo.getSourceInputIds(e.metaInfo()),r={entityId:e.id(),inputs:new Map};for(const e of i){const i=s[e];if((0,C.isExtendedInput)(i)&&(0,C.isExtendedInputSource)(i)){const s=(0,C.getInputValue)(i);-1!==s.indexOf(t.id())&&r.inputs.set(e,s)}}if(r.inputs.size){let e=this._childStudesSourcesInputs.get(t.id());e||(e=[],this._childStudesSourcesInputs.set(t.id(),e)),e.push(r)}}))}}_resetChildInputsSourceToDefault(e){for(const t of e){const e=(0,i.ensureNotNull)(this._chartModel.dataSourceForId(t.entityId));e.stop(!1,2);for(const[s]of t.inputs){const t=(0,
i.ensureDefined)(e.metaInfo().defaults.inputs?.[s]);e.properties().childs().inputs.childs()[s].setValue(t)}}}_detachLineTools(){return this._updatedStudiesIds.reduce(((e,t)=>{const s=(0,i.ensureNotNull)(this._chartModel.dataSourceForId(t)),r=(0,i.ensureNotNull)(this._chartModel.paneForSource(s)),o=r.dataSources().filter(A.isLineTool).filter((e=>e.ownerSource()?.id()===s.id()));return e.set(s.id(),o),o.forEach((e=>r.removeDataSource(e))),e}),new Map)}_attachLineTools(e){const t=new Set;e.forEach(((e,s)=>{const r=this._chartModel.dataSourceForId(s);if(null===r)return void t.add(s);const o=(0,i.ensureNotNull)(this._chartModel.paneForSource(r));e.forEach((e=>{e.setOwnerSource(r),o.addDataSource(e,r.priceScale(),!0)}))})),t.forEach((t=>{const s=e.get(t);s&&s.forEach((e=>{e.destroy?.()}))}))}}var Q=s(111332),X=s(816433),Y=s(640263);const ee=new S.TranslatedString("update undicator to latest version",r.t(null,void 0,s(901573))),te=(0,n.getLogger)("Chart.PineSourceCode");function se(){return window.TradingView.bottomWidgetBar}function ie(e=null){return new f.WatchedObject(e,((e,t)=>e===t||!!t&&!!e?.isEqual(t)))}function re(e,t){return`${e}@${t}`}const oe=new Y.FeatureToggleWatchedValue("update_availability_for_std",!1);function ne(e){return y.StudyMetaInfo.hasPubSuffix(e)||oe.value()&&y.StudyMetaInfo.hasStdSuffix(e)}class ae{constructor(e){this._isAbleShowSourceCode=new d.WatchedValue(!1),this._pineSourceEditorStatus=new d.WatchedValue(0),this._destroyed=!1,this._updateAbilityShowSourceCode=async()=>{const e=se();if(void 0===e)return;const t=this._getSourceCodeData("last");if(null===t)return;const{scriptIdPart:s,pineVersion:i}=t;try{const t=await(0,a.isAuthToGetPineSourceCode)(s,i);if(this._destroyed)return;this._isAbleShowSourceCode.setValue(t&&e.isVisible().value())}catch(e){te.logError("Failed isAuthToGetPineSourceCode, reason: "+e)}},this._pineScript=e,se()?.isVisible().subscribe(this._updateAbilityShowSourceCode,{callWithLast:!0});const t=this._getSourceCodeData("last");if(t){const e=re(t.scriptIdPart,t.pineVersion);if(!ae._skippedVersions.has(e)){const t=new p.CircularCacheBuffer;t.restoreState(l.getJSON("pineStudiesUpdates")??[]);const s=t.get(e),i=s?c.Version.parse(s):null;ae._skippedVersions.set(e,ie(i))}this._skippedVersion=(0,i.ensureDefined)(ae._skippedVersions.get(e))}else this._skippedVersion=ie();this._isAbleShowSourceCode.subscribe(this._updatePineSourceEditorStatus.bind(this)),this._initOpenedScripts()}destroy(){se()?.isVisible().unsubscribe(this._updateAbilityShowSourceCode),this._pineSourceEditorStatus.destroy(),this._openedScripts?.destroy(),this._destroyed=!0}isAbleShowSourceCode(){return this._isAbleShowSourceCode.readonly()}script(){return this._pineScript}title(){return this._pineScript.title(X.TitleDisplayTarget.StatusLine)}metaInfo(){return this._pineScript.metaInfo()}scriptIdPart(){const e=this._getSourceCodeData("");return e?.scriptIdPart??null}async showPineSourceCode(e){(0,
i.assert)(this._isAbleShowSourceCode.value(),"Source code not available! (Check ability show source code before - call canShowSourceCode())");const t=se();if(void 0===t)return;const s=this._getSourceCodeData("");if(null===s)return;const{scriptIdPart:r,pineVersion:o}=s,n=(0,i.ensureDefined)(await(0,a.getPineSourceCode)(r,o));if(this._destroyed)return;const d=c.Version.parse(n.version),u=n.lastVersionMaj?c.Version.parse(n.lastVersionMaj):new c.Version(0,0),l={scriptSource:n.source,scriptIdPart:r,scriptName:n.scriptName,scriptTitle:n.scriptTitle,version:n.version,isOld:!u.isZero()&&u.major()!==d.major()};t.activateScriptEditorTab(l,e)}async requestUpdateInformation(){if(!window.is_authenticated)return null;const e=this._getSourceCodeData("");if(!e)return null;try{const{scriptIdPart:t,pineVersion:s}=e;if(!ne(t))return null;const i=await(0,a.getLastVersion)(t);return i?{currentVersion:c.Version.parse(s),lastVersion:c.Version.parse(i.version)}:null}catch{return null}}async requestScriptInfo(){if(!window.is_authenticated)return null;const e=this.scriptIdPart();if(!e)return null;if(!y.StudyMetaInfo.hasPubSuffix(e))return null;if(ae._pinePubScriptInfoCache.has(e))return ae._pinePubScriptInfoCache.get(e)??null;const t=await(0,Q.requestScriptInfo)(e);return ae._pinePubScriptInfoCache.set(e,t),t}skipUpdateTo(e){const t=this._getSourceCodeData("");if(null===t)return;const s=new p.CircularCacheBuffer(100);s.restoreState(l.getJSON("pineStudiesUpdates")??[]);const i=re(t.scriptIdPart,t.pineVersion);s.set(i,e.toString()),l.setJSON("pineStudiesUpdates",s.state()),this._skippedVersion.setValue(e),(0,o.trackEvent)("GUI","Skip study updates")}isUpdateSkipped(e){return!!this._skippedVersion.value()?.isGreaterOrEqual(e)}async updateToVersion(e,t){const s=this._getSourceCodeData("");if(!s)return;(0,o.trackEvent)("GUI","Update study version");const i=await(0,h.studyMetaInfoRepository)().findById({type:"pine",pineId:s.scriptIdPart,pineVersion:t.toString()});if(!this._destroyed){const t=new J(e.model(),{study:this._pineScript},i);t.updateScriptsIds().length>0&&(e.beginUndoMacro(ee),e.undoHistory().pushUndoCommand(t),e.endUndoMacro())}}skippedVersion(){return this._skippedVersion.readonly()}pineSourceEditorStatus(){return this._pineSourceEditorStatus}async _initOpenedScripts(){const e=await Promise.resolve().then(s.bind(s,395866));this._destroyed||(this._openedScripts=e.openedPineScripts.scripts().spawn(),this._openedScripts.subscribe(this._updatePineSourceEditorStatus.bind(this),{callWithLast:!0}))}_updatePineSourceEditorStatus(){const e=this._pineScript.metaInfo();if(!this._isAbleShowSourceCode.value()||null===e||void 0===this._openedScripts)return void this._pineSourceEditorStatus.setValue(0);const t=(0,u.getOpenedScriptInfo)({scriptIdPart:e.scriptIdPart,scriptVersion:e.pine?.version});let s=0;null!==t&&t.inplaceCount>0?s=1:null!==t&&t.detachCount>0&&(s=2),this._pineSourceEditorStatus.setValue(s)}}ae._pinePubScriptInfoCache=new Map,ae._skippedVersions=new Map},438009:(e,t,s)=>{function i(e){const{name:t,group:s}=e
;return t.length>0?`${s?`${s}.`:""}${t}`:void 0}s.d(t,{getStudyInputName:()=>i})},395866:(e,t,s)=>{s.r(t),s.d(t,{getOpenedScriptInfo:()=>n,openedPineScripts:()=>o});var i=s(751094);class r{constructor(){this._state=new i.WatchedObject({})}setScripts(e){let t=this._state.value();e.forEach((e=>{t=this._add(e,t)})),this._state.setValue(t)}addScript(e){const t=this._add(e,this._state.value());this._state.setValue(t)}removeScript(e){const t=this._remove(e,this._state.value());this._state.setValue(t)}replaceScript(e,t){const s=this._add(t,this._remove(e,this._state.value()));this._state.setValue(s)}scripts(){return this._state.readonly()}static getScriptKey(e){return`${e.scriptIdPart}[${e.scriptVersion}]`}_add(e,t){const s=r.getScriptKey(e),i={...t},o=i[s]||{detachCount:0,inplaceCount:0},n=e.isDetach?1:0,a=e.isDetach?0:1,d={detachCount:o.detachCount+n,inplaceCount:o.inplaceCount+a};return i[s]=d,i}_remove(e,t){const s={...t};if(void 0===e.scriptIdPart||void 0===e.scriptVersion)return t;const i=r.getScriptKey(e);if(!t[i])return t;const o=s[i],n=e.isDetach?1:0,a=e.isDetach?0:1,d={detachCount:o.detachCount-n,inplaceCount:o.inplaceCount-a};return d.detachCount<=0&&d.inplaceCount<=0?delete s[i]:s[i]=d,s}}const o=new r,n=e=>{const t=r.getScriptKey(e);return o.scripts().value()[t]??null}}}]);